---
title: "Kenya DHS 2022"
runtime: shiny
output:
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: scroll
resource_files:
- County.cpg
- County.dbf
- County.prj
- County.qpj
- County.sbn
- County.sbx
- County.shx
- shapefiles/County.sbn
- shapefiles/County.qpj
- shapefiles/County.shx
- shapefiles/County.prj
- shapefiles/County.dbf
- shapefiles/County.sbx
- shapefiles/County.cpg
- shapefiles/County.cpg
- shapefiles/County.dbf
- shapefiles/County.prj
- shapefiles/County.qpj
- shapefiles/County.sbn
- shapefiles/County.sbx
- shapefiles/County.shp
- shapefiles/County.shx
- rsconnect/documents/index.Rmd/shinyapps.io/cema/KNBS_DHS2022.dcf
- data/table_17/table_17.1_Experience_pysical_violence.csv
---

```{=html}
<style>
.dataTables_scrollBody {
    max-height: 100% !important;
}
</style>
```


# About

## Column {data-width="400"}

### Report

```{r, fig.width=7.5, fig.height=7.5, fig.align = 'center', fig.cap= "**KNBS and ICF. 2022. Kenya Demographic and Health Survey 2022. Key Indicators Report. Nairobi, Kenya, and Rockville, Maryland, USA: KNBS and ICF.**"}
knitr::include_graphics("www/front_page_knbs.png")
```

[Link to the report](https://www.knbs.or.ke/download/2022-kdhs-key-indicators-report/#)


## <br>

### About

-   The App uses data from the Key Indicators Report of the 2022 Kenya Demographic and Health Survey (2022 KDHS). The survey was implemented by the Kenya National Bureau of Statistics (KNBS) in collaboration with the Kenya's Ministry of Health (MoH) and other stakeholders.

-   It provides easy-to-use interface to explore 2022 KDHS data using tools such as choropleth maps, bar plots, trend plots. This is a living app that is continuously developed to include comparisons of the current results with those from Demographic and Health Surveys.

-   The analytics and visualizations are created by the [Center for Epidemiological Modelling and Analysis (CEMA)](http://cema-africa.uonbi.ac.ke) at the University of Nairobi, Kenya.

```{r, include=FALSE}

#setwd("~/")
# load all the required packages
library(pacman)
p_load(shiny)
p_load(docxtractr)
p_load(flexdashboard)
p_load(tidyverse)
p_load(ggiraph)
p_load(scales)
p_load(sf)
p_load(reshape2)
p_load(cowplot)
p_load(data.table)


```

# Sample survey

## Row {data-width="200"}

<br>

###  {.value-box}

```{r}

valueBox(
  value = paste("37,911"),
  caption = "Total Number of Households Interviewed)",
  icon="fa-thumbs-down",
  color = "black"
)
```

###  {.value-box}

```{r}
# valueBox(
#   value = paste("19,747"),
#   caption = "Full questionnaires",
#   color = "red"
# )
valueBox(
  value = paste("32,156"),
  caption = "Total Number of Women Interviewed",
  icon="fa-thumbs-up",
  color = "#b15928"
)
```

###  {.value-box}

```{r}

# valueBox(
#   value = paste("18,164"),
#   caption = "Short questionnaires",
#   color = "darkgreen"
# )

valueBox(
  value = paste("14,453"),
  caption = "Total Number of Men Interviewed",
  color = "darkgreen",
  icon="fa-thumbs-up"
)
```

<br>

<br>

## Column {data-width="600"}

##### Choose the category to display:

```{r}
selectInput("quest", "",
             c("Households"="All",
               "Participants: Men (15-54 years)"="Male",
               "Participants: Women (15-49 years)"="Female",
               "Response Rates"="Response Rate"))

```

### **Summary of the households selected, occupied, and interviewed for the 2022 Kenya Demographic and Health Survey**

The numbers are presented by:

-   Type of questionnaire (full or short questionnaires)
-   Residence: Rural and urban
-   Participants: Men and women

```{r, fig.height=10,fig.height=22}



totalinterviewvisuals <-fread("data/table_1/table1_kdhshouseholdinterviews1.csv") 


renderPlot({if(input$quest%in%"Response Rate"){
  ggplot(totalinterviewvisuals[totalinterviewvisuals$Participant%in%"Response Rate",], aes(x=Respondents, y=numbers)) + 
  geom_bar(stat = "identity", position = position_dodge(), fill="cyan4") + #"#53A7DC"
  theme_bw() +
  geom_text(aes(label=paste0(round(numbers), "%")), size=5,hjust=1.5, color="white")+scale_y_continuous(label=comma)+
  coord_flip() + labs(x="Households", y="", fill="Residence")+
  facet_grid(residence~selection) +
  theme(text= element_text(size = 20, colour = "black", face = "bold")) +
  theme(strip.background =element_rect(fill="darkorange"))
        
} else
 ggplot(totalinterviewvisuals[totalinterviewvisuals$Gender%in%input$quest & totalinterviewvisuals$Participant!="Response Rate",], aes(x=Respondents, y=numbers)) + 
  geom_bar(stat = "identity", position = position_dodge(), fill="cyan4") + #"#53A7DC"
  theme_bw() +
  geom_text(aes(label=format(numbers, big.mark=",")), size=5,hjust=1.5, color="white")+scale_y_continuous(label=comma)+
  coord_flip() + labs(x="Households", y="", fill="Residence")+
  facet_grid(residence~selection) +
  theme(text= element_text(size = 20, colour = "black", face = "bold")) +
  theme(strip.background =element_rect(fill="darkorange"))
        }, width = 1200, height=600) 


```



<br>

# Household characteristics {data-navmenu="Key Indicators"}

## Row {data-width="400"}

<br>

###  {.value-box}

```{r}

valueBox(
value = paste("26%"),
   caption = "Of women have a form of health insurance",
   color = "#b15928", 
   icon='fa-female,' 
 ) 
```

###  {.value-box}

```{r}
 valueBox( 
   value = paste("26.5%"), 
   caption = "Of men have a form of health insurance", 
   color = "darkgreen", 
   icon='fa-male' 
 )
```

## Column {.tabset .tabset-fade data-height="900"}

### **Housing**

*Health insurance improves access to quality health care by reducing the costs associated with illness, treatment and care incurred by persons and/or families. The graphics show the percentage of de jure household members with insurance and the type of insurance.*

**Choose the characteristics to display:**

```{r}
selectInput("housing", "",
              c("Electricity"="Electricity", 
                "Flooring material"="Flooring material", 
                "Rooms for sleeping"="Rooms for sleeping",
                "Smoking frequency in home"="Smoking frequency in home"))
```

```{r}
housing <- fread("data/table_2/table2_1_Housing_by_xtics.csv")

renderPlot({
    ggplot(housing[housing$Characteristics%in%input$housing,], aes(x=Value, y=Proportion, fill=Category))+geom_bar(stat = 'identity', position = position_dodge())+facet_grid(.~Participants)+#,aes(tooltip=paste0(Coverage, "%"))) +
  labs(y="Percent (%)", x="")+
    scale_fill_brewer(palette = "Set1")+coord_flip()+
    theme_bw()+theme(text=element_text(size=16, face = "bold")) +
    theme(strip.background =element_rect(fill="darkorange"))+
    geom_text(aes(label=paste0(Proportion, "%")), position=position_dodge(0.6),vjust=0.5,hjust=-0.2, size=4, color="black")
 
}, width=1400, height=600)




```

### **Cooking**

**Choose the characteristics to display:**

```{r}
selectInput("cooking", "",
              c("Cooking place"="Cooking place", 
                "Cooking technology"="Cooking technology", 
                "Cooking fuel"="Cooking fuel"))
```

```{r }
cooking <- fread("data/table_2/table2_2_Cooking_by_xtics.csv")


renderPlot({
    ggplot(cooking[cooking$Characteristics%in%input$cooking,], aes(x=Value, y=Proportion, fill=Category))+geom_bar(stat = 'identity', position = position_dodge())+facet_grid(.~Participants)+#,aes(tooltip=paste0(Coverage, "%"))) +
  labs(y="Percent (%)", x="")+
    scale_fill_brewer(palette = "Set1")+coord_flip()+
    theme_bw()+theme(text=element_text(size=16, face = "bold")) +
    theme(strip.background =element_rect(fill="darkorange"))+
    geom_text(aes(label=paste0(Proportion, "%")), position=position_dodge(0.6),vjust=0.5,hjust=-0.2, size=4, color="black")
 
}, width=1600, height=700)




```

### **Household possessions**

**Choose the characteristics to display:**

```{r}
selectInput("possessions", "",
              c("Assets"="Assets", 
                "Household effects"="Household effects", 
                "Means of transportation"="Means of transportation"))
```

```{r}

hh_possession <- fread("data/table_2/table2_5_HH_possession.csv")



renderPlot({
    ggplot(hh_possession[hh_possession$Possessions%in%input$possessions,], aes(x=Value, y=Proportion, fill=Category))+geom_bar(stat = 'identity', position = position_dodge())+
    #,aes(tooltip=paste0(Coverage, "%"))) +
  labs(y="Percent (%)", x="")+
    scale_fill_brewer(palette = "Set1")+coord_flip()+
    theme_bw()+theme(text=element_text(size=16, face = "bold")) +
    theme(strip.background =element_rect(fill="darkorange"))+
    geom_text(aes(label=paste0(Proportion, "%")), position=position_dodge(0.6),vjust=0.5,hjust=-0.2, size=4, color="black")
 
}, width=1600, height=700)




```

### **Birth registration**

Birth registration of children \<5 years

**Choose the characteristics to display:**

```{r}
selectInput("birth_reg", "",
              c("Age"="Age", 
                "Residence"="Residence", 
                "Sex"="Sex",
                "Wealth quintile"="Wealth quintile",
                "County"="County"))
```

```{r, include=F}
birth_reg_county <- fread("data/table_2/table2_10C_Birth_registration_by_county.csv")

county <- st_read("shapefiles/County.shp")

birth_reg_county1 <- full_join(county, birth_reg_county, by=c("Name"="County"))



```

```{r}

birth_reg <- fread("data/table_2/table2_10_Birth_registration_by_background_xtics.csv")

birth_reg$Value<- fct_relevel(birth_reg$Value, 
                                   "Lowest", "Second", "Middle", "Fourth", "Highest")


renderGirafe({
  if(input$birth_reg!="County"){
    birth_reg1 <- ggplot(birth_reg[birth_reg$`Background characteristics`%in%input$birth_reg,], aes(x=Value, y=Proportion, fill=Category))+geom_bar(stat = 'identity', position = position_dodge())+
    #,aes(tooltip=paste0(Coverage, "%"))) +
  labs(y="Percent (%)", x="")+
    scale_fill_brewer(palette = "Set1")+coord_flip()+
    theme_bw()+theme(text=element_text(size=18, face = "bold")) +
    theme(strip.background =element_rect(fill="darkorange"))+
    geom_text(aes(label=paste0(Proportion, "%")), position=position_dodge(0.6),vjust=0.5,hjust=-0.2, size=4, color="black")
  birth_reg1a<-girafe(ggobj = birth_reg1,
                   options = list(
                    # opts_sizing(rescale = TRUE),
                     opts_zoom(max = 6)),width=12, height=9)
  print(birth_reg1a)}
  else{
    birth_reg_map <- ggplot(birth_reg_county1)+
  geom_sf_interactive(data=birth_reg_county1, aes(geometry=geometry, tooltip=paste0(Proportion, "%")), fill=NA)+
  theme_void()+
  facet_wrap(~Category)+
  scale_fill_gradient(low = "white", high = "#8c2d04")+
  labs(x="", y="",fill="Proportion (%)")+
  theme(text=element_text(size=18))
    birth_reg_map1a<-girafe(ggobj = birth_reg_map,
                   options = list(
                    # opts_sizing(rescale = TRUE),
                     opts_zoom(max = 6)),width=12, height=9)
  print(birth_reg_map1a, justify="left")}
 
})




```

### **School attendance**

**Choose the characteristics to display:**

```{r}
selectInput("school_attendance", "",
              c("Residence"="Residence", 
                "Wealth quintile"="Wealth quintile",
                "County"="County"))
```

```{r, include=F}
school_att_county <- fread("data/table_2/table_2_12C_School_attendance_by_county.csv") %>%
  filter(!(Category%in%"Gender Parity Index"))

county <- st_read("shapefiles/County.shp")
school_att_county1 <- full_join(county, school_att_county, by=c("Name"="County"))


```

```{r}

school_attendance <- fread("data/table_2/table_2_12_School_attendance_by_background_xtics.csv") 

school_attendance$Value<- fct_relevel(school_attendance$Value, 
                                   "Lowest", "Second", "Middle", "Fourth", "Highest")

renderGirafe({
  if(input$school_attendance!="County"){
    school_att1 <- ggplot(school_attendance[school_attendance$`Background characteristics`%in%input$school_attendance,], aes(x=Value, y=Proportion, fill=Category))+geom_bar(stat = 'identity', position = position_dodge())+
      facet_grid(.~`Schooling level`)+
    #,aes(tooltip=paste0(Coverage, "%"))) +
  labs(y="Percent (%)", x="")+
    scale_fill_brewer(palette = "Set1")+coord_flip()+
    theme_bw()+theme(text=element_text(size=16, face = "bold")) +
    theme(strip.background =element_rect(fill="darkorange"))+
    geom_text(aes(label=paste0(Proportion, "%")), position=position_dodge(0.6),vjust=0.5,hjust=-0.2, size=4, color="black")
  school_att1a<-girafe(ggobj = school_att1,width_svg=10, height_svg=8,
                   options = list(
                    # opts_sizing(rescale = TRUE),
                     opts_zoom(max = 9)))
  print(school_att1a)}
  else{
    school_att_map <- ggplot(school_att_county1)+
  geom_sf_interactive(data=school_att_county1, aes(geometry=geometry, tooltip=paste0(Proportion, "%")), fill=NA)+
  geom_sf(aes(fill=Proportion),color="grey80", size=0.0)+
  theme_void()+
  facet_wrap(~Category)+
  scale_fill_gradient(low = "white", high = "#8c2d04")+
  labs(x="", y="",fill="Proportion (%)")+
  theme(text=element_text(size=14))
    school_att_map1a<-girafe(ggobj = school_att_map,width_svg=10, height_svg=8,
                   options = list(
                    # opts_sizing(rescale = TRUE),
                     opts_zoom(max = 4)))
  print(school_att_map1a, justify="left")}
 
})




```

### **Road Traffic Accidents**

Deaths and injuries from road traffic accidents

**Choose the characteristics to display:**

```{r}
selectInput("rta", "",
              c("Residence"="Residence", 
                "Wealth quintile"="Wealth quintile",
                "County"="County"
               ))
```

```{r, include=F}
RTA <- fread("data/table_2/table_2_17_RTA_by_background_xtics.csv")

RTA$Value<- fct_relevel(RTA$Value, 
                                   "Lowest", "Second", "Middle", "Fourth", "Highest")
RTA_county <- fread("data/table_2/table_2_17_RTA_by_county.csv") %>%
  mutate(Proportion=as.numeric(Proportion))

RTA_county1 <- full_join(county, RTA_county, by=c("Name"="County")) 
```

```{r}

renderPlot({
  if(input$rta%in%"Residence"){
    ggplot(RTA[RTA$`Background characteristics`%in%input$rta,], aes(x=Value, y=Proportion, fill=Category))+geom_bar(stat = 'identity', position = position_dodge())+
    #,aes(tooltip=paste0(Coverage, "%"))) +
  labs(y="Rate per 100,000", x="")+
    scale_fill_brewer(palette = "Set1")+coord_flip()+
    theme_bw()+theme(text=element_text(size=16, face = "bold")) +
    theme(strip.background =element_rect(fill="darkorange"))+
    geom_text(aes(label=paste0(Proportion, "%")), position=position_dodge(0.6),vjust=0.5,hjust=-0.2, size=4, color="black")}
  else if(input$rta%in%"Wealth quintile"){
  ggplot(RTA[RTA$`Background characteristics`%in%input$rta,], aes(x=Value, y=Proportion, fill=Category))+geom_dotplot(binaxis='y', stackdir='center', binwidth = 60)+
    #,aes(tooltip=paste0(Coverage, "%"))) +
  labs(y="Rate per 100,000", x="")+
    scale_fill_brewer(palette = "Set1")+
    theme_bw()+theme(text=element_text(size=16, face = "bold")) +
    theme(strip.background =element_rect(fill="darkorange"))+
    geom_text(aes(label=paste0(Proportion, "%")),vjust=0.5,hjust=-0.2, size=4, color="black")  
  }
  else{
  ggplot(RTA_county1)+
  geom_sf(data=RTA_county1, aes(geometry=geometry, fill=Proportion))+
  theme_void()+
  facet_wrap(~Category)+
  scale_fill_gradient(low = "white", high = "#8c2d04")+
  labs(x="", y="",fill="Rate per 100,000")+
  theme(text=element_text(size=14))}
 
}, width=1600, height=700)

```

### **COVID-19 diagnosis and vaccination**

**Choose the characteristics to display:**

```{r}
selectInput("covid", "",
              c("Residence"="Residence", 
                "Wealth quintile"="Wealth quintile",
                "County"="County"
               ))
```

```{r, include=F}
covid_county <- fread("data/table_2/table_2_19_1C_covid_by_county.csv")

covid_county1 <- full_join(county, covid_county%>%filter(Participants%in%"Households")%>%distinct(), by=c("Name"="County")) %>%
  mutate(Participants="Households")
covid_county2 <- full_join(county, covid_county%>%filter(Participants%in%"Population"), by=c("Name"="County")) %>%
  mutate(Participants="Population")

covid_county3 <- rbind(covid_county1, covid_county2)

```

```{r}

covid <- fread("data/table_2/table_2_19_1_covid_by_background_xtics.csv")

covid$Value<- fct_relevel(covid$Value, 
                                   "Lowest", "Second", "Middle", "Fourth", "Highest")
renderPlot({if(input$covid%in%"Residence"){
    ggplot(covid[covid$`Background characteristics`%in%input$covid,], aes(x=Value, y=Proportion, fill=Category))+geom_bar(stat = 'identity', position = position_dodge())+facet_grid(.~Participants)+
    #,aes(tooltip=paste0(Coverage, "%"))) +
  labs(y="Percent (%)", x="")+
    scale_fill_brewer(palette = "Set1")+coord_flip()+
    theme_bw()+theme(text=element_text(size=16, face = "bold")) +
    theme(strip.background =element_rect(fill="darkorange"))+
    geom_text(aes(label=paste0(Proportion, "%")), position=position_dodge(0.6),vjust=0.5,hjust=-0.2, size=4, color="black")}
  else if(input$covid%in%"Wealth quintile"){
    ggplot(covid[covid$`Background characteristics`%in%input$covid,], aes(x=Value, y=Proportion, fill=Category))+geom_dotplot(binaxis='y', stackdir='center', binwidth = 3)+facet_grid(.~Participants)+
    #,aes(tooltip=paste0(Coverage, "%"))) +
  labs(y="Percent (%)", x="")+
    scale_fill_brewer(palette = "Set1")+
    theme_bw()+theme(text=element_text(size=16, face = "bold")) +
    theme(strip.background =element_rect(fill="darkorange"))+
    geom_text(aes(label=paste0(Proportion, "%")),  size=4, color="black")
  }else{
    ggplot(covid_county3)+
  geom_sf(data=covid_county3, aes(geometry=geometry), fill=NA)+
  geom_sf_interactive(aes(fill=Proportion, tooltip=Names),color="grey80", size=0.0)+
  theme_void()+
  facet_wrap(Participants~Category)+
  scale_fill_gradient(low = "white", high = "#8c2d04")+
  labs(x="", y="",fill="Proportion (%)")+
  theme(text=element_text(size=14))
  }
  
 
}, width=1600, height=700)


```



### **Health Insurance Coverage**

*Health insurance improves access to quality health care by reducing the costs associated with illness, treatment and care incurred by persons and/or families. The graphics show the percentage of de jure household members with insurance and the type of insurance.*

**Choose the characteristics to display:**

```{r}
selectInput("health", "",
              c("Age in Years"="Age", 
                "Residence"="Residence", 
                "Wealth quintile"="Wealth quintile"))
```

```{r, include=F}

insurance_county <- fread("data/table_2/table_2_20C_insurance_by_county.csv")

insurance_county1 <- full_join(county, insurance_county, by=c("Name"="County"))

```



```{r, fig.width=16 }
# health insurance data by age
insurance <- fread("data/table_2/table_2_20_insurance_by_background_xtics.csv")

insurance$Value<- fct_relevel(insurance$Value, 
                                   "Lowest", "Second", "Middle", "Fourth", "Highest")

renderPlot({
  if(input$health%in%c("Wealth quintile", "Age", "Residence")){
    ggplot(insurance[insurance$`Background characteristics`%in%input$health,], aes(x=`Health Insurance Type`, y=Proportion, fill=Value))+geom_bar(stat = 'identity', position = position_dodge())+#,aes(tooltip=paste0(Coverage, "%"))) +
  labs(y="Percent (%)", x="")+
   coord_flip()+
    theme_bw()+theme(text=element_text(size=16, face = "bold")) +
      scale_fill_brewer(palette = "Set1")+
   # theme(strip.background =element_rect(fill="darkorange"))+
    geom_text(aes(label=paste0(Proportion,"%")), position=position_dodge(0.5),vjust=0.5,hjust=0.2, size=4, color="black")}
  #  insurance_map1a<-girafe(ggobj = insurance_map1,width_svg=18, height_svg=9,
  #                 options = list(
  #                   opts_hover(css = "fill:#666666;cursor:pointer;"),
  #                   opts_selection(css = "fill:orange;", type = "multiple"),
                    # opts_sizing(rescale = TRUE),
   #                  opts_zoom(max = 4)))
  #print(insurance_map1a)
  else
    { 
  ggplot(insurance_county1)+
  geom_sf(data=insurance_county1, aes(geometry=geometry), fill=NA)+
  geom_sf(aes(fill=Proportion),color="grey80", size=0.0)+
  theme_void()+
  facet_wrap(~`Health Insurance Type`)+
  scale_fill_gradient(low = "white", high = "#8c2d04")+
  labs(x="", y="",fill="Proportion (%)")+
  theme(text=element_text(size=14))
  #insurance_map2a<-girafe(ggobj = insurance_map2, width_svg=18, height_svg=9,
   #                options = list(
    #                 opts_hover(css = "fill:#666666;cursor:pointer;"),
     #                opts_selection(css = "fill:orange;", type = "multiple"),
                  #   opts_sizing(rescale=TRUE),
      #               opts_zoom(max = 4)))
 # print(insurance_map2a, justify="left")
  }
}, width=1600, height=700)



```

### **Cash transfer or social assistance**

**Choose the provider to display:**

```{r}
selectInput("cash_transfer", "",
              c( 
                "County government"="County government", 
                "National government"="National government",
                "Religious organizations"="Religious organization",
                "Charitable organization"="Charitable organization",
                "Friends, relatives, or neighbours"="Friends, relatives, or neighbours",
                "By County"="County"))
```

```{r, include=F}

cash_transfer_county <- fread("data/table_2/table_2_22_2C_cash_transfer_by_county.csv")

cash_transfer_county1 <- full_join(county, cash_transfer_county, by=c("Name"="County"))

```

```{r}
cash_transfer <- fread("data/table_2/table_2_22_1_cash_transfer_by_provider.csv")

renderPlot({if(input$cash_transfer!="County"){
  ggplot(cash_transfer[cash_transfer$Provider1%in%input$cash_transfer,], aes(x=reorder(`Reason For Assistance`,Proportion), y=Proportion))+
  geom_bar(stat = "identity", fill="#74add1")+
  theme_bw()+
  labs( y="Proportion (%)", title="", x="Reason for assistance", fill="")+
  theme(text=element_text(size=16))+
  geom_text(aes(label = lab), nudge_y = 2.0)+
  coord_flip()}
  else{
   ggplot(cash_transfer_county1)+
  geom_sf(data=cash_transfer_county1, aes(geometry=geometry), fill=NA)+
  geom_sf(aes(fill=Proportion),color="grey80", size=0.0)+
  theme_void()+
  facet_wrap(~`Reason For Assistance`)+
  scale_fill_gradient(low = "white", high = "#8c2d04")+
  labs(x="", y="",fill="Proportion (%)")+
  theme(text=element_text(size=16)) 
  }
}, width=1600, height=600)
```


# Respondent characteristics {data-navmenu="Key Indicators"}



## Row {data-width="200"}

<br>

###  {.value-box}

```{r}

valueBox(
  value = paste("32,156"),
  caption = "Number of women interviewed",
  color = "#b15928",
  icon='fa-female,'
)
```

###  {.value-box}

```{r}
valueBox(
  value = paste("14,453"),
  caption = "Number of men interviewed",
  color = "darkgreen",
  icon='fa-male'
)
```

<br>

## Column {.tabset .tabset-fade data-height="900"}

### **Background characteristics**

*For each characteristic, we show the weighted percentage distributions of the women and men that participated in the survey. Choose the characteristic to display.*

```{r}

selectInput("char", "",
             c("Age of respondent"="Age",
               "Self-reported health status"="Health_Status",
               "Religion"="Religion",
               "Marital status (15-49years)"="Marital_Status",
               "Residence"="Residence",
               "Education status (highest level attended)"="Education_Status",
               "Wealth Quintile"="Wealth_Quintile",
               "By County"="County",
               "By County: Men" = "Men",
               "By County: Women"= "Women"))

```

```{r, include=F}

respondentsdata <- fread("data/table_2/table2_respondentsdata.csv")


respondentsdata$Grouping<- fct_relevel(respondentsdata$Grouping, 
                                   "Lowest", "Second", "Middle", "Fourth", "Highest")
## county data

### men
men_background_xtics_county <- fread("data/table_2/table2C_men_backgroundxtics_by_county.csv") %>%
  mutate(group="Men")

county <- st_read("shapefiles/County.shp")%>%
  mutate(region=ifelse(Name%in%c("Kilifi","Kwale","Lamu", "Mombasa", "Taita Taveta", "Tana River"),"Coast", ifelse(Name%in%c("Garissa", "Mandera", "Wajir"),"North Eastern", ifelse(Name%in%c("Marsabit","Isiolo","Meru","Tharaka Nithi","Embu","Kitui","Machakos","Makueni"),"Eastern", ifelse(Name%in%c("Kiambu", "Kirinyaga","Muranga","Nyandarua", "Nyeri"),"Central", ifelse(Name%in%c("Bungoma",
 "Busia","Kakamega","Vihiga"),"Western", ifelse(Name%in%c("Kisumu", "Siaya","Homa Bay","Kisii", "Migori","Nyamira"),"Nyanza", ifelse(Name%in%"Nairobi","Nairobi", "Rift Valley"))))))))%>%
  rename(County=Name)

men_background_xtics_county1 <- full_join(county, men_background_xtics_county, by="County")%>%
  mutate(names=paste0(County,", ", weighted_perc,"%"))

### women
women_background_xtics_county <- fread("data/table_2/table2C_women_backgroundxtics_by_county.csv") %>%
  mutate(group="Women")

women_background_xtics_county1 <- full_join(county, women_background_xtics_county, by="County")%>%
  mutate(names=paste0(County,", ", weighted_perc,"%"))

background_characteristics_map <- rbind(women_background_xtics_county1, men_background_xtics_county1)
```

```{r}

renderGirafe({
  if (input$char%in%c("Wealth_Quintile", "Age")){
  respondents_map1 <- respondentsdata%>%
    filter(Indicator==input$char)%>%
    ggplot(aes(x=Grouping, y=Weighted_percent)) + 
  geom_point(stat = "identity", size= 20, color = "cyan4")+#, aes(tooltip=paste0(Weighted_percent, "%"))) + 
  theme_bw() +
      facet_grid(~Participants) +
  geom_text(aes(label=label), hjust = 0.7, size=4, color="black", face = "bold")+
  #labs(y="Percent (%)",x=paste0(unique(respondentsdata[respondentsdata$Indicator==input$char,]$Indicator1), " of respondents"), fill="Gender") +
      labs(y="Percent (%)", x="")  +
     # scale_color_manual(values=c("cyan4", "red4"))+
       theme(strip.background =element_rect(fill="darkorange")) +
  theme(text=element_text(size=20, face="bold"))
   respondents_map1a<-girafe(ggobj = respondents_map1,
                   options = list(
                     opts_hover(css = "fill:#666666;cursor:pointer;"),
                     opts_selection(css = "fill:orange;", type = "multiple"),
                     #opts_sizing(width = .7),
                     opts_zoom(max = 4)), width=18, height=10)
  print(respondents_map1a)
    } else if(input$char%in%"County"){
 respondents_map2 <-respondentsdata%>%
    filter(Indicator==input$char)%>%
      ggplot(aes(x=reorder(Grouping,Weighted_percent), y=Weighted_percent)) + 
  geom_bar(stat = "identity", size= 10, fill = "cyan4") + coord_flip()+
  theme_bw() +
        facet_grid(~Participants) +
  geom_text(aes(label=label), hjust = -0.1, size=4, color="black", face = "bold", label.size=0.7)+
#  labs(y="Weighted percent (%)",x=paste0(unique(respondentsdata[respondentsdata$Indicator==input$char,]$Indicator1), " of respondents"), fill="Gender") + 
         labs(y="Percent (%)", x="") + 
      #  scale_fill_manual(values=c("cyan4", "red4"))+
  theme(text=element_text(size=20, face="bold")) + theme(strip.background =element_rect(fill="darkorange"))
 respondents_map2a<-girafe(ggobj = respondents_map2,
                   options = list(
                     opts_hover(css = "fill:#666666;cursor:pointer;"),
                     opts_selection(css = "fill:orange;", type = "multiple"),
                     opts_sizing(width = .7),
                     opts_zoom(max = 4)), width=18, height=10)
  print(respondents_map2a)

  }  else if(input$char%in%c("Religion", "Marital_Status")){
  respondents_map3 <- respondentsdata%>%
    filter(Indicator==input$char)%>%
      ggplot(aes(x=reorder(Grouping,Weighted_percent), y=Weighted_percent)) + 
  geom_bar(stat = "identity", size= 10, fill = "cyan4") + coord_flip()+
  theme_bw() +
        facet_grid(~Participants) +
  #labs(y="Percentage (%)",x=paste0(unique(respondentsdata[respondentsdata$Indicator==input$char,]$Indicator1), " of respondents"), fill="Gender") + 
         labs(y="Percent (%)", x="") + 
        scale_fill_manual(values=c("cyan4", "red4"))+
  theme(text=element_text(size=18, face="bold")) + theme(strip.background =element_rect(fill="darkorange"))+
      geom_text(aes(label=label), position=position_stack(vjust = 0.7), size=4, color="white", face = "bold", label.size=0.7)
   respondents_map3a<-girafe(ggobj = respondents_map3,
                   options = list(
                     opts_hover(css = "fill:#666666;cursor:pointer;"),
                     opts_selection(css = "fill:orange;", type = "multiple"),
                     opts_sizing(width = .7),
                     opts_zoom(max = 4)), width=18, height=10)
  print(respondents_map3a)
  } 
  else if (input$char%in%c("Men", "Women")){
    background_xtics <- ggplot(background_characteristics_map[background_characteristics_map$group%in%input$char,], aes(fill=weighted_perc))+ geom_sf_interactive(aes(tooltip=names),color="grey80", size=0.0)+
  theme_void()+
  scale_fill_gradient(low = "#fee6ce", high = "#7f2704")+
  labs(x="", y="",fill="Percentage")+
  theme(text=element_text(size=14))
   background_map <- girafe(ggobj = background_xtics,
                   options = list(
                     opts_hover(css = "fill:#666666;cursor:pointer;"),
                     opts_selection(css = "fill:orange;", type = "multiple"),
                     opts_sizing(width = .7),
                     opts_zoom(max = 4)), width=18, height=10)
    print(background_map)
  }
  else{
  respondents_map4 <- respondentsdata%>%
    filter(Indicator==input$char)%>%
    ggplot(aes(x=Grouping, y=Weighted_percent)) + 
  geom_bar(stat = "identity", size= 10, fill = "cyan4")+ #aes(tooltip=paste0(Weighted_percent, "%"))) + 
  theme_bw() +
        facet_grid(~Participants) +
  geom_text(aes(label=label), position=position_stack(vjust = 0.5), size=5, color="white")+
 # labs(y="Weighted percent (%)",x=paste0(unique(respondentsdata[respondentsdata$Indicator==input$char,]$Indicator1), " of respondents"), fill="Gender") +scale_fill_manual(values=c("cyan4", "red4"))+
         labs(y="Percent (%)", x="") +
  theme(text=element_text(size=18, face="bold")) +  theme(strip.background =element_rect(fill="darkorange")) 
    respondents_map4a<-girafe(ggobj = respondents_map4,
                   options = list(
                     opts_hover(css = "fill:#666666;cursor:pointer;"),
                     opts_selection(css = "fill:orange;", type = "multiple"),
                     opts_zoom(max = 4)), width=18, height=10)
  print(respondents_map4a)
  }  
  })
  
```

### **Occupation**

```{r}
selectInput("occupation", "",
              c("Age in Years"="Age",
                "Highest Education"="Education",
                "Marital Status"="Marital Status",
                "Residence"="Residence", 
                "Wealth quintile"="Wealth Quintile",
                "Number of living children"="No. of living children",
                "County"="County"))
```

```{r, include=F}
occupation_county <- fread("data/table_3/table3_7C_occupation_by_county.csv")

county <- st_read("shapefiles/County.shp")
occupation_county1 <- full_join(county, occupation_county%>%filter(Participants%in%"Women"), by=c("Name"="County")) %>%
  mutate(Participants="Women")
occupation_county2 <- full_join(county, occupation_county%>%filter(Participants%in%"Men"), by=c("Name"="County")) %>%
  mutate(Participants="Men")
occupation_county3 <- rbind(occupation_county1, occupation_county2)
```

```{r}

occupation <- fread("data/table_3/table3_7_occupation_by_background_xtics.csv") 

occupation$Value<- fct_relevel(occupation$Value, 
                                   "Lowest", "Second", "Middle", "Fourth", "Highest")

renderPlot({if(input$occupation!="County"){
  ggplot(occupation[occupation$`Background characteristics`%in%input$occupation,],aes(x=Value, y=Proportion, fill=Category))+
  geom_bar(position="dodge", stat="identity")+
  theme_bw()+
  facet_wrap(~Participants)+
  labs( y="Proportion (%)", title="", x="Occupation", fill="Age")+
  scale_fill_brewer(palette = "Set1")+
    geom_text(aes(label=paste0(Proportion,"%")), position=position_dodge(0.5),  hjust=-0.5, vjust=-0.5)+
  theme(text=element_text(size=16))+
  coord_flip()}
  else{
    ggplot(occupation_county3)+
  geom_sf(data=occupation_county3, aes(geometry=geometry), fill=NA)+
  geom_sf(aes(fill=Proportion),color="grey80", size=0.0)+
  theme_void()+
  facet_wrap(Participants~`Category`, nrow=3)+
  scale_fill_gradient(low = "white", high = "#8c2d04")+
  labs(x="", y="",fill="Proportion (%)")+
  theme(text=element_text(size=14))
  }
},width=1500, height=600)
```

### **Type of employment**

**Choose characteristics to display**

```{r}
selectInput("employment", "",
              c("Continuity of Employment"="Continuity of Employment",
                "Type of Earnings"="Type of Earnings",
                "Type of Employer"="Type of Employer"))
```

```{r}

employment <-fread("data/table_3/table3_8_employment_by_background_xtics.csv") 


renderPlot({
  ggplot(employment[employment$`Employment characteristics`%in%input$employment,],aes(x=reorder(`Value`,Proportion), y=Proportion, fill=`Category`))+
  geom_bar(position="dodge", stat="identity")+
  theme_bw()+
  labs( y="Proportion (%)", title="", x="Type of Earnings", fill="Type of Employment")+
  geom_text(aes(label=paste0(Proportion,"%")), position=position_dodge(0.7),  hjust=-0.5, vjust=-0.5)+
  scale_fill_manual(values = c("#f46d43","#74add1"))+
  theme(text=element_text(size=16))+
  coord_flip()
},width=1500, height=700)
```

### **Reason for migration**

**Choose the characteristics to display**

```{r}
selectInput("migration", "",
              c("Age in Years"="Age", 
                "Residence"="Residence", 
                "Wealth quintile"="Wealth quintile",
                "Timing of move"="Timing of move",
                "Type of migration"="Type of migration"))
```

```{r, include=F}
migration_county <- fread("data/table_3/table_3_17C_migration_by_county.csv")

county <- st_read("shapefiles/County.shp")

migration_county1 <- full_join(county, migration_county%>%filter(Participants%in%"Men"), by=c("Name"="County"))%>%
  mutate(Participants="Men")
migration_county2 <- full_join(county, migration_county%>%filter(Participants%in%"Women"), by=c("Name"="County"))%>%
  mutate(Participants="Women")
migration_county3 <-rbind(migration_county1, migration_county2)

```


```{r}
migration <- fread("data/table_3/table_3_17_migration_by_background_xtics.csv")

migration$Value<- fct_relevel(migration$Value, 
                                    "Lowest", "Second", "Middle", "Fourth", "Highest")

renderPlot({if(input$migration!="County"){
  ggplot(migration[migration$`Background characteristics`%in%input$migration,],aes(x=Value, y=Proportion, fill=`Reason For Migration`))+
  geom_bar(position="dodge", stat="identity")+
  theme_bw()+
  facet_wrap(~Participants)+coord_flip()+
  labs( y="Proportion (%)", title="", x="Reason for migration", fill="Age")+
  scale_fill_brewer(palette = "Set1")+
  #scale_fill_manual(values = c("#f46d43","#74add1"))+
  geom_text(aes(label=paste0(Proportion,"%")), position=position_dodge(0.7),  hjust=-0.5, vjust=-0.5)+  
  theme(text=element_text(size=14))+
  coord_flip()}
  else{
    ggplot(migration_county3)+
  geom_sf(data=migration_county3, aes(geometry=geometry), fill=NA)+
  geom_sf(aes(fill=Proportion),color="grey80", size=0.0)+
  theme_void()+
  facet_grid(Participants~`Reason For Migration`)+
  scale_fill_gradient(low = "white", high = "#8c2d04")+
  labs(x="", y="",fill="Proportion (%)")+
  theme(text=element_text(size=14))
  }
},width=1500, height=600)
```

# Water, Sanitation and Hygiene {data-navmenu="Key Indicators"}


## Row {data-width="200"}

<br>

###  {.value-box}

```{r}

valueBox(
  value = paste("65.5%"),
  caption = "of water is collected by adult females",
  color = "#b15928",
  icon='fa-female,'
)
```

###  {.value-box}

```{r}
valueBox(
  value = paste("63%"),
  caption = "of the population does not treat drinking water",
  color = "darkgreen",
  icon='fa-male'
)
```

<br>

## Column {.tabset .tabset-fade data-height="900"}

### **Person collecting drinking water**

```{r}

water_collector <- fread("data/table_16/table_16_3_water_collection_by_background_xtics.csv")

water_collector$Value<- fct_relevel(water_collector$Value, 
                                    "Lowest", "Second", "Middle", "Fourth", "Highest")

water_collector_county <- fread("data/table_16/table_16_3C_water_collection_by_county.csv")

water_collector_county1 <- full_join(county, water_collector_county, by=c("Name"="County"))

selectInput("collector", "",
             c("Residence"= "Residence",
             "Water source"="Water source",
             "Wealth quintile"="Wealth quintile",
             "By County"="County"
             ))

renderPlot({if(input$collector!="County"){
  ggplot(water_collector[water_collector$`Background characteristics`%in%input$collector,],aes(x=Value, y=Proportion, fill=Category))+
  geom_bar(position="dodge", stat="identity")+
  theme_bw()+coord_flip()+
  labs( y="Percent (%)", title="", x="", fill="Age")+
  scale_fill_brewer(palette = "Set1")+
  #scale_fill_manual(values = c("#f46d43","#74add1"))+
  geom_text(aes(label=paste0(Proportion,"%")), position=position_dodge(0.7),  hjust=-0.5, vjust=-0.5)+  
  theme(text=element_text(size=16, face = "bold"))+
  coord_flip()}
  else{
    ggplot(water_collector_county1)+
  geom_sf(data=water_collector_county1, fill=NA)+
  geom_sf(aes(fill=Proportion),color="grey80", size=0.0)+
  theme_void()+
  facet_grid(~Category, nrow=2)+
  scale_fill_gradient(low = "white", high = "#8c2d04")+
  labs(x="", y="",fill="Proportion (%)")+
  theme(text=element_text(size=14, face = "bold"))
  }
},width=1600, height=700)
```

### **Treatment of household drinking water**

```{r}

water_treat <- fread("data/table_16/table_16_5_water_treatment_by_background_xtics.csv")

water_treat$Value <- fct_relevel(water_treat$Value, 
                                    "Lowest", "Second", "Middle", "Fourth", "Highest")

water_treat_county <- fread("data/table_16/table_16_5C_water_treatment_by_county.csv")

water_treat_county1 <- full_join(county, water_treat_county, by=c("Name"="County"))

selectInput("water_treat", "",
             c("Residence"= "Residence",
             "Water source"="Water source",
             "Wealth quintile"="Wealth quintile",
             "By County"="County"
             ))

renderPlot({if(input$water_treat!="County"){
  ggplot(water_treat[water_treat$`Background characteristics`%in%input$water_treat,],aes(x=reorder(Category,Proportion), y=Proportion, fill=Value))+
  geom_bar(position="dodge", stat="identity")+
  theme_bw()+coord_flip()+
  labs( y="Proportion (%)", title="", x="Reason for migration", fill="")+
  scale_fill_brewer(palette = "Set1")+
  #scale_fill_manual(values = c("#f46d43","#74add1"))+
  geom_text(aes(label=paste0(Proportion,"%")), position=position_dodge(0.7),  hjust=-0.5, vjust=-0.5)+  
  theme(text=element_text(size=16, face = "bold"))+
  coord_flip()}
  else{
    ggplot(water_treat_county1)+
  geom_sf(data=water_treat_county1, fill=NA)+
  geom_sf(aes(fill=Proportion),color="grey80", size=0.0)+
  theme_void()+
  facet_grid(~Category, nrow=2)+
  scale_fill_gradient(low = "white", high = "#8c2d04")+
  labs(x="", y="",fill="Proportion (%)")+
  theme(text=element_text(size=14, face = "bold"))
  }
},width=1600, height=700)
```

### **Management of household excreta**

```{r}

excreta_mgmnt <- fread("data/table_16/table_16_9_excreta_management_by_background_xtics.csv")

excreta_mgmnt$Value<- fct_relevel(excreta_mgmnt$Value, 
                                    "Lowest", "Second", "Middle", "Fourth", "Highest")

excreta_mgmnt_county <- fread("data/table_16/table_16_9C_excreta_management_by_county.csv")
 
excreta_mgmnt_county1 <- full_join(county, excreta_mgmnt_county, by=c("Name"="County"))

selectInput("excreta_mgmnt", "",
             c("Residence"= "Residence",
             "Wealth quintile"="Wealth quintile",
             "By County"="County"
             ))

renderPlot({if(input$excreta_mgmnt!="County"){
  ggplot(excreta_mgmnt[excreta_mgmnt$`Background characteristics`%in%input$excreta_mgmnt,],aes(x=reorder(Category,Proportion), y=Proportion, fill=Value))+
  geom_bar(position="dodge", stat="identity")+
  theme_bw()+coord_flip()+
  labs( y="Proportion (%)", title="", x="Reason for migration", fill="Age")+
  scale_fill_brewer(palette = "Set1")+
  #scale_fill_manual(values = c("#f46d43","#74add1"))+
  geom_text(aes(label=paste0(Proportion,"%")), position=position_dodge(0.7),  hjust=-0.5, vjust=-0.5)+  
  theme(text=element_text(size=16, face = "bold"))+
  coord_flip()}
  else{
    ggplot(excreta_mgmnt_county1)+
  geom_sf(data=excreta_mgmnt_county1, fill=NA)+
  geom_sf(aes(fill=Proportion),color="grey80", size=0.0)+
  theme_void()+
  facet_grid(~Category, nrow=2)+
  scale_fill_gradient(low = "white", high = "#8c2d04")+
  labs(x="", y="",fill="Proportion (%)")+
  theme(text=element_text(size=14, face = "bold"))
  }
},width=1600, height=700)
```

### **Disposal of children's stool**

```{r}

child_stool_disp <- fread("data/table_16/table_16_10_stool_disposal_by_background_xtics.csv")


child_stool_disp$Value <- fct_relevel(child_stool_disp$Value, 
                                    "Lowest", "Second", "Middle", "Fourth", "Highest")

child_stool_disp_county <- fread("data/table_16/table_16_10C_stool_disposal_by_county.csv")

child_stool_disp_county1 <- full_join(county, child_stool_disp_county, by=c("Name"="County"))

selectInput("child_stool_disp", "",
             c("Age"= "Age",
               "Mother's education"="Mother's education",
               "Residence"="Residence",
               "Type of toilet facility"="Type of toilet facility",
             "Wealth quintile"="Wealth quintile",
             "By County"="County"
             ))

renderPlot({if(input$child_stool_disp!="County"){
  ggplot(child_stool_disp[child_stool_disp$`Background characteristics`%in%input$child_stool_disp,],aes(x=reorder(Category,Proportion), y=Proportion, fill=Value))+
  geom_bar(position="dodge", stat="identity")+
  theme_bw()+coord_flip()+
  labs( y="Proportion (%)", title="", x="", fill="Age")+
  scale_fill_brewer(palette = "Set1")+
  #scale_fill_manual(values = c("#f46d43","#74add1"))+
  geom_text(aes(label=paste0(Proportion,"%")), position=position_dodge(0.7),  hjust=-0.5, vjust=-0.5)+  
  theme(text=element_text(size=16, face = "bold"))+
  coord_flip()}
  else{
    ggplot(child_stool_disp_county1)+
  geom_sf(data=child_stool_disp_county1, fill=NA)+
  geom_sf(aes(fill=Proportion),color="grey80", size=0.0)+
  theme_void()+
  facet_grid(~Category, nrow=2)+
  scale_fill_gradient(low = "white", high = "#8c2d04")+
  labs(x="", y="",fill="Proportion (%)")+
  theme(text=element_text(size=14, face = "bold"))
  }
},width=1600, height=700)
```

### **Handwashing**

```{r}

handwashing <- fread("data/table_16/table_16_11_handwashing_by_background_xtics.csv")

handwashing$Value <- fct_relevel(handwashing$Value, 
                                    "Lowest", "Second", "Middle", "Fourth", "Highest")

handwashing_county <- fread("data/table_16/table_16_11C_handwashing_by_county.csv")
 
handwashing_county1 <- full_join(county, handwashing_county, by=c("Name"="County"))

selectInput("handwashing", "",
             c("Residence"="Residence",
             "Wealth quintile"="Wealth quintile",
             "By County"="County"
             ))

renderPlot({if(input$handwashing!="County"){
  ggplot(handwashing[handwashing$`Background characteristics`%in%input$handwashing,],aes(x=Value, y=Proportion, fill=Category))+
  geom_dotplot(binaxis='y', stackdir='center', binwidth = 2)+
  theme_bw()+
  labs( y="Proportion (%)", title="", x="", fill="Age")+
  scale_fill_brewer(palette = "Set1")+
  #scale_fill_manual(values = c("#f46d43","#74add1"))+
  geom_text(aes(label=paste0(Proportion,"%")),   hjust=-0.5, vjust=-0.5)+  
  theme(text=element_text(size=16, face = "bold"))}
  else{
    ggplot(handwashing_county1)+
  geom_sf(data=handwashing_county1, fill=NA)+
  geom_sf(aes(fill=Proportion),color="grey80", size=0.0)+
  theme_void()+
  facet_grid(~Category, nrow=2)+
  scale_fill_gradient(low = "white", high = "#8c2d04")+
  labs(x="", y="",fill="Proportion (%)")+
  theme(text=element_text(size=14, face = "bold"))
  }
},width=1600, height=700)
```

# Marriage {data-navmenu="Key Indicators"}



## Row {data-width="200"}

<br>

###  {.value-box}

```{r}

valueBox(
  value = paste("19.4%"),
  caption = "of marriages are registred with the civil authority",
  color = "#b15928",
  icon='fa-female,'
)
```

###  {.value-box}

```{r}
valueBox(
  value = paste("15.1%"),
  caption = "of marriages are registered with the civil authority and have proof of certificate",
  color = "darkgreen",
  icon=''
)
```

## Row {data-height="800"}

### .

**Please select indicator to visualize**

```{r}

marriage_data <- fread("data/table_4/marriage_data.csv")

marriage_data1 <- full_join(county, marriage_data, by=c("Name"="County"))

selectInput("marriage", "",
             c("Marriage registration"= "Marriage registration",
             "Age during first marriage"="Age first marriage",
             "Median age at first sexual intercourse"="Age first sexual intercourse"
             ))

renderGirafe({
  marriage_data1a <-marriage_data1 %>%filter(type%in%input$marriage) 

  marriage_data_map<- ggplot(marriage_data1a, aes(fill=Value)) + 
    geom_sf_interactive(aes(tooltip=paste0(Name, " ",Value,"%")))+
    facet_grid(~category)+
  theme_void() +
  theme(text =element_text(size=18, face="bold"))+
    scale_fill_gradient2(na.value = "white")
  marriage_map2<-girafe(ggobj =  marriage_data_map, width_svg=18, height_svg=12,
                   options = list(
                     opts_hover(css = "fill:#666666;cursor:pointer;"),
                     opts_selection(css = "fill:orange;", type = "multiple"),
                    # opts_sizing(rescale = TRUE),
                     opts_zoom(max = 9)),)
  print( marriage_map2, justify="right")
})
```



# Disability among the household population {data-navmenu="Key Indicators"}

## Row {data-width="200"}

###  {.value-box}

```{r}

valueBox(
  value = paste("16%"),
  caption = "Some difficulty",
  color = "black"
)
```

###  {.value-box}

```{r}
valueBox(
  value = paste("5%"),
  caption = "Alot of difficulty",
  color = "#b15928"
)
```

###  {.value-box}

```{r}

valueBox(
  value = paste("0.5%"),
  caption = "Cannot do anything at all",
  color = "darkgreen"
)
```

<br>

## Row {data-height="200"}

### Disability: choose a characteristic to display by:

```{r}

selectInput("disability", "",
              c("Summary"="All",
                "Age category (in years)"="Age_category", 
                "Marital Status (15-49years)"="Marital_status", 
                "Residence"="Residence",
                "Education status (highest level attended)"="Education_status",
                "Wealth quintile"="Wealth_quintile"), width=400)
```

### Choose a disability domain:

```{r }
selectInput("disability_domain", "",
              c("All domains"="All",
                "Seeing"="Seeing", 
                "Hearing"="Hearing", 
                "Communicating"="Communicating",
                "Remembering/Concentrating"="Remembering_concentrating","Walking/ClimbingSteps"="Walking/Climbing steps",
                "Washing all over/Dressing"="Washing all over/Dressing"), width=250)

```

## Row {data-height="600"}

### .

```{r }
# disability by age

## import data 
  
disabilitydata <- fread("data/table_4/table4_disabilitydata.csv")

disabilitydata$Indicator <- fct_relevel(disabilitydata$Indicator, 
                                    "Lowest", "Second", "Middle", "Fourth", "Highest")

 renderPlot({if(input$disability%in%"All"){
  ggplot(data=disabilitydata[disabilitydata$Indicator1==input$disability & disabilitydata$difficulty%in%c("Some Difficulty", "Alot of difficulty", "Cannot do at all"),], aes(x=difficulty, y=difficultyprop, )) + 
  geom_bar(stat = "identity", position = position_dodge(), fill="cyan4") + 
     geom_text( aes(label=label),stat="identity", position = position_dodge(0.8),  hjust=0.5, vjust=-0.2)+
  theme_bw()+
  labs(y="Percent (%)", x="", fill="Disability") +
  theme(text=element_text(size=16, face="bold"))+ 
     theme(strip.background =element_rect(fill="darkorange"))+
     scale_fill_brewer(palette="Set1")
 }else{
   ggplot(data=disabilitydata[disabilitydata$Indicator1==input$disability & disabilitydata$difficulty%in%c("Some Difficulty", "Alot of difficulty", "Cannot do at all"),], aes(x=Indicator, y=difficultyprop, fill=difficulty)) + 
  geom_bar(stat = "identity", position = position_dodge()) + 
     geom_text( aes(label=label),stat="identity", position = position_dodge(0.8),  hjust=0.5)+
     facet_grid(Participants~.)+
  theme_bw()+
  labs(y="Percent (%)", x="", fill="Disability") +
  theme(text=element_text(size=16, face="bold"))+ 
     theme(strip.background =element_rect(fill="darkorange"))+
     scale_fill_brewer(palette="Set1")
 }
    
})
 
 
```

### Kindly hover on the graph to see the actual values

```{r}

renderGirafe({if(input$disability_domain%in%"All"){
  disability_map1<-ggplot(data=disabilitydata[disabilitydata$Indicator1==input$disability_domain &disabilitydata$difficulty!=c("Some Difficulty", "Alot of difficulty", "Cannot do at all"),],aes(y=difficultyprop, x=reorder(difficulty, difficultyprop)) )+ geom_col(fill="brown")+
  theme_bw()+coord_flip()+geom_text(aes(label=paste0(round(difficultyprop), "%")),hjust=0.1)+
  labs(y="Percent (%)", x="", fill="Disability") +
  theme(text=element_text(size=20, face="bold"))+
     theme(strip.background =element_rect(fill="darkorange"))+
     scale_fill_brewer(palette="Set1") 
   disability_map1a<-girafe(ggobj = disability_map1,width_svg=10, height_svg=8,
                   options = list(
                    # opts_sizing(rescale = TRUE),
                     opts_zoom(max = 4)))
  print(disability_map1a, justify="left")
}else{
  disability_map2<-ggplot(data=disabilitydata[disabilitydata$Indicator1==input$disability & disabilitydata$difficulty%in%input$disability_domain,], ) + 
     geom_point_interactive(aes(y=difficultyprop, x=Indicator, tooltip=paste0(difficultyprop, "%"), group=Participants),color="brown", size=10)+facet_grid(Participants~.)+
  theme_bw()+
  labs(y="Percent (%)", x="", fill="Disability") +
  theme(text=element_text(size=20, face="bold"))+
     theme(strip.background =element_rect(fill="darkorange"))+
     scale_fill_brewer(palette="Set1") 
   disability_map2a<-girafe(ggobj = disability_map2,width_svg=10, height_svg=8,
                   options = list(
                     opts_hover(css = "fill:#666666;cursor:pointer;"),
                     opts_selection(css = "fill:orange;", type = "multiple"),
                    # opts_sizing(rescale = TRUE),
                     opts_zoom(max = 4)))
  print(disability_map2a, justify="left")
}
   
})
```

# Fertility {data-navmenu="Key Indicators"}

## Row {data-width="200"}

<br>

###  {.value-box}

```{r}

valueBox(
  value = paste("3.4"),
  caption = "Total Fertility Rate per woman (15-49 years)",
  color = "black"
)
```

###  {.value-box}

```{r}
valueBox(
  value = paste("122"),
  caption = "General fertility rate, expressed per 1,000 women age (15–44 years)",
  color = "#b15928"
)
```

###  {.value-box}

```{r}

valueBox(
  value = paste("27.7"),
  caption = "Crude birth rate, expressed per 1,000 population",
  color = "darkgreen"
)
```

<br>

## Row {data-width="100"}


### **Total fertility rate**

-   *Urban areas: 2.8*
-   *Rural areas: 3.9*

### **General fertility rate per 1,000 women**

-   *Urban areas: 105*
-   *Rural areas: 134*

### **Crude birth rate per 1,000 women**

-   *Urban areas: 30.1*
-   *Rural areas: 26.6*

<br>


## Column {.tabset .tabset-fade data-height="900"}

### **Background characteristics**

```{r, fig.width=14.8, fig.height=8}

agespecificfertilityrate <- fread( "data/table_5/table5_agespecificfertilityrate.csv")

ggplot(agespecificfertilityrate, aes(x=Age_category, y=Residenceprop))+geom_col(fill="cyan4")+facet_grid(Residence~.)+geom_text(aes(label=paste0(Residenceprop)), vjust=-0.5, color="black")+
    theme_bw()+labs(x="Age category", y="Rate per 1,000 women")+theme(text=element_text(size=20, face="bold")) + theme(strip.background =element_rect(fill="darkorange"))



```

### **Total fertility rate**

**Kindly select the characteristics**

```{r}
selectInput("tfr1", "",
            c("Residence"="Residence",
              "Education attainment"="Education",
              "Wealth quintile"="Wealth quintile",
              "By County (2014)" = "2014",
              "By County (2022)" = "2022"
            ))


fertility_rate <- fread("data/table_5/table 5.2fertility_rate.csv") 

fertility_rate$category <- fct_relevel(fertility_rate$category, 
                                    "Lowest", "Second", "Middle", "Fourth", "Highest")

tfrbycounty_2014 <- fread("data/table_5/Table 5.2_C  Fertility by county.2014.csv") 

tfrbycounty_2014 <- full_join(county, tfrbycounty_2014, by=c("Name"="County"))

TFRbycounty.2022 <- fread("data/table_5/Table 5.2_C  Fertility by county.2022.csv")

TFRbycounty.2022 <- full_join(county, TFRbycounty.2022, by=c("Name"="County"))


tfr_county <- rbind(tfrbycounty_2014,TFRbycounty.2022 ) 


renderPlot({if(input$tfr1%in%c("2014", "2022")){
  ggplot(tfr_county[tfr_county$year%in%input$tfr1,], aes(geometry=geometry, fill=Proportion))+
    geom_sf_interactive(aes(tooltip=Proportion))+
  theme_void()+
  facet_wrap(~Category)+
  scale_fill_gradient(low = "white", high = "#8c2d04")+
  labs(x="", y="",fill="Proportion (%)")+
  theme(text=element_text(size=14))}
  else{
      ggplot(fertility_rate[fertility_rate$characteristic%in%input$tfr1,],aes(x=category, y=proportion, fill=Variable))+
      #geom_point(size=5)+
  geom_dotplot(binaxis='y', stackdir='center', dotsize  = 3)+
  theme_bw()+
      geom_text(aes(label=paste0(proportion, "%")))+
  labs( y="Proportion (%)", title="", x="Wealth quintile", fill="")+
  scale_fill_manual(values = c("#d7191c","#fdae61","#ffffbf","#abd9e9"))+
  theme(text=element_text(size=12))
  }
  }, width=1300, height=700)

```



### **Median age at first birth**

**Kindly select the characteristics**

```{r}
selectInput("median_age", "",
            c("Residence"="Residence",
              "Education attainment"="Education",
              "Wealth quintile"="Wealth quintile",
              "By County (2014)" = "2014",
              "By County (2022)" = "2022"
            ))


median_age <- fread("data/table_5/Table 5.11 Median age at first birth.csv")

median_age$Variable<- fct_relevel(median_age$Variable, 
                                    "Lowest", "Second", "Middle", "Fourth", "Highest")

median_age_county <- fread("data/table_5/Table_6c Median.age.first.birth.csv") 

median_age_county <- full_join(county, median_age_county, by="Name")



renderPlot({if(input$median_age%in%c("2014", "2022")){
  ggplot(median_age_county[median_age_county$year%in%input$median_age,], aes(geometry=geometry, fill=Proportion))+
  theme_void()+
  facet_wrap(~category)+
  scale_fill_gradient(low = "white", high = "#8c2d04")+
  labs(x="", y="",fill="Proportion (%)")+
  theme(text=element_text(size=14))}
  else{
      ggplot(median_age[median_age$characteristic%in%input$median_age,],aes(x=category, y=proportion, fill=Variable))+
  geom_dotplot(binaxis='y', stackdir='center', dotsize  = 3)+
  theme_bw()+
  geom_text(aes(label=paste0(proportion, " %")))+
  labs( y="Proportion (%)", title="", x="Wealth quintile", fill="")+
  scale_fill_brewer(palette="Set1")+
  theme(text=element_text(size=14))
  }
  }, width=1300, height=700)

```

### **Teenage pregnancy**


**Choose the category to display**

```{r}

selectInput("teenage", "",
            c("Age" = "Age",
              "Education" = "Education",
              "Residence" = "Residence",
              "Wealth quintile"="Wealth quintile",
              "By County: Currently pregnant"="Currently pregnant",
            "By County: Ever pregnant"="Ever pregnant",
            "By County: Live birth"="Live birth",
            "By County: Pregnancy loss"="Pregnancy loss"
            ))

### teen pregnancy
teen_preg <- fread("data/table_6/table6_teenpregnancy.csv") 
teen_preg$indicator <- fct_relevel(teen_preg$indicator, 
                                    "Lowest", "Second", "Middle", "Fourth", "Highest")

teenpregnancybycountyvisual <- fread("data/table_6/table6_teenpregnancybycounty.csv") 

teen_preg$indicator <- fct_relevel(teen_preg$indicator, "No education", "Primary", "Secondary", "More than secondary",
                                   "Lowest", "Second", "Middle", "Fourth", "Highest")

renderPlot({if(input$teenage%in%"Wealth quintile"){
  ggplot(teen_preg[teen_preg$group%in%input$teenage,], aes(x=indicator, y=proportion, fill=classification)) + 
  geom_dotplot(binaxis='y', stackdir='center', binwidth = 2)+
  theme_bw()+
  labs( y="Percent (%)", title="", x="", fill="")+
  #scale_fill_manual(values = c("#f46d43","#fee090","#4575b4"))+
  theme(text=element_text(size=18, face="bold"))+
  geom_text(aes(label = lab), hjust=0.5,vjust=0.2, size=4)
}
  else if(input$teenage%in%c("Age", "Education", "Residence")){
  ggplot(teen_preg[teen_preg$group%in%input$teenage,], aes(x=indicator, y=proportion, fill=classification)) + 
  geom_dotplot(binaxis='y', stackdir='center', binwidth = 2)+
  theme_bw()+
  labs( y="Percent (%)", title="", x="", fill="")+
  #scale_fill_manual(values = c("#f46d43","#fee090","#4575b4"))+
  theme(text=element_text(size=18, face="bold"))+
  geom_text(aes(label = lab), hjust=0.5,vjust=0.2, size=4)
} else{
 teenpregnancybycountyvisual %>%
    filter(Pregnancy%in%input$teenage) %>%
  ggplot(aes(x=reorder(County,Percent), y=Percent)) + 
  geom_point(size=3,color="cyan4") +
    geom_text(aes(label=label), hjust=-1,color="black")+
  #, position = position_dodge()) +
  #facet_wrap(facets = ~reorder(Participants, Percent)) +
  #scale_fill_manual("Residence", values = c("Urban" = "darkorange", "Rural" = "cyan3")) +
  theme_bw() +
  coord_flip() +
  ylab("Percent (%)") + xlab("County") +
  theme(text=element_text(size=20, face="bold")) +
  theme(strip.background =element_rect(fill="gray80")) +scale_fill_brewer(palette="Set1")
 # teenage_preg1a<-girafe(ggobj = teenage_preg1,width_svg=18, height_svg=9,
#                   options = list(
#                     opts_hover(css = "fill:#666666;cursor:pointer;"),
#                     opts_selection(css = "fill:orange;", type = "multiple"),
                  #   opts_sizing(rescale = TRUE),
 #                    opts_zoom(max = 4)))
  #print(teenage_preg1a, justify="left")
    }
  }, width=1300, height=750)

  
```

# Fertility preferences {data-navmenu="Key Indicators"}

*Percent distribution of married women desire for children, by the number of children they already have - and whether they would want the child soon or later*

```{r}
# selectInput("fertility", "",
#             c( "Desire to have another soon"="Have another soon",
#               "Desire to have another later"="Have another later",
#               "Desire to have another, undecided when"="Have another, undecided when",
#               "Undecided"="Undecided",
#               "Want no more"="Want no more",
#               "Sterilized"="Sterilized",
#               "Declared infecund"="Declared infecund"))
```

## Column {.tabset .tabset-fade data-height="900"}

### **By number of living children**

```{r}



fertility_preferences <- fread("data/table_7/table7_fertilitypreferences.csv") 

renderPlot({
  ggplot(fertility_preferences,aes(x=`Number of children`, y=Percent))+
  geom_bar(position="dodge", stat="identity", fill="cyan4")+
    geom_text(aes(label=paste0(Percent, " %")))+
  theme_bw()+facet_wrap(~Desire_children)+
  labs( y="Percent (%)", title="", x="Number of children", fill="")+
  scale_fill_brewer(palette = "Set1")+
  theme(text=element_text(size=18, face="bold"))
}, width=1200, height=800)

```

### **Ideal number of children**

```{r}


children_number <- fread("data/table_6/Table 6.3  Ideal number of children by number of living children.csv") 

renderPlot({
  ggplot(children_number,aes(x=variable, y=value, fill=category))+
  geom_bar(position="dodge", stat="identity")+
    geom_text(aes(label=paste0(value, " %")), position = position_dodge(0.5))+
  theme_bw()+facet_wrap(~participants)+coord_flip()+
  labs( y="Percent (%)", title="", x="", fill="")+
  scale_fill_brewer(palette = "Set1")+
  theme(text=element_text(size=18, face="bold"))
}, width=1200, height=800)

```

### **Mean ideal number of children**


```{r}

selectInput("children_mean", "",
            c("Age" = "Age",
              "Education" = "Education",
              "Residence" = "Residence",
              "Wealth quintile"="Wealth quintile"
            ))

children_mean <- fread("data/table_6/Table 6.4  Mean ideal number of children according to background characteristics.csv") 

children_mean$Variable <- fct_relevel(children_mean$Variable, 
                                    "Lowest", "Second", "Middle", "Fourth", "Highest")

renderPlot({
  ggplot(children_mean[children_mean$characteristic%in%input$children_mean,],aes(x=Variable, y=mean))+
  geom_bar(position="dodge", stat="identity", fill="cyan3")+
  theme_bw()+coord_flip()+
  labs( y="Percent (%)", title="", x="", fill="")+
  theme(text=element_text(size=18, face="bold"))
}, width=1200, height=800)

```


### **Fertility planning status**


```{r}

selectInput("fertility_planning", "",
            c("Birth order" = "Birth order",
              "Mother's age at birth" = "Mother age at birth",
              "Pregnancy outcome" = "Pregnancy outcome"
            ))

fertility_planning <- fread("data/table_6/Table 6.5 Fertility planning status.csv")


renderPlot({
  ggplot(fertility_planning[fertility_planning$characteristic%in%input$fertility_planning,],aes(x=Variable, y=percent))+
  geom_bar(position="dodge", stat="identity", fill="cyan3")+
  theme_bw()+facet_grid(~`Fertility plan`)+
  labs( y="Percent (%)", title="", x="", fill="")+
  theme(text=element_text(size=18, face="bold"))
}, width=1200, height=800)

```

### **Wanted fertility rates**

```{r}

selectInput("fertility_rates", "",
            c("Education" = "Education",
              "Residence" = "Residence",
              "Wealth quintile" = "Wealth"
            ))

fertility_rates <- fread("data/table_6/Table 6.6  Wanted fertility rates.csv") 


fertility_rates$Variable <- fct_relevel(fertility_rates$Variable, 
                                    "Lowest", "Second", "Middle", "Fourth", "Highest")


renderPlot({
  ggplot(fertility_rates[fertility_rates$characteristic%in%input$fertility_rates,],aes(x=Variable, y=Wanted.fertility.rates))+
  geom_bar(position="dodge", stat="identity", fill="cyan3")+
  theme_bw()+coord_flip()+
  labs( y="Percent (%)", title="", x="", fill="")+
  theme(text=element_text(size=18, face="bold"))
}, width=1200, height=800)

```

# Family planning {data-navmenu="Key Indicators"}

## Row {data-width="200"}

<br>

###  {.value-box}

```{r}

valueBox(
  value = paste("63%"),
  caption = "of currently married women are using a contraceptive method",
  color = "black"
)
```

###  {.value-box}

```{r}
valueBox(
  value = paste("70%"),
  caption = "of the unmarried women use a contraceptive",
  color = "#b15928"
)
```

###  {.value-box}

```{r}

valueBox(
  value = paste("11%"),
  caption = "of sexually active unmarried women use traditional contraceptive methods",
  color = "darkgreen"
)
```

###  {.value-box}

```{r}

valueBox(
  value = paste("6%"),
  caption = "of sexually active married women use traditional contraceptive methods",
  color = "darkblue"
)
```

## Column {.tabset .tabset-fade data-height="900"}

### **Knowledge of contraceptive methods**

**Choose the characteristics to display:**

```{r}

selectInput("knowledge_contraceptives", "",
              c("All"="All",
                "Currently married"="Currently married",
                "Sexually active unmarried"="Sexually active unmarried"))
```

```{r, include=F}
# import data
knowledge_contraceptives <- fread("data/table_7/Table_7.1 Knowledge of contraceptive methods.csv")


```



```{r}

renderPlot({ggplot(knowledge_contraceptives[knowledge_contraceptives$variable%in%input$knowledge_contraceptives,],aes(x=reorder(method, proportion), y=proportion))+
    facet_grid(~gender)+
  geom_bar(position="dodge", stat="identity", fill="#74add1")+
    geom_text(aes(label=paste0(proportion, " %")))+
  theme_bw()+coord_flip()+
  labs( y="Proportion (%)", title="", x="", fill="")+
  scale_fill_manual(values = c("#f46d43","#74add1"))+
  theme(text=element_text(size=16, face="bold"))}, width=1600, height=700 )



```

### **Knowledge of fertile period**

**Choose the characteristics to display:**

```{r}

selectInput("knowledge_fertile", "",
              c("All women"="All women",
                "Users of rythm method"="Users of rythm method",
                "Users of SDM"="Users of SDM"))
```

```{r, include=F}
# import data
knowledge_fertile <- fread("data/table_7/Table_7.8_Knowledge of Fertile Period.csv")


```



```{r}

renderPlot({ggplot(knowledge_fertile[knowledge_fertile$variable%in%input$knowledge_fertile,],aes(x=reorder(perceived_fertility_period, Proportion), y=Proportion))+
  geom_bar(position="dodge", stat="identity", fill="#74add1")+
  theme_bw()+coord_flip()+
    geom_text(aes(label=paste0(Proportion, " %")))+
  labs( y="Proportion (%)", title="", x="", fill="")+
  scale_fill_manual(values = c("#f46d43","#74add1"))+
  theme(text=element_text(size=16, face="bold"))}, width=1600, height=700 )



```

### **Reasons for discontinuation**

**Choose the characteristics to display:**

```{r}

selectInput("reasons_discontinuation", "",
              c("All methods"="All methods",
                "Emergency contraception"="Emergency contraception",
                "Female condom"="Female condom",
                "Implants"="Implants",
                "Injectables"="Injectables",
                "IUD"="IUD",
                "Male condom"="Male condom",
                "other"="Other",
                "Pill"="Pill",
                "Rythm"="Rythm",
                "SDM"="SDM",
                "Withdrawal"="Withdrawal"))
```

```{r, include=F}
# import data
reasons_discontinuation <- fread("data/table_7/Table_7.14_Reason_for_discontinuation.csv") 
```



```{r}

renderPlot({ggplot(reasons_discontinuation[reasons_discontinuation$variable%in%input$reasons_discontinuation,],aes(x=reorder(Reason, Proportion), y=Proportion))+
  geom_bar(position="dodge", stat="identity", fill="#74add1")+
  theme_bw()+coord_flip()+
    geom_text(aes(label=paste0(Proportion, " %")))+
  labs( y="Proportion (%)", title="", x="", fill="")+
  scale_fill_manual(values = c("#f46d43","#74add1"))+
  theme(text=element_text(size=16, face="bold"))}, width=1600, height=700 )



```

### **Need and demand for family planning**

**Choose the characteristics to display:**

```{r}

selectInput("need_demand", "",
              c("Age"="Age",
                "Education"="Education",
                "Residence"="Residence",
                "Wealth"="Wealth"))
```

```{r, include=F}
# import data
need_demand <- fread("data/table_7/Table_7.15.1_2_Need and Demand for family planning.csv") 


```



```{r}

renderPlot({ggplot(need_demand[need_demand$variable%in%input$need_demand,],aes(x=Characteristic, y=Proportion, fill=type))+
  geom_bar(position="dodge", stat="identity")+
  theme_bw()+facet_grid(Category~need)+
    geom_text(aes(label=paste0(proportion, " %")), position = position_dodge(0.5))+
  labs( y="Proportion (%)", title="", x="", fill="")+
  scale_fill_brewer(palette ="Set1")+
  theme(text=element_text(size=16, face="bold"))}, width=1600, height=700 )



```

### **Decision making about family planning**

```{r}

selectInput("decision_making1a", "",
              c("Age"="Age",
                "Education"="Education",
                "Family planning use"="Family planning use",
                "General"="General",
                "Number of living children"="Number of living children",
                "Residence"="Residence",
                "Wealth"="Wealth"))

# import data
decision_making1a <- fread("data/table_7/Table_7.16_17_decision_making.csv")

```



```{r}

renderPlot({ggplot(decision_making1a[decision_making1a$variable%in%input$decision_making1a,],aes(x=reorder(category,proportion), y=proportion))+
  geom_bar(position="dodge", stat="identity", fill="#74add1")+
    geom_text(aes(label=paste0(proportion, " %")))+
  theme_bw()+coord_flip()+
  labs( y="Proportion (%)", title="", x="", fill="")+
  theme(text=element_text(size=16, face="bold"))}, width=1600, height=700 )


```

### **Future use of contraception**

```{r}
# import data
future_use_contraception <- fread("data/table_7/Table_7.19_Future_Contraception.csv")

```



```{r}

renderPlot({ggplot(future_use_contraception,aes(x=reorder(intention,proportion), y=proportion, fill=category))+
  geom_bar(position="dodge", stat="identity")+
  theme_bw()+coord_flip()+scale_fill_brewer(palette = "Set1")+
    geom_text(aes(label=paste0(proportion, " %")), position=position_dodge(0.5))+
  labs( y="Proportion (%)", title="", x="", fill="")+
  theme(text=element_text(size=16, face="bold"))}, width=1600, height=700 )


```


### **Exposure to family planning messages**

```{r}

selectInput("fp_messages", "",
              c("Age"="Age",
                "Education"="Education",
                "Residence"="Residence",
                "Wealth"="Wealth"))

# import data

fp_messages <-fread("data/table_7/Table_7_20_1_2_Exposure to family planning.csv")
```



```{r}

renderPlot({ggplot(fp_messages[fp_messages$variable%in%input$fp_messages,],aes(x=Characteristic, y=proportion, fill=category))+
  geom_bar(position="dodge", stat="identity")+facet_grid(~Gender)+
  theme_bw()+coord_flip()+scale_fill_brewer(palette = "Paired")+
    geom_text(aes(label=paste0(proportion, " %")))+
  labs( y="Proportion (%)", title="", x="", fill="")+
  theme(text=element_text(size=16, face="bold"))}, width=1600, height=700 )


```

# Childhood mortality {data-navmenu="Key Indicators"}

## Row {data-width="200"}

<br>

###  {.value-box}

```{r}

valueBox(
  value = paste("63%"),
  caption = "of currently married women are using a contraceptive method",
  color = "black"
)
```

###  {.value-box}

```{r}
valueBox(
  value = paste("70%"),
  caption = "of the unmarried women use a contraceptive",
  color = "#b15928"
)
```


## Column {.tabset .tabset-fade data-height="900"}


### **Early childhood mortality rates**

```{r}

selectInput("early_childhood", "",
              c("Birth interval"="Birth interval",
                "Birth order"="Birth order",
                "Education"="Education",
                "Mother's age"="Mother's age"))

# import data

early_childhood <-fread("data/table_8/Table_8.3_Early_Childhood_Mortality.csv")

early_childhood_county <-fread("data/table_8/Table_8.3C_County Early Childhood Mortality.csv") 
early_childhood_county <- full_join(county, early_childhood_county, by=c("Name"="county"))
```



```{r}

renderPlot({ggplot(early_childhood[early_childhood$Variable%in%input$early_childhood,],aes(x=Characteristic, y=proportion, fill=category))+
  geom_bar(position="dodge", stat="identity")+
  theme_bw()+scale_fill_brewer(palette = "Set1")+
    geom_text(aes(label=paste0(proportion,"%")),position=position_dodge(0.8), hjust=1, vjust=0.2)+
  labs( y="Proportion (%)", title="", x="", fill="")+
  theme(text=element_text(size=16, face="bold"))}, width=1600, height=700 )


```

### **Ten-year early childhood mortality**

```{r}

selectInput("early_childhood_mortality", "",
              c("Birth interval"="Birth interval",
                "Birth order"="Birth order",
                "Education"="Education",
                "Mother's age"="Mother's age",
                "By County"="County"))

# import data

early_childhood_mortality <-fread("data/table_8/Table_8.3_Early_Childhood_Mortality.csv")

early_childhood_mortality_county <-fread("data/table_8/Table_8.3C_County Early Childhood Mortality.csv")

early_childhood_mortality_county <- full_join(county, early_childhood_mortality_county, by=c("Name"="county")) 
  
```



```{r}

renderPlot({if(input$early_childhood_mortality!="County"){ggplot(early_childhood[early_childhood$Variable%in%input$early_childhood,],aes(x=Characteristic, y=proportion, fill=category))+
  geom_bar(position="dodge", stat="identity")+
  theme_bw()+scale_fill_brewer(palette = "Set1")+
    geom_text(aes(label=paste0(proportion, "%")))+
  labs( y="Proportion (%)", title="", x="", fill="")+
  theme(text=element_text(size=16, face="bold"))}
  else{
    ggplot(early_childhood_mortality_county, aes(geometry=geometry, fill=proportion))+
      geom_sf()+theme_void()+
  facet_wrap(~category)+
  scale_fill_gradient(low = "white", high = "#8c2d04")+
  labs(x="", y="",fill="Proportion (%)")+
  theme(text=element_text(size=14))
  }}, width=1600, height=700 )


```

### **Perinatal mortality**

```{r}

selectInput("perinatal_mortality", "",
              c("Age"="Age",
                "Pregnancy"="Pregnancy",
                "Residence"="Residence",
                "Wealth"="Wealth",
                "By County"="County"))

# import data

perinatal_mortality <-fread("data/table_8/Table_8.4_Perinatal Mortality.csv") %>%
  filter(category!="Pregnancies (28 weeks)")

perinatal_mortality_county <-fread("data/table_8/Table_8.4C_Perinatal Mortality By County.csv") 

perinatal_mortality_county <- full_join(county, perinatal_mortality_county, by=c("Name"="county"))

```



```{r}

renderPlot({if(input$perinatal_mortality!="County"){ggplot(perinatal_mortality[perinatal_mortality$variable%in%input$perinatal_mortality,],aes(x=characteristic, y=proportion, fill=category))+
  geom_bar(position="dodge", stat="identity")+
  theme_bw()+scale_fill_brewer(palette = "Set1")+
  labs( y="Proportion (%)", title="", x="", fill="")+
    geom_text(aes(label=paste0(proportion, "%")), position=position_dodge(0.5))+
  theme(text=element_text(size=16, face="bold"))}
  else{
    ggplot(perinatal_mortality_county, aes(geometry=geometry, fill=proportion))+
      geom_sf()+theme_void()+
  facet_wrap(~category)+
  scale_fill_gradient(low = "white", high = "#8c2d04")+
  labs(x="", y="",fill="Proportion (%)")+
  theme(text=element_text(size=14))
  }}, width=1600, height=700 )


```

# Mother's health {data-navmenu="Key Indicators"}

## Row {data-width="200"}

<br>

###  {.value-box}

```{r}

valueBox(
  value = paste("63%"),
  caption = "of currently married women are using a contraceptive method",
  color = "black"
)
```

###  {.value-box}

```{r}
valueBox(
  value = paste("70%"),
  caption = "of the unmarried women use a contraceptive",
  color = "#b15928"
)
```


## Column {.tabset .tabset-fade data-height="900"}

### **Antenatal care**

```{r}

selectInput("antenatal_care", "",
              c("Age"="Age",
                "Birth order"="Birth order",
                "Education"="Education",
                "Residence"="Residence",
                "Wealth"="Wealth"))

# import data

antenatal_care <-fread("data/table_9/Table_9.1_Antenatal_care.csv") 
   


```



```{r}

renderPlot({ggplot(antenatal_care[antenatal_care$Variable%in%input$antenatal_care,],aes(x=Characteristic, y=proportion, fill=category))+
  geom_bar(position="dodge", stat="identity")+
  theme_bw()+scale_fill_brewer(palette = "Set1")+
    geom_text(aes(label=paste0(proportion,"%")), position = position_dodge(0.5))+
  labs( y="Proportion (%)", title="", x="", fill="")+
  theme(text=element_text(size=16, face="bold"))}, width=1600, height=700 )


```

### **Number of antenatal care visits and timing of first visit**

```{r}

selectInput("antenatal_care1", "",
              c("Age at birth"="Age at birth",
                "Birth order"="Birth order",
                "Education"="Education",
                "Residence"="Residence",
                "Wealth"="Wealth"))

# import data

antenatal_care1 <-fread("data/table_9/Table_9.2_Number_of_antenatal_care_visits_and_timing_of_first_visit.csv") 
  
   


```



```{r}

renderPlot({ggplot(antenatal_care1[antenatal_care1$Variable%in%input$antenatal_care1,],aes(x=Characteristic, y=proportion, fill=category))+
  geom_bar(position="dodge", stat="identity")+
  theme_bw()+scale_fill_brewer(palette = "Set1")+
    geom_text(aes(label=paste0(proportion,"%")), position = position_dodge(0.6))+
  labs( y="Proportion (%)", title="", x="", fill="")+
  theme(text=element_text(size=16, face="bold"))}, width=1600, height=700 )


```

### **Components of antenatal care**

```{r}

selectInput("anc_components", "",
              c("Age at birth"="Age at birth",
                "Birth order"="Birth order",
                "Education"="Education",
                "Residence"="Residence",
                "Wealth"="Wealth"))

# import data
anc_components <-fread("data/table_9/Table_9.3.1_2_Components_of_antenatal_care.csv")

```



```{r}

renderPlot({ggplot(anc_components[anc_components$Variable%in%input$anc_components,],aes(x=Characteristic, y=proportion, fill=category))+
  geom_bar(position="dodge", stat="identity")+facet_grid(~type)+
  theme_bw()+scale_fill_brewer(palette = "Set1")+
    geom_text(aes(label=paste0(proportion,"%")), position = position_dodge(0.6))+
  labs( y="Proportion (%)", title="", x="", fill="")+
  theme(text=element_text(size=16, face="bold"))}, width=1600, height=700 )


```

### **Place of delivery**

```{r}

selectInput("place_delivery", "",
              c("Antenatal care visits"="Antenatal care visits",
                "Birth order"="Birth order",
                "Education"="Education",
                "Mother's age"="Mother's age",
                "Residence"="Residence",
                "Wealth"="Wealth"))


# import data

place_delivery <-fread("data/table_9/Table_9.7_Place_of_delivery.csv") 

```



```{r}

renderPlot({ggplot(place_delivery[place_delivery$Variable%in%input$place_delivery,],aes(x=Characteristic, y=proportion, fill=category))+
  geom_bar(position="dodge", stat="identity")+
  theme_bw()+scale_fill_brewer(palette = "Set1")+
    geom_text(aes(label=paste0(proportion,"%")), position = position_dodge(0.6))+
  labs( y="Proportion (%)", title="", x="", fill="")+
  theme(text=element_text(size=16, face="bold"))}, width=1600, height=700 )


```

### **Caesarean section**

```{r}




# import data

c_section <-fread("data/table_9/Table_9.8C_cesarean_section_by_county.csv") 


c_section <- full_join(county, c_section, by=c("Name"="county"))
```



```{r}

renderPlot({ggplot(c_section,aes(geometry=geometry, fill=percentage_delivered_by_cs))+
  geom_sf()+
  theme_void()+scale_fill_gradient(low = "white", high = "#8c2d04", na.value = "white")+
  labs(x="", y="",fill="Proportion (%)")+
  theme(text=element_text(size=14))}, width=1600, height=700 )


```

### **Assistance during delivery**

```{r}

selectInput("assist_delivery", "",
              c("Doctor"="Doctor",
                "Birth order"="Birth order",
                "Nurse/midwife"="Nurse/midwife",
                "Relative/friend/other"="relative/friend/other",
                "Total percentage delivered by skilled provider"="Total percentage delivered by skilled provider",
                "TBA"="TBA",
                "None"="None"))


# import data

assist_delivery <-fread("data/table_9/Table_9.9C_Assistance_during_delivery_by_county.csv") 


assist_delivery <- full_join(county, assist_delivery, by=c("Name"="County"))
```



```{r}

renderPlot({ggplot(assist_delivery,aes(geometry=geometry, fill=proportion))+
  geom_sf()+
  theme_void()+scale_fill_gradient(low = "white", high = "#8c2d04", na.value = "white")+
  labs(x="", y="",fill="Proportion (%)")+
  theme(text=element_text(size=14))}, width=1600, height=700 )


```

### **Men's involvement in maternal health care**

```{r}

selectInput("mens_involvement", "",
              c("Children ever fathered"="Children ever fathered",
                "Father's age"="Father's age",
                "Education"="Education",
                "Residence"="Residence",
                "Wealth"="Wealth"))


# import data

mens_involvement <-fread("data/table_9/Table_9.18_Men's_involvement_in_maternal_health_care.csv") 

```



```{r}

renderPlot({ggplot(mens_involvement[mens_involvement$Variable%in%input$mens_involvement,],aes(x=Characteristic, y=proportion, fill=category))+
  geom_bar(position="dodge", stat="identity")+
  theme_bw()+scale_fill_brewer(palette = "Set1")+
  labs( y="Proportion (%)", title="", x="", fill="")+
    geom_text(aes(label=paste0(proportion,"%")), position = position_dodge(0.6))+
  theme(text=element_text(size=16, face="bold"))}, width=1600, height=700 )


```

# Maternal care {data-navmenu="Key Indicators"}

## Row {data-width="200"}

<br>

###  {.value-box}

```{r}

valueBox(
  value = paste("89%"),
  caption = "of women who had a live birth \n in the 
2 years preceding the survey \n were delivered \n by a skilled provider
",
  color = "black"
)
```

###  {.value-box}

```{r}
valueBox(
  value = paste("82%"),
  caption = "of women who had a live birth \n in the 
2 years preceding the survey \n delivered \n in a health facility",
  color = "#b15928"
)
```

###  {.value-box}

```{r}

valueBox(
  value = paste("66%"),
  caption = "of women who had a live birth \n in the 
2 years preceding the survey \n had 4+ \n ANC visits",
  color = "darkgreen"
)

```

<br>

<br>

## Row {data-height="400"}

### Maternal care

```{r}

selectInput("maternal_care", "",
              c("Antenatal care from a skilled provider"="ANC from a skilled provider",
                "At least four antenatal care visits"="At least four ANC visits",
                "Took iron containing supplements during pregnancy"="Took iron supplements", "Most recent live birth was protected against neonatal tetanus"="Neonatal tetanus", "Delivered by a skilled provider"="Skilled delivery","Delivered in a health facility"="Health facility delivery", "Postnatal check during the first 2 days after birth"="Postnatal check"), width=600)

```

### Mother's background characteristics

```{r}
selectInput("chrt", "",
            c("Age at birth"="Age at birth",
            "Education"="Education",
            "Residence"="Residence",
            "Wealth quintile"="Wealth quintile"))
### Mother's age at birth
maternalcare <- fread("data/table_10/table10_maternalcare.csv") 

maternalcare$indicator <- fct_relevel(maternalcare$indicator, "Lowest", "Second", "Middle", "Fourth", "Highest", "No education", "Primary", "Secondary", "More than secondary")

renderPlot({
  ggplot(maternalcare[maternalcare$category%in%input$maternal_care & maternalcare$group%in%input$chrt,], aes(x=indicator, y=proportion)) + 
  geom_point(size=6, color="#4292c6")+
  theme_bw()+
  labs( y="Percent (%)", title="", x="Wealth quintile", fill="")+
  theme(text=element_text(size=16, face="bold"))+
  geom_text(aes(label = lab), hjust=0.3, size=4)
}, width=700, height=300)

```

## Column {data-height="500"}

### Spatial visualization

```{r}
# import data


maternalcarebycounty <- fread("data/table_10/table10c_maternalcarebycounty.csv")
  

# join the data with the shapefile
maternalcarebycounty1 <- left_join(county, maternalcarebycounty, by=c("Name"="County"))
```

```{r}
renderGirafe({
  
  map4<- ggplot(maternalcarebycounty1[maternalcarebycounty1$`Maternal care`%in%input$maternal_care,])+
  geom_sf_interactive(aes(fill=Percent, tooltip=names1),color="grey80", size=0.0)+
  theme_void()+
  scale_fill_gradient(low = "#fee6ce", high = "#7f2704")+
  labs(x="", y="",fill="Percent")+
  theme(text=element_text(size=14))
  x <- girafe(ggobj = map4,
                   options = list(
                     opts_hover(css = "fill:#666666;cursor:pointer;"),
                     opts_selection(css = "fill:orange;", type = "multiple"),
                     opts_zoom(max = 4)), width=8, height=7)
    print(x)})

```

### Maternal care data in descending order

```{r}

renderPlot({
  ggplot(maternalcarebycounty1[maternalcarebycounty1$`Maternal care`%in%input$maternal_care,], aes(x=reorder(Name, Percent), y=Percent)) +
geom_point(size=4, position = position_dodge(), color="cyan4") +
  theme_bw() + coord_flip() +
  geom_text(aes(label=paste0(round(Percent), "%")), hjust=1.3, size=4, color="black")+
  coord_flip() + 
  ylab("Percent (%)") + xlab("County") +
 # facet_grid(~Family_planning) +
  theme(text=element_text(size=14, face="bold"))
   
})

```

<br>

# Vaccinations {#vaccinations data-navmenu="Key Indicators"}

## Row {data-width="200"}

<br>

###  {.value-box}

```{r}

valueBox(
  value = paste("55%"),
  caption = "of children 12-23 months are fully vaccinated \n according to the national schedule",
  color = "black"
)

```

###  {.value-box}

```{r}
valueBox(
  value = paste("38%"),
  caption = "of children 24-35 months are fully vaccinated \n according to the national schedule",
  color = "#b15928"
)
```

<br>

## Column {data-height="800"}

```{r, include=F}



vacc_data <- fread("data/vaccinations_countydata.csv") 

county <- st_read("shapefiles/County.shp")
vacc_data1<- full_join(county, vacc_data, by=c("Name"="County"))
```

### Fully vaccinated according to the national schedule

```{r}
# user's input
selectInput("vacc", "",
              c("Fully vaccinated: 12-23 months"="CountyFullyVaccinated12",
                "Fully vaccinated: 24-35 months"="CountyFullyVaccinated24"))


#visualization

renderGirafe({
  
  map3<- ggplot(vacc_data1[vacc_data1$indicator2%in%input$vacc,], aes(fill=values))+
  geom_sf_interactive(aes(tooltip=paste0(values, "%")),color="grey80", size=0.0)+
  theme_void()+
  scale_fill_gradient(low = "#fee6ce", high = "#7f2704")+
  labs(x="", y="",fill="Proportion")#+
  #theme(text=element_text(size=14))
  x <- girafe(ggobj = map3, width_svg = 5, height_svg = 5,
                   options = list(
                     opts_hover(css = "fill:#666666;cursor:pointer;"),
                     opts_selection(css = "fill:orange;", type = "multiple"),
                     opts_zoom(max = 4)))
    print(x)
    })



```

### Characteristics of the fully vaccinated

```{r}

selectInput("vacc_char", "",
              c("Sex"="Gender",
                "Birth order"="Birth",
                "Vaccination card"="Card",
                "Residence"="Residence",
                "Mother's education"="Education",
                "Wealth quintile"="Wealth quintile"))



vaccination_data <-fread("data/vaccination_data.csv")

vaccination_data$Characteristics <- fct_relevel(vaccination_data$Characteristics, 
                                    "Lowest", "Second", "Middle", "Fourth", "Highest")

renderPlot({
  ggplot(vaccination_data[vaccination_data$indicator%in%input$vacc_char & vaccination_data$group%in%input$vacc,],aes(x=Vaccines, y=Percent)) + 
  geom_bar(stat = "identity", position = position_dodge(), fill="cyan4") +
  theme_bw() +facet_grid(.~Characteristics)+
  geom_text(aes(label=paste0(round(Percent), "%")), size=4, color="black", hjust=0.5)+
  scale_fill_brewer(palette = "Set1")+
  coord_flip() + labs(y="Percentage", x="", fill="")+
  theme(strip.text.x = element_text(size = 12, colour = "black", face = "bold")) +
  theme(strip.text.y = element_text(size = 12, colour = "black", face = "bold")) +
  theme(axis.title=element_text(size=14, face="bold"), axis.text = element_text(face = "bold", size = 13)) +
  theme(strip.background =element_rect(fill="darkorange")) 

}, width=700, height=600)
```

<br>

# Child health {data-navmenu="Key Indicators"}

## Row {data-width="200"}

<br>

###  {.value-box}

```{r}

valueBox(
  value = paste("82%"),
  caption = "of children <5 years with symptoms of ARI sought treatment or advice",
  color = "black"
)

```

###  {.value-box}

```{r}
valueBox(
  value = paste("70%"),
  caption = "of children <5 years with fever soought treatment or advice",
  color = "#b15928"
)
```

###  {.value-box}

```{r}
valueBox(
  value = paste("57%"),
  caption = "of children <5 years with diarrhea soought treatment or advice",
  color = "darkgreen"
)
```

<br>

## Column {.tabset .tabset-fade data-height="900"}

### **Health conditions**

```{r}
### Age
treatment <- fread("data/table_12/table12_childtreatment.csv") 

treatment$characteristics <- fct_relevel(treatment$characteristics, "Lowest", "Second", "Middle", "Fourth", "Highest")

selectInput("treat_char", "",
              c("Sex"="Sex",
                "Age"="Age",
                "Mother's Education"="Mother's Education",
                "Residence"="Residence",
                "Wealth quintile"="Wealth quintile"))



renderPlot({if (input$treat_char%in%c("Age", "Sex", "Residence")){ggplot(treatment[treatment$indicator%in%input$treat_char,],aes(x=characteristics, y=sought_treatment, fill=condition))+
  geom_bar(position="dodge", stat="identity")+
    geom_text(aes(label=paste0(round(sought_treatment),"%" )), position=position_dodge(0.7), vjust=-0.2)+
  theme_bw()+
  labs( y="% for whom treatment was sought", title="", x="Age (in months)", fill="Health condition")+
  scale_fill_brewer(palette="Set1")+
  theme(text=element_text(size=16))} else{
    ggplot(treatment[treatment$indicator%in%input$treat_char,],aes(x=characteristics, y=sought_treatment, fill=condition)) + 
  geom_dotplot(binaxis='y', stackdir='center', binwidth = 4)+
  theme_bw()+ geom_text(aes(label=paste0(round(sought_treatment),"%" )))+
  labs( y="% for whom treatment was sought", title="", x="Mother's education", fill="Health condition")+scale_fill_brewer(palette="Set1")+
  theme(text=element_text(size=16, face="bold"))
  } }, width=1200, height=700)

```


### **Treatment conditions**

```{r, include=F}

county <- st_read("shapefiles/County.shp")

```

```{r}

selectInput("trt_county", "",
            c("ARI"="ARI",
              "Diarrhea"="Diarrhea",
              "Fever"="Fever"))

treatment_county <- fread("data/table_12/table12C_childtreatment_by_county.csv")

renderGirafe({
  treatment_county1 <- full_join(county, treatment_county[treatment_county$condition%in%input$trt_county,], by=c("Name"="County"))%>%
  mutate(names=ifelse(sought_treatment%in%NA, paste0(Name," No value"), paste0(Name,", ", sought_treatment,"%")))
  treatment_map <- ggplot(treatment_county1, aes(fill=sought_treatment))+
  #geom_sf(data=treatment_county1, aes(geometry=geometry), fill=NA)+
  geom_sf_interactive(aes(fill=sought_treatment, tooltip=names),color="grey80", size=0.0)+
  theme_void()+
   scale_fill_gradient(low = "#fee6ce", high = "#7f2704", na.value = "white")+
  labs(x="", y="",fill="% of children for whom\n treatment was sought")+
  theme(text=element_text(size=14))
  treatment_map1a <-  ggplot(treatment_county[treatment_county$condition%in%input$trt_county & !is.na(treatment_county$sought_treatment),], aes(x=reorder(County,sought_treatment), y=sought_treatment))+
    geom_col(fill="cyan4")+coord_flip()+
    theme_bw()+ geom_text(aes(label=paste0(round(sought_treatment),"%")))+
    scale_fill_gradient(low = "#fee6ce", high = "#7f2704")+
    labs(x="", y="",fill="%")+
    theme(text=element_text(size=14, face="bold")) 

  treatment_map2<-girafe(ggobj = treatment_map , width_svg = 5, height_svg = 5,
                   options = list(
                     opts_hover(css = "fill:#666666;cursor:pointer;"),
                     opts_selection(css = "fill:orange;", type = "multiple"),
                     opts_sizing(rescale = T),
                     opts_zoom(max = 4)))
  treatment_map2b<-girafe(ggobj = treatment_map1a , width_svg = 5, height_svg = 5,
                   options = list(
                     opts_hover(css = "fill:#666666;cursor:pointer;"),
                     opts_selection(css = "fill:orange;", type = "multiple"),
                     opts_sizing(rescale = T),
                     opts_zoom(max = 4)))
  print(treatment_map2)
 # print(treatment_map2b)
  })
```

#### **Treatment conditions: descending**

```{r, fig.height=6}

  

renderPlot({
  ggplot(treatment_county[treatment_county$condition%in%input$trt_county & !is.na(treatment_county$sought_treatment),], aes(x=reorder(County,sought_treatment), y=sought_treatment))+
    geom_col(fill="cyan4")+coord_flip()+
    theme_bw()+ geom_text(aes(label=paste0(round(sought_treatment),"%")))+
    scale_fill_gradient(low = "#fee6ce", high = "#7f2704")+
    labs(x="", y="",fill="%")+
    theme(text=element_text(size=14, face="bold")) 
},width = 605, height=550)
```

### **Source of treatment**

```{r}
selectInput("trtsrc","",
             c("ARI"="ARI",
               "Diarrhea"="Diarrhea"))
```


```{r}
treat_source <- fread("data/table_10/table10_7_10_12_treatment_by_source.csv") 

renderPlot({
  ggplot(treat_source[treat_source$Condition%in%input$trtsrc,], aes(x=reorder(`Source of Treatment`,Proportion), y=Proportion, fill=Category))+
  geom_bar(position="dodge",stat = "identity")+
  theme_bw()+
  labs( y="Proportion (%)", title="", x="Source of Treatment for ARI", fill="")+
  theme(text=element_text(size=16, face="bold"))+
  geom_text(aes(label = lab),position=position_dodge(0.5), hjust=0.3)+
  coord_flip()+
    scale_fill_brewer(palette = "Set1")
}, width=1200, height=800)
```

# Early Childhood Development Index 2030 {data-navmenu="Key Indicators"}

## Row {data-width="200"}

<br>

###  {.value-box}

```{r}

valueBox(
  value = paste("78%"),
  caption = "of children 24-59 months who are developed mentally on track in health, learning & physiological well-being",
  color = "black"
)
```

###  {.value-box}

```{r}
valueBox(
  value = paste("4,797"),
  caption = "children 24-59 months were assessed",
  color = "#b15928"
)
```

## Row {data-width="600"}

```{r}
#### Proportion of children aged 24-59 months who are developmentally on track in health, learning, #### & psychosocial wellbeing.

selectInput("ecd","",
             c("Age"="Age",
               "Sex"="Sex",
               "Residence"="Residence",
               "Early childhood education attendance"="Early childhood education attendance",
               "Mother's education"="Mother's education",
               "Wealth quintile"="Wealth quintile"))


ecd <- fread("data/table_13/table13_ECD.csv")

ecd$characteristics <- fct_relevel(ecd$characteristics, 
                                    "Lowest", "Second", "Middle", "Fourth", "Highest")

renderPlot({ if(input$ecd%in%c("Age", "Sex", "Residence", "Early childhood education attendance")){
  ggplot(ecd[ecd$indicator%in%input$ecd,],aes(x=characteristics, y=proportion))+
  geom_col(fill="#74add1")+
  theme_bw()+
  labs( y="Percent (%)", title="", x="", fill="")+
  theme(text=element_text(size=16))+
  geom_text(aes(label = lab), nudge_y = 0.5, size=5)} else{
  ggplot(ecd[ecd$indicator%in%input$ecd,], aes(x=characteristics, y=proportion)) + 
  geom_dotplot(binaxis='y', stackdir='center', binwidth = 4, fill="#4292c6")+
  theme_bw()+
  labs( y="Percent (%)", title="", x="Mother's education", fill="")+
  theme(text=element_text(size=16))+
  geom_text(aes(label = lab), hjust=0.3, size=5)   
  }
}, width=1400, height=800)



  



```

# Nutrition {data-navmenu="Key Indicators"}

## Row {data-width="200"}

<br>

###  {.value-box}

```{r}

valueBox(
  value = paste("18%"),
  caption = "of children <5 years are stunted",
  color = "black"
)
```

###  {.value-box}

```{r}
valueBox(
  value = paste("5%"),
  caption = "of children <5 years are wasted",
  color = "#b15928"
)
```

###  {.value-box}

```{r}

valueBox(
  value = paste("10%"),
  caption = "of children <5 years are underweight",
  color = "darkgreen"
)
```

<br>

## Column {.tabset .tabset-fade data-height="900"}

### **Nutritional measure**

**Choose characteristics to display**

```{r}

selectInput("nutr", "",
              c("Sex"="Sex", 
                "Residence"="Residence",
                "Mother's education"="Mother_education",
                "Wealth quintile"="Wealth_quintile"))

```

```{r}


nut_total <- fread("data/table_14/table14_nutr_status.csv")

nut_total$Indicator <- fct_relevel(nut_total$Indicator, 
                                    "Lowest", "Second", "Middle", "Fourth", "Highest", "No education", "Primary", "Secondary", "More than secondary")

renderPlot({
  ggplot(nut_total[nut_total$Indicator1%in%input$nutr,], aes(x=Indicator, y=perc_below2sd, fill=measure))+
  geom_bar(position="dodge", stat="identity")+
      geom_text(aes(label=paste0(round(perc_below2sd), "%")), position=position_dodge(0.7), vjust=-0.1)+
  theme_bw()+
  labs( y="Proportion(%)", title="", x="Nutritional measure", fill="Residence")+
  scale_fill_manual(values = c("#f46d43","#74add1", "#78c679"))+
  theme(text=element_text(size=20, face="bold"))
},width = 1300, height=700)

```


### **Nutritional status (county-map)**

```{r}
selectInput("nutr2", "",
              c("Stunting"="HFA",
                "Wasting"="WFA",
                "Underweight"="WFH"))
```

<br>

```{r, include=FALSE}
nutc <- fread("data/table_14/table14C_nutr_status_by_county.csv")

county <- st_read("shapefiles/County.shp")%>%
  mutate(region=ifelse(Name%in%c("Kilifi","Kwale","Lamu", "Mombasa", "Taita Taveta", "Tana River"),"Coast", ifelse(Name%in%c("Garissa", "Mandera", "Wajir"),"North Eastern", ifelse(Name%in%c("Marsabit","Isiolo","Meru","Tharaka Nithi","Embu","Kitui","Machakos","Makueni"),"Eastern", ifelse(Name%in%c("Kiambu", "Kirinyaga","Muranga","Nyandarua", "Nyeri"),"Central", ifelse(Name%in%c("Bungoma",
 "Busia","Kakamega","Vihiga"),"Western", ifelse(Name%in%c("Kisumu", "Siaya","Homa Bay","Kisii", "Migori","Nyamira"),"Nyanza", ifelse(Name%in%"Nairobi","Nairobi", "Rift Valley"))))))))%>%
  rename(County=Name)
```



```{r, fig.height=6}

nutc1 <- full_join(county, nutc, by="County")


renderGirafe({
   
  nut_map2 <- ggplot(nutc1[nutc1$indicator%in%input$nutr2,], aes(fill=perc_below2sd))+
    ggiraph::geom_sf_interactive(aes(tooltip = paste0(County,": ", perc_below2sd,"%")),size=0.3)+
    theme_void()+
   scale_fill_gradient(low = "#fee6ce", high = "#7f2704")+
    labs(x="", y="",fill="%")+
    theme(text=element_text(size=14)) 
  nut_map2x<-girafe(ggobj = nut_map2, width_svg = 5, height_svg = 5,
                   options = list(
                     opts_hover(css = "fill:#666666;cursor:pointer;"),
                     opts_selection(css = "fill:orange;", type = "multiple"),
                     opts_sizing(rescale = T),
                     opts_zoom(max = 4)))
  print(nut_map2x)
})#,width = 1500, height=800)

```

### **Nutritional status (county-descending)**

```{r}
selectInput("nutr2a", "",
              c("Stunting"="HFA",
                "Wasting"="WFA",
                "Underweight"="WFH"))
```

```{r }

  

renderPlot({
  ggplot(nutc1[nutc1$indicator%in%input$nutr2a,], aes(x=reorder(County,perc_below2sd), y=perc_below2sd))+
    geom_col(fill="cyan4")+coord_flip()+
    theme_bw()+ geom_text(aes(label=paste0(round(perc_below2sd),"%")), hjust=1, color="white")+
    scale_fill_gradient(low = "#fee6ce", high = "#7f2704")+
    labs(x="", y="",fill="%")+
    theme(text=element_text(size=15, face="bold")) 
},width = 1200, height=700)
```


### **Micronutrient supplementation & deworming**

```{r}
selectInput("micronutrients", "",
              c("Age (in months)"="Age",
                "Mother's age"="Mother's age",
                "Mother's education"="Mother's education",
                "Breastfeeding status"="Breastfeeding status",
                "Residence"="Residence",
                "Sex"="Sex",
                "Wealth quintile"="Wealth quintile",
                "County"="County"))
```

```{r, include=F}
micronutrient_county <- fread("data/table_11/table11_12C_micronutrient_by_county.csv")

county <- st_read("shapefiles/County.shp")
micronutrient_county1 <- full_join(county, micronutrient_county, by=c("Name"="County"))


```


```{r}
micronutrient <- fread("data/table_11/table11_12_micronutrient_by_background_xtics.csv")

micronutrient$Value <- fct_relevel(micronutrient$Value, 
                                    "Lowest", "Second", "Middle", "Fourth", "Highest")

renderPlot({if(input$micronutrients%in%c("Age","Mother's age", "Mother's education", "Wealth quintile" )){
  ggplot(micronutrient[micronutrient$`Background characteristics`%in%input$micronutrients,],aes(x=Value, y=Proportion, fill=Category))+
  geom_dotplot(binaxis='y', stackdir='center', binwidth = 4)+
  theme_bw()+
  labs( y="Proportion (%)", title="", x="", fill="Micronutrient provided")+
  scale_fill_manual(values = c("#d7191c","#fdae61","#ffffbf","#abd9e9","#2c7bb6"))+
  geom_text(aes(label=paste0(Proportion,"%")))+
  theme(text=element_text(size=16, face="bold"))}
  else if(input$micronutrients%in%"County"){
   ggplot(micronutrient_county1)+
  geom_sf(data=micronutrient_county1, aes(geometry=geometry), fill=NA)+
  geom_sf(aes(fill=Proportion),color="grey80", size=0.0)+
  theme_void()+
  facet_wrap(~Category)+
  scale_fill_gradient(low = "white", high = "#8c2d04")+
  labs(x="", y="",fill="Proportion (%)")+
  theme(text=element_text(size=16)) }
  else{
    ggplot(micronutrient[micronutrient$`Background characteristics`%in%input$micronutrients,],aes(x=Value, y=Proportion, fill=Category))+
  geom_bar(position="dodge", stat="identity")+
  theme_bw()+
  labs( y="Proportion (%)", title="", x="", fill="Micronutrient provided")+
  scale_fill_manual(values = c("#d7191c","#fdae61","#ffffbf","#abd9e9","#2c7bb6"))+
  geom_text(aes(label=paste0(Proportion,"%")), position = position_dodge(0.7))+
  theme(text=element_text(size=16, face = "bold"))
  }
},width=1600, height=700)
```

### **Women minimum dietary diversity**


```{r}
selectInput("mdd", "",
              c("Age in years"="Age",
                "Education"="Education",
                "Maternity status"="Maternity status",
                "Residence"="Residence",
                "Wealth quintile"="Wealth quintile",
                "County"="County"))
```

```{r, include=F}
mdd_county <- fread("data/table_11/table11_15C_MDD-W_by_county.csv")

county <- st_read("shapefiles/County.shp")
mdd_county1 <- full_join(county, mdd_county, by=c("Name"="County"))

```


```{r}
mdd <- fread("data/table_11/table11_15_MDD-W_by_background_xtics.csv")

mdd$Value <- fct_relevel(mdd$Value, 
                                    "Lowest", "Second", "Middle", "Fourth", "Highest")

renderPlot({if(input$mdd%in%c("Age", "Education", "Wealth quintile" )){
  ggplot(mdd[mdd$`Background characteristics`%in%input$mdd,],aes(x=Value, y=Proportion, fill=Category))+
  geom_dotplot(binaxis='y', stackdir='center', binwidth = 4)+
  theme_bw()+
  labs( y="Proportion (%)", title="", x="Age category (in months)", fill="Micronutrient provided")+
  scale_fill_manual(values = c("#d7191c","#fdae61","#ffffbf","#abd9e9","#2c7bb6"))+
  geom_text(aes(label=paste0(Proportion,"%")))+
  theme(text=element_text(size=16, face="bold"))}
  else if(input$mdd%in%"County"){
   ggplot(mdd_county1)+
  geom_sf(data=mdd_county1, aes(geometry=geometry), fill=NA)+
  geom_sf(aes(fill=Proportion),color="grey80", size=0.0)+
  theme_void()+
  facet_wrap(~Category)+
  scale_fill_gradient(low = "white", high = "#8c2d04")+
  labs(x="", y="",fill="Proportion (%)")+
  theme(text=element_text(size=16)) }
  else{
    ggplot(mdd[mdd$`Background characteristics`%in%input$mdd,],aes(x=Value, y=Proportion, fill=Category))+
  geom_bar(position="dodge", stat="identity")+
  theme_bw()+
  labs( y="Proportion (%)", title="", x="", fill="")+
  scale_fill_manual(values = c("#d7191c","#fdae61","#ffffbf","#abd9e9","#2c7bb6"))+
  geom_text(aes(label=paste0(Proportion,"%")), position = position_dodge(0.7))+
  theme(text=element_text(size=16, face="bold"))
  }
}, width=1600, height=700)
```



# Malaria {data-navmenu="Key Indicators"}

## Row {data-width="200"}

<br>

###  {.value-box}

```{r}

valueBox(
  value = paste("54%"),
  caption = "Households with at least 1 insecticide treated net",
  color = "black"
)
```

###  {.value-box}

```{r}
valueBox(
  value = paste("1.2"),
  caption = "Average number of insecticide treated nets per household",
  color = "#b15928"
)
```

###  {.value-box}

```{r}

valueBox(
  value = paste("37%"),
  caption = "Households with at least 1 insecticide treated net\n per 2 persons who stayed last night",
  color = "darkgreen"
)
```

<br>

## Column {.tabset .tabset-fade data-height="900"}

### **Household possession of mosquito nets**

```{r}

selectInput("itn", "",
              c("Residence"="Residence",
                "Endemicity zone"="Endemicity zone",
                "Wealth quintile"="Wealth quintile", "By County"="County"))
```

```{r, include=F}
# import data

itn_possess <- fread("data/table_12/table12_1_ITN_possession_by_background_xtics.csv")

itn_possess$Value<- fct_relevel(itn_possess$Value, 
                                    "Lowest", "Second", "Middle", "Fourth", "Highest")

itn_possess_county <- fread("data/table_12/table12_1C_ITN_possession_by_county.csv")

county <- st_read("shapefiles/County.shp")
itn_possess_county1 <- full_join(county, itn_possess_county, by=c("Name"="County"))

```



```{r}

renderPlot({if(input$itn!="County"){ggplot(itn_possess[itn_possess$`Background characteristics`%in%input$itn,],aes(x=Value, y=Proportion, fill=Category))+
  geom_bar(position="dodge", stat="identity")+
  theme_bw()+
  labs( y="Proportion (%)", title="", x="Residence", fill="Household ITN ownership")+
  scale_fill_manual(values = c("#f46d43","#74add1"))+
  theme(text=element_text(size=16, face="bold"))}
  else{
  ggplot(itn_possess_county1)+
  geom_sf(data=itn_possess_county1, aes(geometry=geometry), fill=NA)+
  geom_sf(aes(fill=Proportion),color="grey80", size=0.0)+
  theme_void()+
  facet_wrap(~Category)+
  scale_fill_gradient(low = "white", high = "#8c2d04")+
  labs(x="", y="",fill="Proportion (%)")+
  theme(text=element_text(size=16, face="bold"))
  }}, width=1600, height=700 )



```

### **Source of mosquito nets**

```{r}

selectInput("itn_source", "",
              c("Residence"="Residence",
                "Endemicity zone"="Endemicity zone",
                "Wealth quintile"="Wealth quintile", "By County"="County"))
```

```{r, include=F}
# import data

itn_source <- fread("data/table_12/table12_2_ITN_source_by_background_xtics.csv")

itn_source$Value <- fct_relevel(itn_source$Value, 
                                    "Lowest", "Second", "Middle", "Fourth", "Highest")
itn_source_county <- fread("data/table_12/table12_2C_ITN_source_by_county.csv")

county <- st_read("shapefiles/County.shp")
itn_source_county1 <- full_join(county, itn_source_county, by=c("Name"="County"))

```



```{r}

renderPlot({
 if(input$itn_source%in%"County"){
  ggplot(itn_source_county1)+
  geom_sf(data=itn_source_county1, aes(geometry=geometry), fill=NA)+
  geom_sf(aes(fill=Proportion),color="grey80", size=0.0)+
  theme_void()+
  facet_wrap(~Category)+
  scale_fill_gradient(low = "white", high = "#8c2d04")+
  labs(x="", y="",fill="Proportion (%)")+
  theme(text=element_text(size=16, face="bold"))
  }
  else{
    ggplot(itn_source[itn_source$`Background characteristics`%in%input$itn_source,],aes(x=reorder(Category,Proportion), y=Proportion, fill=Value))+
  geom_bar(position="dodge", stat="identity")+
  theme_bw()+coord_flip()+
      geom_text(aes(label=paste0(Proportion,"%")), position = position_dodge(0.6))+
  labs( y="Proportion (%)", title="", x="", fill="ITN use")+
  scale_fill_brewer(palette = "Set1")+
  theme(text=element_text(size=16, face="bold"))
  }}, width=1600, height=700 )



```


### **Access to an insecticide-treated net (ITN)**

```{r}

selectInput("itn_access", "",
              c("Residence"="Residence",
                "Endemicity zone"="Endemicity zone",
                "Wealth quintile"="Wealth quintile", "By County"="County"))
```

```{r, include=F}
# import data

itn_access <- fread("data/table_12/table12_3_ITN_access_by_background_xtics.csv") 

itn_access$Value<- fct_relevel(itn_access$Value, 
                                    "Lowest", "Second", "Middle", "Fourth", "Highest")

itn_access_county <- fread("data/table_12/table12_3C_ITN_access_by_county.csv") 

county <- st_read("shapefiles/County.shp")
itn_access_county1 <- full_join(county, itn_access_county, by=c("Name"="County"))

```



```{r}

renderPlot({if(input$itn_access%in%c("Residence", "Endemicity zone")){ggplot(itn_access[itn_access$`Background characteristics`%in%input$itn_access,],aes(x=Value, y=Proportion))+
  geom_bar(position="dodge", stat="identity", fill="#2c7bb6")+
  theme_bw()+
  labs( y="Proportion (%)", title="", x="Residence", fill="Household ITN ownership")+
  #scale_fill_brewer(palette = "Set1")+
  theme(text=element_text(size=16, face="bold"))}
  else if(input$itn_access%in%"County"){
  ggplot(itn_access_county1)+
  geom_sf(data=itn_access_county1, aes(geometry=geometry), fill=NA)+
  geom_sf(aes(fill=Proportion),color="grey80", size=0.0)+
  theme_void()+
  scale_fill_gradient(low = "white", high = "#8c2d04")+
  labs(x="", y="",fill="Proportion (%)")+
  theme(text=element_text(size=16, face="bold"))
  }
  else{
    ggplot(itn_access[itn_access$`Background characteristics`%in%input$itn_access,],aes(x=Value, y=Proportion))+
  geom_dotplot(binaxis='y', stackdir='center', binwidth = 4,fill="#2c7bb6")+
  theme_bw()+
  labs( y="Proportion (%)", title="", x="Residence", fill="ITN use")+
#  scale_fill_brewer(palette = "Set1")+
  theme(text=element_text(size=16, face="bold"))
  }}, width=1600, height=700 )



```




### **Use of mosquito nets by households**


```{r}

selectInput("itn_use", "",
              c("Residence"="Residence",
                "Endemicity zone"="Endemicity zone",
                "Wealth quintile"="Wealth quintile", "By County"="County"))
```

```{r, include=F}
# import data

itn_use <- fread("data/table_12/table12_4_ITN_use_by_background_xtics.csv")

itn_use$Value <- fct_relevel(itn_use$Value, 
                                    "Lowest", "Second", "Middle", "Fourth", "Highest")

itn_use_county <- fread("data/table_12/table12_4C_ITN_use_by_county.csv")

county <- st_read("shapefiles/County.shp")

itn_use_county1 <- full_join(county, itn_use_county, by=c("Name"="County"))

```



```{r}

renderPlot({if(input$itn_use%in%c("Residence", "Endemicity zone")){ggplot(itn_use[itn_use$`Background characteristics`%in%input$itn_use,],aes(x=Value, y=Proportion, fill=Category))+
  geom_bar(position="dodge", stat="identity")+
  theme_bw()+
  labs( y="Proportion (%)", title="", x="", fill="Household ITN ownership")+
  scale_fill_brewer(palette = "Set1")+
  theme(text=element_text(size=16, face="bold"))}
  else if(input$itn_use%in%"County"){
  ggplot(itn_use_county1)+
  geom_sf(data=itn_use_county1, aes(geometry=geometry), fill=NA)+
  geom_sf(aes(fill=Proportion),color="grey80", size=0.0)+
  theme_void()+
  facet_wrap(~Category)+
  scale_fill_gradient(low = "white", high = "#8c2d04")+
  labs(x="", y="",fill="Proportion (%)")+
  theme(text=element_text(size=16, face="bold"))
  }
  else{
    ggplot(itn_use[itn_use$`Background characteristics`%in%input$itn_use,],aes(x=Value, y=Proportion, fill=Category))+
  geom_dotplot(binaxis='y', stackdir='center', binwidth = 4)+
  theme_bw()+
  labs( y="Proportion (%)", title="", x="Residence", fill="ITN use")+
  scale_fill_brewer(palette = "Set1")+
  theme(text=element_text(size=16, face="bold"))
  }}, width=1600, height=700 )



```

### **Use of existing ITNs**


```{r}

selectInput("itn_itn", "",
              c("Residence"="Residence",
                "Endemicity zone"="Endemicity zone",
                "Wealth quintile"="Wealth quintile", "By County"="County"))
```

```{r, include=F}
# import data

existing_itn_use <- fread("data/table_12/table12_5_existing_ITN_use_by_background_xtics.csv") 

existing_itn_use$Value<- fct_relevel(existing_itn_use$Value, 
                                    "Lowest", "Second", "Middle", "Fourth", "Highest")

existing_itn_use_county <- fread("data/table_12/table12_5C_existing_ITN_use_by_county.csv")

existing_itn_use_county1 <- full_join(county, existing_itn_use_county, by=c("Name"="County"))



```



```{r}

renderPlot({if(input$itn_itn%in%c("Residence", "Endemicity zone")){ggplot(existing_itn_use[existing_itn_use$`Background characteristics`%in%input$itn_itn,],aes(x=Value, y=Proportion))+
  geom_bar(position="dodge", stat="identity", fill="#74add1")+
  theme_bw()+
  labs( y="Proportion (%)", title="", x="", fill="Household ITN ownership")+
  scale_fill_brewer(palette = "Set1")+
    geom_text(aes(label=paste0(Proportion,"%")))+
  theme(text=element_text(size=16, face="bold"))}
  else if(input$itn_itn%in%"County"){
  ggplot(existing_itn_use_county1)+
  geom_sf(data=existing_itn_use_county1, aes(geometry=geometry), fill=NA)+
  geom_sf(aes(fill=Proportion),color="grey80", size=0.0)+
  theme_void()+
  scale_fill_gradient(low = "white", high = "#8c2d04")+
  labs(x="", y="",fill="Proportion (%)")+
  theme(text=element_text(size=16, face="bold"))
  }
  else{
    ggplot(existing_itn_use[existing_itn_use$`Background characteristics`%in%input$itn_itn,],aes(x=Value, y=Proportion))+
  geom_dotplot(binaxis='y', stackdir='center', binwidth = 2,fill="#74add1")+
  theme_bw()+
  labs( y="Proportion (%)", title="", x="Residence", fill="ITN use")+
  scale_fill_brewer(palette = "Set1")+
  geom_text(aes(label=paste0(Proportion,"%")))+
  theme(text=element_text(size=16, face="bold"))
  }}, width=1600, height=700 )



```

### **Use of mosquito nets:children**


```{r}

selectInput("nets_children", "",
              c("Residence"="Residence",
                "Endemicity zone"="Endemicity zone",
                "Wealth quintile"="Wealth quintile", "By County"="County"))
```

```{r, include=F}
# import data
children_itn_use <- fread("data/table_12/table12_6_children_ITN_use_by_background_xtics.csv")

children_itn_use$Value <- fct_relevel(children_itn_use$Value, 
                                    "Lowest", "Second", "Middle", "Fourth", "Highest")

children_itn_use_county <- fread("data/table_12/table12_6C_children_ITN_use_by_county.csv")

children_itn_use_county1 <- full_join(county, children_itn_use_county, by=c("Name"="County"))



```



```{r}

renderPlot({if(input$nets_children%in%c("Residence", "Endemicity zone")){ggplot(children_itn_use[children_itn_use$`Background characteristics`%in%input$nets_children,],aes(x=Value, y=Proportion,fill=Category))+
  geom_bar(position="dodge", stat="identity")+
  theme_bw()+
  labs( y="Proportion (%)", title="", x="Residence", fill="")+
  scale_fill_brewer(palette = "Set1")+
    geom_text(aes(label=paste0(Proportion,"%")), position=position_dodge(0.7))+
  theme(text=element_text(size=16, face="bold"))}
  else if(input$nets_children%in%"County"){
  ggplot(children_itn_use_county1)+
  geom_sf(data=children_itn_use_county1, aes(geometry=geometry), fill=NA)+
  geom_sf(aes(fill=Proportion),color="grey80", size=0.0)+
  theme_void()+
  facet_wrap(.~Category)+
  scale_fill_gradient(low = "white", high = "#8c2d04")+
  labs(x="", y="",fill="Proportion (%)")+
  theme(text=element_text(size=16, face="bold"))
  }
  else{
    ggplot(children_itn_use[children_itn_use$`Background characteristics`%in%input$nets_children,],aes(x=Value, y=Proportion,fill=Category))+
  geom_dotplot(binaxis='y', stackdir='center', binwidth = 4)+
  theme_bw()+
  labs( y="Proportion (%)", title="", x="Residence", fill="")+
  scale_fill_brewer(palette = "Set1")+
  geom_text(aes(label=paste0(Proportion,"%")))+
  theme(text=element_text(size=16, face="bold"))
  }}, width=1600, height=700 )



```

### **Use of mosquito nets:pregnant women**


```{r}

selectInput("nets_pregnant", "",
              c("Residence"="Residence",
                "Endemicity zone"="Endemicity zone",
                "Wealth quintile"="Wealth quintile"))
```

```{r, include=F}
# import data
women_itn_use <- fread("data/table_12/table12_7_women_ITN_use_by_background_xtics.csv")

women_itn_use$Value<- fct_relevel(women_itn_use$Value, 
                                    "Lowest", "Second", "Middle", "Fourth", "Highest")

```



```{r}

renderPlot({if(input$nets_pregnant%in%c("Residence", "Endemicity zone")){ggplot(women_itn_use[women_itn_use$`Background characteristics`%in%input$nets_pregnant,],aes(x=Value, y=Proportion, fill=Category))+
  geom_bar(position="dodge", stat="identity")+
  theme_bw()+
  labs( y="Proportion (%)", title="", x="Residence", fill="Household ITN ownership")+
  scale_fill_brewer(palette = "Set1")+
    geom_text(aes(label=paste0(Proportion,"%")),position=position_dodge(0.5),hjust=0.3)+
  theme(text=element_text(size=16, face="bold"))}
  else{
    ggplot(women_itn_use[women_itn_use$`Background characteristics`%in%input$nets_pregnant,],aes(x=Value, y=Proportion, fill=Category))+
  geom_dotplot(binaxis='y', stackdir='center', binwidth = 4)+
  theme_bw()+
  labs( y="Proportion (%)", title="", x="Residence", fill="")+
  scale_fill_brewer(palette = "Set1")+
  geom_text(aes(label=paste0(Proportion,"%")))+
  theme(text=element_text(size=16, face="bold"))
  }}, width=1600, height=700 )



```

### **Mosquito net not used previous night**

**Reason why the mosquito net was not used the night before the survey**



```{r}

selectInput("nets_notuse", "",
              c("Residence"="Residence",
                "Endemicity zone"="Endemicity zone",
                "Wealth quintile"="Wealth quintile", "By County"="County"))
```

```{r, include=F}
# import data
reason_itn_not_used <- fread("data/table_12/table12_8_reason_itn_not_used_by_background_xtics.csv")

reason_itn_not_used$Value<- fct_relevel(reason_itn_not_used$Value, 
                                    "Lowest", "Second", "Middle", "Fourth", "Highest")

reason_itn_not_used_county <- fread("data/table_12/table12_8C_reason_itn_not_used_by_county.csv")

reason_itn_not_used_county1 <- full_join(county, reason_itn_not_used_county, by=c("Name"="County"))



```



```{r}

renderPlot({if(input$nets_notuse%in%c("Residence", "Endemicity zone")){ggplot(reason_itn_not_used[reason_itn_not_used$`Background characteristics`%in%input$nets_notuse,],aes(x=reorder(Reason,Proportion), y=Proportion,fill=Value))+
  geom_bar(position="dodge", stat="identity")+
  theme_bw()+
  labs( y="Proportion (%)", title="", x="Residence", fill="")+
  scale_fill_brewer(palette = "Set1")+
    geom_text(aes(label=paste0(Proportion,"%")))+
  theme(text=element_text(size=16, face="bold"))}
  else if(input$nets_notuse%in%"County"){
  ggplot(reason_itn_not_used_county1)+
  geom_sf(data=reason_itn_not_used_county1, aes(geometry=geometry), fill=NA)+
  geom_sf(aes(fill=Proportion),color="grey80", size=0.0)+
  theme_void()+
  facet_wrap(.~Reason)+
  scale_fill_gradient(low = "white", high = "#8c2d04")+
  labs(x="", y="",fill="Proportion (%)")+
  theme(text=element_text(size=16, face="bold"))
  }
  else{
    ggplot(reason_itn_not_used[reason_itn_not_used$`Background characteristics`%in%input$nets_notuse,],aes(x=reorder(Reason,Proportion), y=Proportion,fill=Value))+
  geom_dotplot(binaxis='y', stackdir='center', binwidth = 4)+
  theme_bw()+
  labs( y="Proportion (%)", title="", x="Residence", fill="")+
  scale_fill_brewer(palette = "Set1")+
  geom_text(aes(label=paste0(Proportion,"%")))+
  theme(text=element_text(size=16, face="bold"))
  }}, width=1600, height=700 )



```

### **Intermittent Preventive Treatment by women during pregnancy**


```{r}

selectInput("ipt_women", "",
              c("Residence"="Residence",
                "Endemicity zone"="Endemicity zone",
                "Wealth quintile"="Wealth quintile", "By County"="County"))
```

```{r, include=F}
# import data
iptp <- fread("data/table_12/table12_9_iptp_by_background_xtics.csv")

iptp$Value<- fct_relevel(iptp$Value, 
                                    "Lowest", "Second", "Middle", "Fourth", "Highest")


iptp_county <- fread("data/table_12/table12_9C_iptp_by_county.csv")

iptp_county1 <- full_join(county, iptp_county, by=c("Name"="County"))



```



```{r}

renderPlot({if(input$ipt_women%in%c("Residence", "Endemicity zone")){ggplot(iptp[iptp$`Background characteristics`%in%input$ipt_women,],aes(x=Value, y=Proportion,fill=Category))+
  geom_bar(position="dodge", stat="identity")+
  theme_bw()+
  labs( y="Proportion (%)", title="", x="Residence", fill="")+
  scale_fill_brewer(palette = "Set1")+
    geom_text(aes(label=paste0(Proportion,"%")), position=position_dodge(0.7))+
  theme(text=element_text(size=16, face="bold"))}
  else if(input$ipt_women%in%"County"){
  ggplot(iptp_county1)+
  geom_sf(data=iptp_county1, aes(geometry=geometry), fill=NA)+
  geom_sf(aes(fill=Proportion),color="grey80", size=0.0)+
  theme_void()+
  facet_wrap(.~Category)+
  scale_fill_gradient(low = "white", high = "#8c2d04")+
  labs(x="", y="",fill="Proportion (%)")+
  theme(text=element_text(size=16, face="bold"))
  }
  else{
    ggplot(iptp[iptp$`Background characteristics`%in%input$ipt_women,],aes(x=Value, y=Proportion,fill=Category))+
  geom_dotplot(binaxis='y', stackdir='center', binwidth = 4)+
  theme_bw()+
  labs( y="Proportion (%)", title="", x="Residence", fill="")+
  scale_fill_brewer(palette = "Set1")+
  geom_text(aes(label=paste0(Proportion,"%")))+
  theme(text=element_text(size=16, face="bold"))
  }}, width=1600, height=700 )



```

### **Children with fever & careseeking \n prompt treatment & diagnosis**


```{r}

selectInput("mal_fever", "",
              c("Residence"="Residence",
                "Endemicity zone"="Endemicity zone",
                "Mother's education"="Mother's education",
                "Wealth quintile"="Wealth quintile", "By County"="County"))
```

```{r, include=F}
# import data
mal_fever <- fread("data/table_12/table12_10_malaria_fever_by_background_xtics.csv")

mal_fever$Value<- fct_relevel(mal_fever$Value, 
                                    "Lowest", "Second", "Middle", "Fourth", "Highest")

mal_fever_county <- fread("data/table_12/table12_10C_malaria_fever_by_county.csv")

mal_fever_county1 <- full_join(county, mal_fever_county, by=c("Name"="County"))


```



```{r}

renderPlot({if(input$mal_fever%in%c("Residence", "Endemicity zone")){ggplot(mal_fever[mal_fever$`Background characteristics`%in%input$mal_fever,],aes(x=Value, y=Proportion,fill=Category))+
  geom_bar(position="dodge", stat="identity")+
  theme_bw()+
  labs( y="Proportion (%)", title="", x="Residence", fill="")+
  scale_fill_brewer(palette = "Set1")+
    geom_text(aes(label=paste0(Proportion,"%")), position=position_dodge(0.7))+
  theme(text=element_text(size=16, face="bold"))}
  else if(input$mal_fever%in%"County"){
  ggplot(mal_fever_county1)+
  geom_sf(data=mal_fever_county1, aes(geometry=geometry), fill=NA)+
  geom_sf(aes(fill=Proportion),color="grey80", size=0.0)+
  theme_void()+
  facet_wrap(.~Category)+
  scale_fill_gradient(low = "white", high = "#8c2d04")+
  labs(x="", y="",fill="Proportion (%)")+
  theme(text=element_text(size=16, face="bold"))
  }
  else{
    ggplot(mal_fever[mal_fever$`Background characteristics`%in%input$mal_fever,],aes(x=Value, y=Proportion,fill=Category))+
  geom_dotplot(binaxis='y', stackdir='center', binwidth = 4)+
  theme_bw()+
  labs( y="Proportion (%)", title="", x="Residence", fill="")+
  scale_fill_brewer(palette = "Set1")+
  geom_text(aes(label=paste0(Proportion,"%")))+
  theme(text=element_text(size=16, face="bold"))
  }}, width=1600, height=700 )



```

### **Source of advice/treatment for children with fever**




```{r, include=F}
# import data
mal_treat_source <- fread("data/table_12/table12_11_malaria_treat_by_source.csv")


```



```{r}

renderPlot({ggplot(mal_treat_source, aes(x=reorder(`Source of Treatment`,`Proportion`), y=`Proportion`))+
  geom_bar(stat = "identity", fill="#74add1")+
  theme_bw()+
  labs( y="Proportion (%)", title="", x="Source of Treatment", fill="")+
  theme(text=element_text(size=16, face="bold"))+
  geom_text(aes(label = lab), nudge_y = 2.0)+
  coord_flip()}, width=1600, height=700 )



```


# TB/HIV {data-navmenu="Key Indicators"}

## Row {data-width="200"}

<br>

###  {.value-box}

```{r}

valueBox(
  value = paste("54%"),
  caption = "of women aged 15-24 had knowledge about HIV prevention",
  color = "black"
)

```

###  {.value-box}

```{r}
valueBox(
  value = paste("55%"),
  caption = "of men aged 15-24 had knowledge about HIV prevention",
  color = "#b15928"
)
```

<br>

## Column {.tabset .tabset-fade data-height="900"}

### **Knowledge & beliefs on HIV**

```{r}

selectInput("hiv_kap", "",
              c("Age"="Age",
                "Education"="Education",
                "Marital status"="Marital status",
                "Residence"="Residence"))


# import data

hiv_meds_kap <- fread("data/table_13/table13_1_HIV_meds_KAP_by_background_xtics.csv")

hiv_meds_kap$Value <- fct_relevel(hiv_meds_kap$Value, "No education", "Primary", "Secondary", "More than secondary")

renderPlot({if(input$hiv_kap%in%c("Age", "Education")){
  ggplot(hiv_meds_kap[hiv_meds_kap$`Background characteristics`%in%input$hiv_kap,],aes(x=`Value`, y=Proportion, fill=Category))+
  geom_dotplot(binaxis='y', stackdir='center', binwidth = 4)+
  theme_bw()+
  facet_wrap(~Participants)+
  labs( y="Proportion (%)", title="", x="", fill="")+
  scale_fill_manual(values = c("#d7191c","#fdae61","#ffffbf","#abd9e9"))+
  theme(text=element_text(size=16, face="bold"))+
    geom_text(aes(label=paste0(Proportion, "%")), position=position_dodge(0.6))
}
 else{
   ggplot(hiv_meds_kap[hiv_meds_kap$`Background characteristics`%in%input$hiv_kap,],aes(x=`Value`, y=Proportion, fill=Category))+
  geom_bar(position="dodge", stat="identity")+
  theme_bw()+coord_flip()+
  facet_wrap(~Participants)+
  labs( y="Proportion (%)", title="", x="", fill="")+
  scale_fill_manual(values = c("#d7191c","#fdae61","#ffffbf","#abd9e9"))+
  theme(text=element_text(size=16, face="bold"))+
     geom_text(aes(label=paste0(Proportion, "%")), position=position_dodge(0.6))
 } 
}, width=1600, height=700)

```

### **Knowledge on HIV prevention**

```{r}

selectInput("hiv", "",
              c("Knowledge about HIV prevention"="hivprevention_knowledge",
                "Limiting sexual intercourse to one uninfected partner"="limit_sex",
                "Using condoms"="using_condoms"))


# import data

hivc <- fread("data/table_23/table23_hiv_count_data.csv")

hivc_men <- full_join(county, hivc[hivc$Participants%in%"Men_15-24",], by=c("Name"="County"))
hivc_women <- full_join(county, hivc[hivc$Participants%in%"Women_15-24",], by=c("Name"="County"))
hivc1 <- rbind(hivc_men, hivc_women) %>%
  mutate(Participants=recode(Participants, "Men_15-24"="Men 15-24", "Women_15-24"="Women 15-24"))

hivc1$Participants <- fct_relevel(hivc1$Participants, "Women 15-24", "Men 15-24")

#visualization

renderGirafe({
  
  map1<- ggplot(hivc1[hivc1$indicators%in%input$hiv,])+
  geom_sf_interactive(aes(fill=values, tooltip=names1),color="grey80", size=0.0)+
  theme_void()+facet_grid(.~Participants)+
  scale_fill_gradient(low = "#fee6ce", high = "#7f2704")+
  labs(x="", y="",fill="Proportion")+
  theme(text=element_text(size=16))
  x <- girafe(ggobj = map1,
                   options = list(
                     opts_hover(css = "fill:#666666;cursor:pointer;"),
                     opts_selection(css = "fill:orange;", type = "multiple"),
                     opts_zoom(max = 4)), width=6, height=3)
    print(x)})


```

### **HIV testing**

```{r}

selectInput("hiv_test", "",
              c("Ever tested"="ever_tested",
                "Ever tested and received results"="recieved_results",
                "In the last 12 months, tested & received results"="received_results_last_test",
                "Never tested"="never_tested"))


# import data

hiv_testc <- fread("data/table_25/table25C .1 and .2_HIV_test_bind.csv")

hiv_testc1 <- full_join(county, hiv_testc, by=c("Name"="County")) 

#visualization

renderGirafe({
  
  map2<- ggplot(hiv_testc1[hiv_testc1$indicators%in%input$hiv_test,])+
  geom_sf_interactive(aes(fill=values, tooltip=names1),color="grey80", size=0.0)+
  theme_void()+facet_grid(.~Participants)+
  scale_fill_gradient(low = "#fee6ce", high = "#7f2704")+
  labs(x="", y="",fill="Proportion")+
  theme(text=element_text(size=14))
  x <- girafe(ggobj = map2,
                   options = list(
                     opts_hover(css = "fill:#666666;cursor:pointer;"),
                     opts_selection(css = "fill:orange;", type = "multiple"),
                     opts_zoom(max = 4)), width=6, height=3)
    print(x)})


```

# Chronic conditions {data-navmenu="Key Indicators"}

## Row {data-width="200"}

<br>

###  {.value-box}

```{r}

valueBox(
  value = paste("9.0%"),
  caption = "of women are diagnosed with high blood pressure/ hypertension",
  color = "black"
)

```

###  {.value-box}

```{r}
valueBox(
  value = paste("3.5%"),
  caption = "of men are diagnosed with high blood pressure/ hypertension",
  color = "#b15928"
)
```


## Column {.tabset .tabset-fade data-height="900"}

### **Blood pressure diagnosis and treatment**



```{r}

selectInput("bp", "",
              c("Age"="Age",
                "Education"="Education",
                "Residence"="Residence",
                "Wealth quintile"="Wealth quintile", "By County"="County"))
```

```{r, include=F}
# import data

bp <- fread("data/table_14/table14_1_BP_by_background_xtics.csv")

bp$Value <- fct_relevel(bp$Value, 
                                    "Lowest", "Second", "Middle", "Fourth", "Highest")

bp_county <- fread("data/table_14/table14_1C_BP_by_county.csv")

county <- st_read("shapefiles/County.shp")

bp_county1 <- full_join(county, bp_county, by=c("Name"="County"))

```



```{r}

renderPlot({if(input$bp%in%c("Residence", "Education")){ggplot(bp[bp$`Background characteristics`%in%input$bp,],aes(x=Value, y=Proportion,fill=Category))+
  geom_bar(position="dodge", stat="identity")+
  theme_bw()+
  facet_wrap(.~Participants)+
  labs( y="Proportion (%)", title="", x="", fill="")+
  scale_fill_brewer(palette = "Set1")+
    geom_text(aes(label=paste0(Proportion,"%")), position=position_dodge(0.7), vjust=0.3)+
  theme(text=element_text(size=16, face="bold"))}
  else if(input$bp%in%"County"){
  ggplot(bp_county1)+
  geom_sf(data=bp_county1, aes(geometry=geometry), fill=NA)+
  geom_sf(aes(fill=Proportion),color="grey80", size=0.0)+
  theme_void()+
  facet_wrap(.~Participants)+
  scale_fill_gradient(low = "white", high = "#8c2d04")+
  labs(x="", y="",fill="Proportion (%)")+
  theme(text=element_text(size=16, face="bold"))
  }
  else{
    ggplot(bp[bp$`Background characteristics`%in%input$bp,],aes(x=Value, y=Proportion,fill=Category))+
  geom_dotplot(binaxis='y', stackdir='center', binwidth = 4)+
  theme_bw()+
  labs( y="Proportion (%)", title="", x="", fill="")+
  scale_fill_brewer(palette = "Set1")+
  facet_wrap(.~Participants)+
  geom_text(aes(label=paste0(Proportion,"%")))+
  theme(text=element_text(size=16, face="bold"))
  }}, width=1600, height=700 )



```

### **Blood sugar diagnosis and treatment**


```{r}

selectInput("bld_sugar", "",
              c("Age"="Age",
                "Education"="Education",
                "Residence"="Residence",
                "Wealth quintile"="Wealth quintile"))
```

```{r, include=F}
# import data

bld_sugar <- fread("data/table_14/table14_2_Blood_Sugar_by_background_xtics.csv")

bld_sugar$Value <- fct_relevel(bld_sugar$Value, 
                                    "Lowest", "Second", "Middle", "Fourth", "Highest")

```



```{r}

renderPlot({if(input$bld_sugar%in%c("Residence", "Education")){ggplot(bld_sugar[bld_sugar$`Background characteristics`%in%input$bld_sugar,],aes(x=Value, y=Proportion,fill=Category))+
  geom_bar(position="dodge", stat="identity")+
  theme_bw()+
  facet_wrap(.~Participants)+
  labs( y="Proportion (%)", title="", x="", fill="")+
  scale_fill_brewer(palette = "Set1")+
    geom_text(aes(label=paste0(Proportion,"%")), position=position_dodge(0.7), vjust=0.2)+
  theme(text=element_text(size=16, face="bold"))}
  else{
    ggplot(bld_sugar[bld_sugar$`Background characteristics`%in%input$bld_sugar,],aes(x=Value, y=Proportion,fill=Category))+
  geom_dotplot(binaxis='y', stackdir='center', binwidth = 4)+
  theme_bw()+
  labs( y="Proportion (%)", title="", x="", fill="")+
  scale_fill_brewer(palette = "Set1")+
  facet_wrap(.~Participants)+
  geom_text(aes(label=paste0(Proportion,"%")))+
  theme(text=element_text(size=16, face="bold"))
  }}, width=1600, height=700 )



```

### **Depression diagnosis and treatment**


```{r}

selectInput("depression", "",
              c("Age"="Age",
                "Education"="Education",
                "Residence"="Residence",
                "Wealth quintile"="Wealth quintile", "By County"="County"))
```

```{r, include=F}
# import data

depression <- fread("data/table_14/table14_5_Depression_by_background_xtics.csv")


depression$Value<- fct_relevel(depression$Value, 
                                    "Lowest", "Second", "Middle", "Fourth", "Highest")

depression_county <- fread("data/table_14/table14_5C_Depression_by_county.csv")

depression_county1 <- full_join(county, depression_county, by=c("Name"="County"))

```



```{r}

renderPlot({if(input$depression%in%c("Residence", "Education")){ggplot(depression[depression$`Background characteristics`%in%input$depression,],aes(x=Value, y=Proportion,fill=Category))+
  geom_bar(position="dodge", stat="identity")+
  theme_bw()+
  facet_wrap(.~Participants)+
  labs( y="Proportion (%)", title="", x="", fill="")+
  scale_fill_brewer(palette = "Set1")+
    geom_text(aes(label=paste0(Proportion,"%")), position=position_dodge(0.7), vjust=0.2)+
  theme(text=element_text(size=16, face="bold"))}
  else if(input$depression%in%"County"){
  ggplot(depression_county1)+
  geom_sf(data=depression_county1, aes(geometry=geometry), fill=NA)+
  geom_sf(aes(fill=Proportion),color="grey80", size=0.0)+
  theme_void()+
  facet_wrap(Category~Participants)+
  scale_fill_gradient(low = "white", high = "#8c2d04")+
  labs(x="", y="",fill="Proportion (%)")+
  theme(text=element_text(size=16, face="bold"))
  }
  else{
    ggplot(depression[depression$`Background characteristics`%in%input$depression,],aes(x=Value, y=Proportion,fill=Category))+
  geom_dotplot(binaxis='y', stackdir='center', binwidth = 4)+
  theme_bw()+
  labs( y="Proportion (%)", title="", x="", fill="")+
  scale_fill_brewer(palette = "Set1")+
  facet_wrap(.~Participants)+
  geom_text(aes(label=paste0(Proportion,"%")))+
  theme(text=element_text(size=16, face="bold"))
  }}, width=1600, height=700 )



```

### **Arthritis diagnosis and treatment**


```{r}

selectInput("arthritis", "",
              c("Age"="Age",
                "Education"="Education",
                "Residence"="Residence",
                "Wealth quintile"="Wealth quintile", "By County"="County"))
```

```{r, include=F}
# import data

arthritis <- fread("data/table_14/table14_6_Arthritis_by_background_xtics.csv")

arthritis$Value<- fct_relevel(arthritis$Value, 
                                    "Lowest", "Second", "Middle", "Fourth", "Highest")

arthritis_county <- fread("data/table_14/table14_6C_Arthritis_by_county.csv")



arthritis_county1 <- full_join(county, arthritis_county, by=c("Name"="County"))

```



```{r}

renderPlot({if(input$arthritis%in%c("Residence", "Education")){ggplot(arthritis[arthritis$`Background characteristics`%in%input$arthritis,],aes(x=Value, y=Proportion,fill=Category))+
  geom_bar(position="dodge", stat="identity")+
  theme_bw()+
  facet_wrap(.~Participants)+
  labs( y="Proportion (%)", title="", x="", fill="")+
  scale_fill_brewer(palette = "Set1")+
    geom_text(aes(label=paste0(Proportion,"%")), position=position_dodge(0.7), vjust=0.2)+
  theme(text=element_text(size=16, face="bold"))}
  else if(input$arthritis%in%"County"){
  ggplot(arthritis_county1)+
  geom_sf(data=arthritis_county1, aes(geometry=geometry), fill=NA)+
  geom_sf(aes(fill=Proportion),color="grey80", size=0.0)+
  theme_void()+
  facet_wrap(Category~Participants)+
  scale_fill_gradient(low = "white", high = "#8c2d04")+
  labs(x="", y="",fill="Proportion (%)")+
  theme(text=element_text(size=16, face="bold"))
  }
  else{
    ggplot(arthritis[arthritis$`Background characteristics`%in%input$arthritis,],aes(x=Value, y=Proportion,fill=Category))+
  geom_dotplot(binaxis='y', stackdir='center', binwidth = 4)+
  theme_bw()+
  labs( y="Proportion (%)", title="", x="", fill="")+
  scale_fill_brewer(palette = "Set1")+
  facet_wrap(.~Participants)+
  geom_text(aes(label=paste0(Proportion,"%")))+
  theme(text=element_text(size=16, face="bold"))
  }}, width=1600, height=700 )



```

### **Physical activity**


```{r}

selectInput("physical_activity", "",
              c("Age"="Age",
                "Education"="Education",
                "Residence"="Residence",
                "Wealth quintile"="Wealth quintile", "By County"="County"))
```

```{r, include=F}
# import data

physical_activity <- fread("data/table_14/table14_7_Physical_activity_by_background_xtics.csv")

physical_activity$Value<- fct_relevel(physical_activity$Value, 
                                    "Lowest", "Second", "Middle", "Fourth", "Highest")

physical_activity_county <- fread("data/table_14/table14_7C_Physical_activity_by_county.csv")

physical_activity_county1 <- full_join(county, physical_activity_county, by=c("Name"="County"))

```



```{r}

renderPlot({if(input$physical_activity%in%c("Residence", "Education")){ggplot(physical_activity[physical_activity$`Background characteristics`%in%input$physical_activity,],aes(x=Value, y=`Activity time`))+
  geom_bar(position="dodge", stat="identity", fill="#74add1")+
  theme_bw()+
  facet_wrap(.~Participants)+
  labs( y="Minutes", title="", x="", fill="")+
  scale_fill_brewer(palette = "Set1")+
    geom_text(aes(label=paste0(`Activity time`,"mins")), position=position_dodge(0.7), vjust=0.2)+
  theme(text=element_text(size=16, face="bold"))}
  else if(input$physical_activity%in%"County"){
  ggplot(physical_activity_county1)+
  geom_sf(data=physical_activity_county1, aes(geometry=geometry), fill=NA)+
  geom_sf(aes(fill=`Activity time`),color="grey80", size=0.0)+
  theme_void()+
  facet_wrap(~Participants)+
  scale_fill_gradient(low = "white", high = "#8c2d04")+
  labs(x="", y="",fill="Minutes")+
  theme(text=element_text(size=16, face="bold"))
  }
  else{
    ggplot(physical_activity[physical_activity$`Background characteristics`%in%input$physical_activity,],aes(x=Value, y=`Activity time`))+
  geom_dotplot(binaxis='y', stackdir='center', binwidth = 4,fill="#74add1")+
  theme_bw()+
  labs( y="Proportion (%)", title="", x="", fill="")+
  scale_fill_brewer(palette = "Set1")+
  facet_wrap(.~Participants)+
  geom_text(aes(label=paste0(`Activity time`,"mins")))+
  theme(text=element_text(size=16, face="bold"))
  }}, width=1600, height=700 )



```

### **Examinations for breast & cervical cancer**


```{r}

selectInput("breast_cancer", "",
              c("Age"="Age",
                "Education"="Education",
                "Residence"="Residence",
                "Wealth quintile"="Wealth quintile", "By County"="County"))
```

```{r, include=F}
# import data

breast_cancer <- fread("data/table_14/table9_19a_Breast_cancer_by_background_xtics.csv")


breast_cancer$Value <- fct_relevel(breast_cancer$Value, 
                                    "Lowest", "Second", "Middle", "Fourth", "Highest")

breast_cancer_county <- fread("data/table_14/table9_19Ca_Breast_cancer_by_county.csv")

breast_cancer_county1 <- full_join(county, breast_cancer_county, by=c("Name"="County"))

```



```{r}

renderPlot({if(input$breast_cancer%in%c("Residence", "Education")){ggplot(breast_cancer[breast_cancer$`Background characteristics`%in%input$breast_cancer,],aes(x=Value, y=Proportion,fill=Category))+
  geom_bar(position="dodge", stat="identity")+
  theme_bw()+
  labs( y="Proportion (%)", title="", x="", fill="")+
  scale_fill_brewer(palette = "Set1")+
    geom_text(aes(label=paste0(Proportion,"%")), position=position_dodge(0.7), vjust=0.2)+
  theme(text=element_text(size=16, face="bold"))}
  else if(input$breast_cancer%in%"County"){
  ggplot(breast_cancer_county1)+
  geom_sf(data=breast_cancer_county1, aes(geometry=geometry), fill=NA)+
  geom_sf(aes(fill=Proportion),color="grey80", size=0.0)+
  theme_void()+
  facet_wrap(~Category)+
  scale_fill_gradient(low = "white", high = "#8c2d04")+
  labs(x="", y="",fill="Proportion (%)")+
  theme(text=element_text(size=16, face="bold"))
  }
  else{
    ggplot(breast_cancer[breast_cancer$`Background characteristics`%in%input$breast_cancer,],aes(x=Value, y=Proportion,fill=Category))+
  geom_dotplot(binaxis='y', stackdir='center', binwidth = 4)+
  theme_bw()+
  labs( y="Proportion (%)", title="", x="", fill="")+
  scale_fill_brewer(palette = "Set1")+
  geom_text(aes(label=paste0(Proportion,"%")))+
  theme(text=element_text(size=16, face="bold"))
  }}, width=1600, height=700 )



```

# Women empowerment {data-navmenu="Key Indicators"}

## Row {data-width="200"}

<br>

###  {.value-box}

```{r}

valueBox(
  value = paste("4.5%"),
  caption = "Of women own a house alone",
  color = "black"
)
```

###  {.value-box}

```{r}
valueBox(
  value = paste("36%"),
  caption = "of men own a house alone",
  color = "#b15928"
)
```

###  {.value-box}

```{r}

valueBox(
  value = paste("3%"),
  caption = "of women own agricultural land alone",
  color = "darkgreen"
)
```

###  {.value-box}

```{r}
valueBox(
  value = paste("26%"),
  caption = "of men own agricultural land alone",
  color = "darkblue"
)
```

## Column {.tabset .tabset-fade data-height="900"}

### **Employment & cash earnings**




```{r, include=F}
# import data

T15.1 <- fread("data/table_15/table_15_1_employment_and_cash_earnings_of_currently_married_women_and_men.csv")

```



```{r}

renderPlot({T15.1 %>%
  filter(is.na(value) == FALSE) %>%
  ggplot(aes(y=value, x=Age, fill=variable)) +
  geom_dotplot(binaxis = "y", stackdir = "center", binwidth = 6) +
    theme_bw()+scale_fill_brewer(palette = "Set1")+geom_text(aes(label=paste0(value,"%")))+
  facet_wrap(~Gender)+ labs(y = "%", x = "Age", fill="")+
    theme(text=element_text(size=16, face="bold")) }, width=1600, height=700 )



```


### **Control over men's cash**



```{r}

selectInput("control", "",
              c("Age"="Age",
                "Education"="Education",
                "Residence"="Residence",
                "Number of living children"="Number of living children",
                "Wealth quintile"="Wealth quintile"))
```

```{r, include=F}
# import data

T15.2.2 <- fread("data/table_15/table_15_2_2_control_over_mens_cash_earnings.csv", na.strings=c("*"))%>%
  mutate(value=as.numeric(value))

T15.2.2$Category<- fct_relevel(T15.2.2$Category, 
                                    "Lowest", "Second", "Middle", "Fourth", "Highest")

```



```{r}

renderPlot({if(input$control%in%c("Residence", "Education", "Residence", "Number of living children")){ggplot(T15.2.2[T15.2.2$`Background characteristics`%in%input$control,],aes(x=Category, y=value,fill=variable))+
  geom_bar(position="dodge", stat="identity")+
  theme_bw()+
  facet_wrap(.~Gender)+
  labs( y="Proportion (%)", title="", x="", fill="")+
  scale_fill_brewer(palette = "Set1")+
    geom_text(aes(label=paste0(value,"%")), position=position_dodge(0.7), vjust=0.2)+
  theme(text=element_text(size=16, face="bold"))}
  else{
    ggplot(T15.2.2[T15.2.2$`Background characteristics`%in%input$control,],aes(x=Category, y=value,fill=variable))+
  geom_dotplot(binaxis='y', stackdir='center', binwidth = 4)+
  theme_bw()+
  labs( y="Proportion (%)", title="", x="", fill="")+
  scale_fill_brewer(palette = "Set1")+
  facet_wrap(.~Gender)+
  geom_text(aes(label=paste0(value,"%")))+
  theme(text=element_text(size=16, face="bold"))
  }}, width=1600, height=700 )



```

### **House & land ownership**


```{r}

selectInput("home_own", "",
              c("House Ownership"="House Ownership",
                "Agricultural Land Ownership"="Agricultural Land Ownership",
                "Non-Agricultural Land Ownership"="Non-Agricultural Land Ownership"))

house_land_ownsership <- fread('data/table_15/table_15.3.1_&_table_15.3.2_House_and_Land_ownership.csv')

renderPlot({ggplot(house_land_ownsership[house_land_ownsership$`Background characteristics`%in%input$home_own,],aes(y = Category, x=value, fill = variable)) + 
  geom_col(  position = 'dodge')+facet_grid(~Gender)+
    geom_text(aes(label=paste0(round(value),"%")), position=position_dodge(0.7),vjust=-1)+
  scale_fill_brewer(palette = "Set1")+
  theme_bw()+
  labs(x ='Proportion (%)', y ="", fill="")+
  theme(text = element_text(size=16, face="bold"))}, width=1500, height=800)

```

### **Agricultural land ownership**


```{r, message=F}

selectInput("agric_own", "",
              c("Age"="Age",
                "Education attainment"="Education",
                "Residence"="Residence",
                "Wealth quintile"="Wealth quintile",
                "By County"="County"))

```

```{r, include=F}
# agricultural land ownership

Agricultural_land_ownsership <- fread('data/table_15/table_15.5.1_&_table_15.5.3_Agicultural_Land_ownership.csv') 

agricultural_land_ownsership_county <- fread('data/table_15/Table_15.5.1C&15.5.3CAgricultural _and_ownership_county.csv') %>%
  mutate(variable=recode(variable, "Does.not.have.a.title.deed"="Does not have \na title deed"))

Agricultural_land_ownsership$Category <- fct_relevel(Agricultural_land_ownsership$Category, "No education", "Primary", "Secondary", "More than secondary",
                                   "Lowest", "Second", "Middle", "Fourth", "Highest")

agricultural_land_ownsership_county <- full_join(agricultural_land_ownsership_county, county, by = c('County'='Name')) 

```

```{r}
renderPlot({if(input$agric_own!="County"){ggplot(Agricultural_land_ownsership[Agricultural_land_ownsership$`Background characteristics`%in%input$agric_own,],mapping=aes(y=value, x=Category)) +
  geom_col(position="dodge",fill="#abd9e9") + geom_text(aes(label=paste0(value,"%")), position=position_dodge(0.7), vjust=-1)+
  facet_grid(Gender~variable) + 
  theme_bw() +coord_flip()+
  labs( x = "", y="%", fill="")+theme(text=element_text(size=20, face="bold"))}
  else{
    ggplot(agricultural_land_ownsership_county,aes(fill=abs(value), geometry=geometry)) +
  geom_sf()+
 facet_grid(Gender~variable, labeller = label_wrap_gen()) +
 theme_void()+scale_fill_gradient(low="#ffffcc", high="#bd0026", na.value = "white")+
 labs(fill="%")+
  theme(text=element_text(size=25),axis.title=element_text(size=14,face="bold"))
  
  }}, width=1500, height=700)

```


### **Non-agricultural land ownership**


```{r, message=F}

selectInput("nonagric_own", "",
              c("Age"="Age",
                "Education attainment"="Education",
                "Residence"="Residence",
                "Wealth quintile"="Wealth quintile",
                "By County"="County"))

```

```{r, include=F}
# agricultural land ownership

non_agricultural_land_ownsership <- fread('data/table_15/table_15.5.2_&_table_15.5.4_Longformat.csv') 

non_agricultural_land_ownsership_county <- fread('data/table_15/Table_15.52C&15.5.3C_ Non_agricultural_land_ownership _county.csv') %>%
  mutate(variable=recode(variable, "Does not have a title deed"="Does not have \na title deed"))

non_agricultural_land_ownsership$Category <- fct_relevel(non_agricultural_land_ownsership$Category, "No education", "Primary", "Secondary", "More than secondary",
                                   "Lowest", "Second", "Middle", "Fourth", "Highest")
non_agricultural_land_ownsership_county <- full_join(non_agricultural_land_ownsership_county, county, by = c('County'='Name')) %>%
  filter(!is.na(variable))

```

```{r}
renderPlot({if(input$nonagric_own!="County"){ggplot(non_agricultural_land_ownsership[non_agricultural_land_ownsership$`Background characteristics`%in%input$nonagric_own,],mapping=aes(y=value, x=Category)) +
  geom_col(position="dodge", fill="#abd9e9") + geom_text(aes(label=paste0(value,"%")), position=position_dodge(0.7), vjust=-0.5)+
  facet_grid(Gender~variable) + 
  theme_bw() +coord_flip()+
  labs( x = "", y="%", fill="")+theme(text=element_text(size=20, face="bold"))}
  else{
    ggplot(non_agricultural_land_ownsership_county ,aes(fill= abs(value), geometry=geometry)) +
  geom_sf()+
 facet_grid(Gender~variable, labeller = label_wrap_gen()) +
 theme_void()+scale_fill_gradient(low="#ffffcc", high="#bd0026", na.value = "white")+
 labs(fill="%") +
  theme(text=element_text(size=25),axis.title=element_text(size=14,face="bold"))
  }}, width=1500, height=700)

```


### **Ownership & use of mobile phones & bank accounts**


```{r, message=F}

selectInput("mobile", "",
              c("Age"="Age",
                "Education attainment"="Education",
                "Residence"="Residence",
                "Wealth quintile"="Wealth quintile",
                "By County"="County"))

```

```{r, include=F}


T15.6.1 <- fread("data/table_15/Table_15_6_1_ownership_and_use_of_mobile_phones_and_bank_accounts.csv") 

T15.6.1C <- fread("data/table_15/Table_15_6_1_ownership_and_use_of_mobile_phones_and_bank_accounts_map.csv") 

T15.6.1C <- full_join(county, T15.6.1C, by=c("Name"="County")) 

T15.6.1$Category <- fct_relevel(T15.6.1$Category, "No education", "Primary", "Secondary", "More than secondary",
                                   "Lowest", "Second", "Middle", "Fourth", "Highest")
```

```{r}
renderPlot({if(input$mobile!="County"){ggplot(T15.6.1[T15.6.1$`Background characteristics`%in%input$mobile,],aes(y=value, x=Category)) +
  geom_col(position="dodge", fill="#abd9e9") + geom_text(aes(label=paste0(value,"%")), position=position_dodge(0.7), vjust=-0.5)+
  facet_grid(Gender~variable) + 
  theme_bw() +coord_flip()+
  labs( x = "", y="%", fill="")+theme(text=element_text(size=20, face="bold"))}
  else{
    ggplot(T15.6.1C ,aes(fill= abs(value), geometry=geometry)) +
  geom_sf()+
 facet_grid(Gender~variable, labeller = label_wrap_gen()) +
 theme_void()+scale_fill_gradient(low="#ffffcc", high="#bd0026", na.value = "white")+
 labs(fill="%") +
  theme(text=element_text(size=25),axis.title=element_text(size=14,face="bold"))
  }}, width=1500, height=700)

```


### **Participation in decision making**


```{r, message=F}

selectInput("decision_making", "",
              c("Age"="Age",
                "Education attainment"="Education",
                "Employment (last 12 months)"="Employment (last 12 months)",
                "Residence"="Residence",
                "Number of living children"="Number of living children",
                "Wealth quintile"="Wealth quintile",
                "By County"="County"))

```

```{r, include=F}
# agricultural land ownership


decision_making <- fread("data/table_15/Table_15_8_2_participation_in_decision_making.csv") 


decision_making$Category<- fct_relevel(decision_making$Category, 
                                    "Lowest", "Second", "Middle", "Fourth", "Highest")
decision_making_county <- fread("data/table_15/Table_15_8_2C_participation_in_decision_making_map.csv") %>%
  mutate(variable=recode(variable, "Making major household purchases"="Making major \nhousehold purchases", "Visits to her family or relatives"="Visits to her family \nor relatives"))

decision_making_county1 <- full_join(county, decision_making_county, by=c("Name"="County")) 
  
```

```{r}
renderPlot({if(input$decision_making!="County"){ggplot(decision_making[decision_making$`Background characteristics`%in%input$decision_making,],aes(y=value, x=Category)) +
  geom_col(position="dodge", fill="cyan3") + geom_text(aes(label=paste0(value,"%")), position=position_dodge(0.7), vjust=-0.5)+
  facet_grid(Gender~variable, scales="free") + 
  theme_bw() +coord_flip()+
  labs( x = "", y="%", fill="")+theme(text=element_text(size=20, face="bold"))}
  else{
    ggplot(decision_making_county1 ,aes(fill= abs(value))) +
  geom_sf()+
 facet_grid(Gender~variable, labeller = label_wrap_gen()) +
 theme_void()+scale_fill_gradient(low="#ffffcc", high="#bd0026", na.value = "white")+
 labs(fill="%") +
  theme(text=element_text(size=25),axis.title=element_text(size=14,face="bold"))
  }}, width=1500, height=700)

```


### **Attitude towards negotiating safer sexual relations**


```{r, message=F}

selectInput("safer_sex", "",
              c("Age"="Age",
                "Education attainment"="Education",
                "Marital status"="Marital status",
                "Residence"="Residence",
                "Wealth quintile"="Wealth quintile",
                "By County"="County"))

```

```{r, include=F}
# agricultural land ownership


T15.10 <- fread("data/table_15/Table_15_10_attitudes_toward_negotiating_safer_sexual_relations_with_husband.csv")


T15.10$Category<- fct_relevel(T15.10$Category, 
                                    "Lowest", "Second", "Middle", "Fourth", "Highest")

T15.10C <- fread("data/table_15/Table_15_10C_attitudes_toward_negotiating_safer_sexual_relations_with_husband_map.csv") 


T15.10C <- full_join(county, T15.10C, by=c("Name"="County")) 
```


```{r}
renderPlot({if(input$safer_sex!="County"){ggplot(T15.10[T15.10$`Background characteristics`%in%input$safer_sex,],aes(y=value, x=Category, fill=variable)) +
  geom_col(position="dodge") + geom_text(aes(label=paste0(value,"%")), position=position_dodge(0.7), vjust=-0.5)+
  facet_grid(~Gender, scales="free") + 
  theme_bw() +scale_fill_brewer(palette = "Set1")+
  labs( x = "", y="%", fill="")+theme(text=element_text(size=20, face="bold"))}
  else{
    ggplot(T15.10C ,aes(fill= abs(value))) +
  geom_sf()+
 facet_grid(Gender~variable, labeller = label_wrap_gen()) +
 theme_void()+scale_fill_gradient(low="#ffffcc", high="#bd0026", na.value = "white")+
 labs(fill="%") +
  theme(text=element_text(size=25),axis.title=element_text(size=14,face="bold"))
  }}, width=1500, height=700)

```


# Domestic/ Gender violence {data-navmenu="Key Indicators"}

## Row {data-width="200"}

<br>

###  {.value-box}

```{r}

valueBox(
  value = paste("34%"),
  caption = "of women have experienced physical violence since age 15",
  color = "black"
)
```

###  {.value-box}

```{r}
valueBox(
  value = paste("3.5%"),
  caption = "of women have often experienced physical violence in the last 12 months",
  color = "#b15928"
)
```

<br>

## Column {.tabset .tabset-fade data-height="900"}

### **Experience physical violence**

```{r}

selectInput("physical_violence", "",
              c("Age"="Age",
                "Education attainment"="Education",
                "Marital status"="Marital Status",
                "Residence"="Residence",
                "Wealth quintile"="Wealth quintile",
                "By County"="County"))
```

```{r, include=F}
#import data
physical_violence <- fread('data/table_17/table_17.1_Experience_pysical_violence.csv')

physical_violence_county <- fread('data/table_17/Table 17.1C Experience of physical violence by any perpetrator according to county.csv')

county <- st_read("shapefiles/County.shp")

physical_violence_county <- full_join(physical_violence_county, county, by = c('County'='Name')) 

physical_violence$Category <- fct_relevel(physical_violence$Category, "No education", "Primary", "Secondary", "More than secondary",
                                   "Lowest", "Second", "Middle", "Fourth", "Highest")

```

```{r}

renderPlot({if(input$physical_violence!="County"){ggplot(physical_violence[physical_violence$`Background characteristics`%in%input$physical_violence,],aes(y=value, x=Category, fill=variable)) + coord_flip()+
  geom_col(position="dodge") + geom_text(aes(label=paste0(value,"%")), position=position_dodge(0.7), vjust=-0.5)+
  facet_grid(~Gender, scales="free") + 
  theme_bw() +scale_fill_brewer(palette = "Set1")+
  labs( x = "", y="%", fill="")+theme(text=element_text(size=20, face="bold"))}
  else{
    ggplot(physical_violence_county ,aes(fill= abs(value))) +
  geom_sf()+
 facet_grid(Gender~variable, labeller = label_wrap_gen()) +
 theme_void()+scale_fill_gradient(low="#ffffcc", high="#bd0026", na.value = "white")+
 labs(fill="%") +
  theme(text=element_text(size=25),axis.title=element_text(size=14,face="bold"))
  }}, width=1500, height=700)



```


### **Person commiting physical violence**

```{r}

selectInput("viol","",
            c("Male"="Male",
            "Female"="Female"))

pers_physical_violence <- fread('data/table_17/table_17.2_person_commiting_physical_violence.csv') 

renderPlot({ggplot(pers_physical_violence[pers_physical_violence$Gender%in%input$viol,],aes(y=value, x=reorder(Category,value), fill=variable)) +coord_flip()+
  geom_col(position="dodge") + geom_text(aes(label=paste0(value,"%")), position=position_dodge(0.7), vjust=-0.5)+
  theme_bw() +scale_fill_brewer(palette = "Set1")+
  labs( x = "", y="%", fill="")+theme(text=element_text(size=20, face="bold"))
  }, width=1500, height=700)



```



### **Experience violence during pregnancy**

```{r}

selectInput("violence_preg", "",
              c("Age"="Age",
                "Education attainment"="Education",
                "Marital status"="Marital status",
                "Number of living children"="Number of living children",
                "Residence"="Residence",
                "Wealth quintile"="Wealth quintile",
                "By County"="County"))
```

```{r, include=F}
#import data
violence_preg <- fread('data/table_17/table 17.3 Experience of violence during pregnancy_longformat.csv')

violence_preg_county <- fread('data/table_17/Table 17.3C Experience of violence during pregnancy.csv')



violence_preg_county <- full_join(county, violence_preg_county, by=c("Name"="County"))

violence_preg$Category <- fct_relevel(violence_preg$Category, "No education", "Primary", "Secondary", "More than secondary",
                                   "Lowest", "Second", "Middle", "Fourth", "Highest")

```

```{r}

renderPlot({if(input$violence_preg!="County"){ggplot(violence_preg[violence_preg$`Background characteristics`%in%input$violence_preg,],aes(y=value, x=Category)) +
  geom_col(position="dodge", fill="cyan3") + geom_text(aes(label=paste0(value,"%")), position=position_dodge(0.7), vjust=-0.5)+
  theme_bw() +scale_fill_brewer(palette = "Set1")+
  labs( x = "", y="%", fill="")+theme(text=element_text(size=20, face="bold"))}
  else if(input$violence_preg%in%"Marital status"){ggplot(violence_preg[violence_preg$`Background characteristics`%in%input$violence_preg,],aes(y=value, x=Category, fill=variable)) +coord_flip()+
  geom_col(position="dodge", fill="cyan3") + geom_text(aes(label=paste0(value,"%")), position=position_dodge(0.7), vjust=-0.5)+
  theme_bw() +scale_fill_brewer(palette = "Set1")+coord_flip()+
  labs( x = "", y="%", fill="")+theme(text=element_text(size=20, face="bold"))}
  else{
    ggplot(violence_preg_county ,aes(fill= abs(value))) +
  geom_sf()+
 facet_grid(~variable, labeller = label_wrap_gen()) +
 theme_void()+scale_fill_gradient(low="#ffffcc", high="#bd0026", na.value = "white")+
 labs(fill="%") +
  theme(text=element_text(size=25),axis.title=element_text(size=14,face="bold"))
  }}, width=1500, height=700)



```


### **Experience sexual violence**

```{r}

selectInput("violence_sexual", "",
              c("Age"="Age",
                "Education attainment"="Education",
                "Marital Status"="Marital Status",
                "Employment"="Employment",
                "Residence"="Residence",
                "Wealth quintile"="Wealth quintile",
                "By County"="County"))
```

```{r, include=F}
#import data
sexual_violence <- fread('data/table_17/table_17.4_experience_sexual_violence.csv')


experience_sexual_violence_county <- fread('data/table_17/Table 17.4C Experience of sexual violence by any perpetrator according to county.csv') 

experience_sexual_violence_county <- full_join(county, experience_sexual_violence_county, by = c('Name'='County')) 
sexual_violence$Category <- fct_relevel(sexual_violence$Category, "No education", "Primary", "Secondary", "More than secondary",
                                   "Lowest", "Second", "Middle", "Fourth", "Highest")

```

```{r}

renderPlot({if(input$violence_sexual%in%c("Age","Education","Employment","Residence","Wealth quintile" )){ggplot(sexual_violence[sexual_violence$`Background characteristics`%in%input$violence_sexual,],aes(y=value, x=Category, fill=variable)) +
  geom_col(position="dodge") + geom_text(aes(label=paste0(value,"%")), position=position_dodge(0.7), vjust=-0.5)+
  theme_bw() +scale_fill_brewer(palette = "Set1")+
    facet_grid(~Gender)+
  labs( x = "", y="%", fill="")+theme(text=element_text(size=20, face="bold"))}
  else if(input$violence_sexual%in%"Marital Status"){ggplot(sexual_violence[sexual_violence$`Background characteristics`%in%input$violence_sexual,],aes(y=value, x=Category, fill=variable)) +
  geom_col(position="dodge") + geom_text(aes(label=paste0(value,"%")), position=position_dodge(0.7), vjust=-0.5)+
  theme_bw() +scale_fill_brewer(palette = "Set1")+coord_flip()+facet_grid(~Gender)+
  labs( x = "", y="%", fill="")+theme(text=element_text(size=20, face="bold"))}
  else{
    ggplot(experience_sexual_violence_county ,aes(fill= abs(value), geometry=geometry)) +
  geom_sf()+
 facet_grid(Gender~variable, labeller = label_wrap_gen()) +
 theme_void()+scale_fill_gradient(low="#ffffcc", high="#bd0026", na.value = "white")+
 labs(fill="%") +
  theme(text=element_text(size=25),axis.title=element_text(size=14,face="bold"))
  }}, width=1500, height=700)



```

### **Persons committing sexual violence**


```{r, include=F}
#import data
sexual_violence1 <- fread('data/table_17/table_17.2_person_commiting_physical_violence.csv')

```

```{r}

renderPlot({ggplot(sexual_violence1,aes(y=value, x=Category, fill=variable)) +
  geom_col(position="dodge") + geom_text(aes(label=paste0(value,"%")), position=position_dodge(0.7), vjust=-0.5)+
  theme_bw() +scale_fill_brewer(palette = "Set1")+
    facet_grid(~Gender)+coord_flip()+
  labs( x = "", y="%", fill="")+theme(text=element_text(size=20, face="bold"))}, width=1500, height=700)



```

### **Forms of controlling behaviors and intimate-partner violence**

```{r}

selectInput("controlling", "",
              c("Controlling behavior"="Controlling behavior",
                "Economic violence"="Economic violence",
                "Intimate-partner violence perpetrated by any current/previous spouse/intimate partner"="Intimate-partner violence perpetrated by any current or previous spouse or intimate partner",
                "Physical violence"="Physical violence",
                "Psychological/emotional violence"="Psychological/emotional violence",
                "Sexual violence"="Sexual violence"))
```

```{r, include=F}
#import data
controlling <- fread('data/table_17/Table_17_9_2_forms_of_controlling_behaviors_and_intimate-partner_violence.csv')
```

```{r}

renderPlot({ggplot(controlling[controlling$`Background characteristics`%in%input$controlling,],aes(y=value, x=`Type of violence experienced`, fill=variable)) +
  geom_col(position="dodge") + geom_text(aes(label=paste0(value,"%")), position=position_dodge(0.7), vjust=-0.5)+
  theme_bw() +scale_fill_brewer(palette = "Set1")+coord_flip()+
    facet_grid(~Gender)+
  labs( x = "", y="%", fill="")+theme(text=element_text(size=20, face="bold"))}, width=1500, height=700)



```

### **Violence by any spouse or intimate partner**

```{r}

selectInput("violence_spouse", "",
              c("Age"="Age",
                "Education attainment"="Education",
                "Marital status"="Marital status",
                "Residence"="Residence",
                "Wealth quintile"="Wealth quintile",
                "By County"="County"))
```

```{r, include=F}
#import data
violence_spouse <- fread('data/table_17/Table_17_13_violence_by_any_spouse_or_intimate_partner_in_the_last_12_months.csv')

violence_spouse$Category <- fct_relevel(violence_spouse$Category, 
                                    "Lowest", "Second", "Middle", "Fourth", "Highest")

violence_spouse_county <- fread('data/table_17/Table_17_13C_violence_by_any_spouse_or_intimate_partner_in_the_last_12_months_map.csv') 

violence_spouse_county <- full_join(county, violence_spouse_county, by = c('Name'='County')) 

```

```{r}

renderPlot({if(input$violence_spouse!="County"){ggplot(violence_spouse[violence_spouse$`Background characteristics`%in%input$violence_spouse,],aes(y=value, x=reorder(variable,value), fill=Category)) + coord_flip()+
  geom_col(position="dodge") + geom_text(aes(label=paste0(value,"%")), position=position_dodge(0.7), vjust=-0.5)+
  theme_bw() +scale_fill_brewer(palette = "Set1")+
    facet_grid(~Gender)+
  labs( x = "", y="%", fill="")+theme(text=element_text(size=20, face="bold"))}
  else{
    ggplot(violence_spouse_county ,aes(fill= abs(value), geometry=geometry)) +
  geom_sf()+
 facet_grid(Gender~variable, labeller = label_wrap_gen()) +
 theme_void()+scale_fill_gradient(low="#ffffcc", high="#bd0026", na.value = "white")+
 labs(fill="%") +
  theme(text=element_text(size=25),axis.title=element_text(size=14,face="bold"))
  }}, width=1500, height=700)



```

### **Violence by women against their spouse or intimate partner**

```{r}

selectInput("violence_women", "",
              c("Age"="Age",
                "Education attainment"="Education",
                "Employment"="Employment",
                "Marital status"="Marital status",
                "Residence"="Residence",
                "Wealth quintile"="Wealth quintile",
                "Who have experienced physical intimate-partner violence"="Respondents who have experienced physical intimate-partner violence",
                "Father beat mother"="Father beat mother",
                "Husband's education"="Husband's education",
                "Mother beat father"="Mother beat father",
                "No. of controlling behaviors displayed by spouse"="Number of controlling behaviors displayed by spouse/intimate partner",
                "No. of decisions in which he/she participates"="Number of decisions in which he/she participates",
                "No. of reasons for which wife beating is justified"="Number of reasons for which wife beating is justified",
                "Respondent afraid of spouse/intimate partner"="Respondent afraid of spouse/intimate partner",
                "Spousal age difference"="Spousal age difference",
                "Spousal education difference"="Spousal education difference",
                "By County"="County"))
```

```{r, include=F}
#import data
violence_women <- fread("data/table_17/table_17_16_Violence_by_respondent_against_their_spouse.csv") 

violence_women$Category <- fct_relevel(violence_women$Category, "No education", "Primary", "Secondary", "More than secondary",
                                   "Lowest", "Second", "Middle", "Fourth", "Highest")

T17.15C <- fread("data/table_17/table_17_15C_Violence_by_respondent_against_their_spouse_intimate_partner_by_respondents_background_characteristics.csv") 

T17.15C <- full_join(county, T17.15C, by=c('Name'='County')) 

```

```{r}

renderPlot({if(input$violence_women!=c("County", "Marital status")){ggplot(violence_women[violence_women$`Background characteristics`%in%input$violence_women,],aes(y=value, x=Category, fill=variable)) +
  geom_col(position="dodge") + geom_text(aes(label=paste0(value,"%")), position=position_dodge(0.7), vjust=-0.5)+
  theme_bw() +scale_fill_brewer(palette = "Set1")+
    facet_grid(~Gender)+
  labs( x = "", y="%", fill="")+theme(text=element_text(size=20, face="bold"))}
  else if(input$violence_women%in%"Marital status"){ggplot(sexual_violence[sexual_violence$`Background characteristics`%in%input$violence_women,],aes(y=value, x=Category, fill=variable)) +coord_flip()+
  geom_col(position="dodge") + geom_text(aes(label=paste0(value,"%")), position=position_dodge(0.7), vjust=-0.5)+
  theme_bw() +scale_fill_brewer(palette = "Set1")+coord_flip()+facet_grid(~Gender)+
  labs( x = "", y="%", fill="")+theme(text=element_text(size=20, face="bold"))}
  else{
    ggplot(T17.15C ,aes(fill= abs(value), geometry=geometry)) +
  geom_sf()+
 facet_grid(Gender~variable, labeller = label_wrap_gen()) +
 theme_void()+scale_fill_gradient(low="#ffffcc", high="#bd0026", na.value = "white")+
 labs(fill="%") +
  theme(text=element_text(size=25),axis.title=element_text(size=14,face="bold"))
  }}, width=1500, height=700)



```


### **Help seeking to stop violence**

```{r}

selectInput("violence_stop", "",
              c("Age"="Age",
                "Education attainment"="Education",
                "Marital status"="Marital status",
                "Employment"="Employment",
                "Residence"="Residence",
                "Wealth quintile"="Wealth quintile",
                "Type of violence experienced"="Type of violence experienced",
                "By County"="County"))
```

```{r, include=F}
#import data
T17.17 <- fread("data/table_17/table_17_17_Help_seeking_to_stop_violence.csv") 
T17.17$Category <- fct_relevel(T17.17$Category, "No education", "Primary", "Secondary", "More than secondary",
                                   "Lowest", "Second", "Middle", "Fourth", "Highest") 

T17.17C <- fread("data/table_17/table_17_17C_Help_seeking_to_stop_violence.csv", na = "*") 
 
T17.17C <- full_join(county, T17.17C, by = c('Name'='County')) 

```

```{r}

renderPlot({if(input$violence_stop%in%c("Age","Education","Employment","Residence","Wealth quintile","Type of violence experienced" )){ggplot(T17.17[T17.17$`Background characteristics`%in%input$violence_stop,],aes(y=value, x=Category, fill=variable)) +
  geom_col(position="dodge") + geom_text(aes(label=paste0(value,"%")), position=position_dodge(0.7), vjust=-0.5)+
  theme_bw() +scale_fill_brewer(palette = "Set1")+
    facet_grid(~Gender)+
  labs( x = "", y="%", fill="")+theme(text=element_text(size=20, face="bold"))}
  else if(input$violence_stop%in%"Marital status"){ggplot(T17.17[T17.17$`Background characteristics`%in%input$violence_stop,],aes(y=value, x=Category, fill=variable)) +
  geom_col(position="dodge") + geom_text(aes(label=paste0(value,"%")), position=position_dodge(0.7), vjust=-0.5)+
  theme_bw() +scale_fill_brewer(palette = "Set1")+coord_flip()+facet_grid(~Gender)+
  labs( x = "", y="%", fill="")+theme(text=element_text(size=20, face="bold"))}
  else{
    ggplot(T17.17C ,aes(fill= abs(value), geometry=geometry)) +
  geom_sf()+
 facet_grid(Gender~variable, labeller = label_wrap_gen()) +
 theme_void()+scale_fill_gradient(low="#ffffcc", high="#bd0026", na.value = "white")+
 labs(fill="%") +
  theme(text=element_text(size=25),axis.title=element_text(size=14,face="bold"))
  }}, width=1500, height=700)



```


### **Sources for help to stop the violence**

**Select the type of violence to visualize**

```{r}

selectInput("sources_help", "",
              c("Physical only"="Physical only",
                "Sexual only"="Sexual only",
                "Physical or sexual violence"="Physical or sexual violence",
                "Both physical and sexual"="Both physical and sexual"))
```

```{r, include=F}
#import data
sources_help <- fread("data/table_17/table_17_18_Sources_for_help_to_stop_the_violence.csv") 



```

```{r}

renderPlot({ggplot(sources_help[sources_help$variable%in%input$sources_help,],aes(y=value, x=reorder(Source,value))) +
  geom_col(position="dodge", fill="#74add1") + geom_text(aes(label=paste0(value,"%")), position=position_dodge(0.7), vjust=-0.5, hjust=-1)+
  theme_bw() +scale_fill_brewer(palette = "Set1")+
    facet_grid(~Gender)+coord_flip()+
  labs( x = "", y="%", fill="")+theme(text=element_text(size=20, face="bold"))}, width=1500, height=700)



```

# Female genital mutilation {data-navmenu="Key Indicators"}


## Row {data-width="200"}

<br>

###  {.value-box}

```{r}

valueBox(
  value = paste("13%"),
  caption = "of women have ever experienced sexual violence",
  color = "black"
)
```

###  {.value-box}

```{r}
valueBox(
  value = paste("6.5%"),
  caption = "of women have often experienced sexual violence in the last 12 months",
  color = "#b15928"
)
```

## Column {.tabset .tabset-fade data-height="900"}

### **Knowledge of female circumcision**


```{r}

selectInput("knowledge_circumcision", "",
              c("Age"="Age",
                "Education"="Education",
                "Ethnic group"="Ethnic group",
                "Religion"="Religion",
                "Residence"="Residence",
                "Wealth quintile"="Wealth quintile",
                "By County"="County"))
```

```{r, include=F}
#import data
knowledge_circumcision <- fread('data/table_18/Table_18_1_Knowledge_of_female_circumcision.csv')

knowledge_circumcision$Category <- fct_relevel(knowledge_circumcision$Category, "No education", "Primary", "Secondary", "More than secondary",
                                   "Lowest", "Second", "Middle", "Fourth", "Highest") 

knowledge_circumcision_county <- fread('data/table_18/Table_18_1C_Knowledge_of_female_circumcision_map.csv') 




knowledge_circumcision_county <- full_join(county,knowledge_circumcision_county,  by =c('Name'='County'))


```

```{r}

renderPlot({if(input$knowledge_circumcision!="County"){ggplot(knowledge_circumcision[knowledge_circumcision$`Background characteristics`%in%input$knowledge_circumcision,],aes(y=value, x=Category)) +
  geom_col(position="dodge", fill="cyan3") + geom_text(aes(label=paste0(value,"%")), position=position_dodge(0.7), vjust=-0.5)+
  theme_bw() +scale_fill_brewer(palette = "Set1")+ coord_flip()+
    facet_grid(~Gender)+
  labs( x = "", y="%", fill="")+theme(text=element_text(size=20, face="bold"))}
  else{
    ggplot(knowledge_circumcision_county ,aes(fill= abs(value), geometry=geometry)) +
  geom_sf()+
 facet_grid(variable~Gender, labeller = label_wrap_gen()) +
 theme_void()+scale_fill_gradient(low="#ffffcc", high="#bd0026", na.value = "white")+
 labs(fill="%") +
  theme(text=element_text(size=25),axis.title=element_text(size=14,face="bold"))
  }}, width=1500, height=700)



```

### **Prevalence of female circumcision**

```{r}

selectInput("prevalence_circumcision", "",
              c("Age"="Age",
                "Residence"="Residence",
                "Wealth quintile"="Wealth quintile",
                "By County"="County"))
```

```{r, include=F}
#import data
prevalence_circumcision <- fread('data/table_18/Table_18_2_Prevalence_of_female_circumcision.csv')

prevalence_circumcision$Category <- fct_relevel(prevalence_circumcision$Category, "No education", "Primary", "Secondary", "More than secondary",
                                   "Lowest", "Second", "Middle", "Fourth", "Highest") 

prevalence_circumcission_county <- fread('data/table_18/Table_18_2C_Prevalence_of_female_circumcision_map.csv') 


prevalence_circumcission_county <- full_join(county,prevalence_circumcission_county,  by =c('Name'='County'))


```

```{r}

renderPlot({if(input$prevalence_circumcision!="County"){ggplot(prevalence_circumcision[prevalence_circumcision$`Background characteristics`%in%input$prevalence_circumcision,],aes(y=value, x=Category)) +
  geom_col(position="dodge", fill="cyan3") + geom_text(aes(label=paste0(value,"%")), position=position_dodge(0.7), vjust=-0.5)+
  theme_bw() +scale_fill_brewer(palette = "Set1")+
  labs( x = "", y="%", fill="")+theme(text=element_text(size=20, face="bold"))}
  else{
    ggplot(prevalence_circumcission_county ,aes(fill= abs(value), geometry=geometry)) +
  geom_sf()+
 facet_grid(~variable, labeller = label_wrap_gen()) +
 theme_void()+scale_fill_gradient(low="#ffffcc", high="#bd0026", na.value = "white")+
 labs(fill="%") +
  theme(text=element_text(size=25),axis.title=element_text(size=14,face="bold"))
  }}, width=1500, height=700)



```

### **Age at circumcision**

```{r}

selectInput("age_at_circumcision", "",
              c("Age"="Age",
                "Residence"="Residence",
                "Wealth quintile"="Wealth quintile",
                "By County"="County"))
```

```{r, include=F}
#import data
age_at_circumcision <- fread('data/table_18/table 18.3 Age at circumcision_longformat.csv')

age_at_circumcision$Category <- fct_relevel(age_at_circumcision$Category, "No education", "Primary", "Secondary", "More than secondary",
                                   "Lowest", "Second", "Middle", "Fourth", "Highest") 

age_at_circumcission_county <- fread('data/table_18/Table 18.3C Age at circumcision by county.csv') 


age_at_circumcission_county <- full_join(county,age_at_circumcission_county,  by =c('Name'='County'))


```

```{r}

renderPlot({if(input$age_at_circumcision!="County"){ggplot(age_at_circumcision[age_at_circumcision$`Background characteristics`%in%input$age_at_circumcision,],aes(y=value, x=Category, fill=variable)) +
  geom_col(position="dodge") + geom_text(aes(label=paste0(value,"%")), position=position_dodge(0.7), vjust=-0.5)+
  theme_bw() +scale_fill_brewer(palette = "Set1")+
  labs( x = "", y="%", fill="")+theme(text=element_text(size=20, face="bold"))}
  else{
    ggplot(age_at_circumcission_county ,aes(fill= abs(value), geometry=geometry)) +
  geom_sf()+
 facet_grid(~variable, labeller = label_wrap_gen()) +
 theme_void()+scale_fill_gradient(low="#ffffcc", high="#bd0026", na.value = "white")+
 labs(fill="%") +
  theme(text=element_text(size=25),axis.title=element_text(size=14,face="bold"))
  }}, width=1500, height=700)



```


### **Aspects of circumcision among women and girls**

**Choose the characteristics of circumcision below to be able to visualize**
```{r}

selectInput("aspects_of_circumcision", "",
              c("Person who performed the circumcision"="Person who performed the circumcision",
                "Type of circumcision"="Type of circumcision"))
```

```{r, include=F}
#import data
aspects_of_circumcision <- fread('data/table_18/table 18.7 _Aspects_of_circumcission.csv')


```

```{r}

renderPlot({ggplot(aspects_of_circumcision[aspects_of_circumcision$Characteristic%in%input$aspects_of_circumcision,],aes(y=value, x=reorder(variable,value), fill=Category)) +coord_flip()+
  geom_col(position="dodge") + geom_text(aes(label=paste0(value,"%")), position=position_dodge(0.7), vjust=-0.5)+
  theme_bw() +scale_fill_brewer(palette = "Set1")+
  labs( x = "", y="%", fill="")+theme(text=element_text(size=20, face="bold"))}, width=1500, height=700)



```

### **Circumcision by age**


```{r, include=F}
#import data
circumcision_age <- fread("data/table_18/working_table_18_2_circumcision_by_age.csv")

```

```{r}

renderPlot({ggplot(circumcision_age[!is.na(circumcision_age$Age),],aes(y=value, x=Age, fill=variable)) +
  geom_col(position="dodge") + geom_text(aes(label=paste0(value,"%")), position=position_dodge(0.7), vjust=-0.5)+
  theme_bw() +scale_fill_brewer(palette = "Set1")+
  labs( x = "", y="%", fill="")+theme(text=element_text(size=20, face="bold"))}, width=1500, height=700)


```

### **Effects of female circumcision**


```{r}

selectInput("effect_female_circumcision", "",
              c("Age at circumcision"="Age at circumcision",
                "Current Age"="Current Age",
                "Type of circumcision"="Type of circumcision"))
```

```{r, include=F}

effect_female_circumcision <- fread('data/table_18/table_18.10_Effect_of_female_circumcision_longformart.csv')

```

```{r}

renderPlot({ggplot(effect_female_circumcision[effect_female_circumcision$Characteristic%in%input$effect_female_circumcision,],aes(y=value, x=reorder(variable,value), fill=Category)) +coord_flip()+
  geom_col(position="dodge") + geom_text(aes(label=paste0(value,"%")), position=position_dodge(0.7), vjust=-0.5)+
  theme_bw() +scale_fill_brewer(palette = "Set1")+
  labs( x = "", y="%", fill="")+theme(text=element_text(size=20, face="bold"))}, width=1500, height=700)



```

### **Help seeking behavior among circumcised women**


```{r}

selectInput("help_seeking_women", "",
              c("Age"="Age",
                "Education attainment"="Education",
                "Residence"="Residence",
                "Wealth quintile"="Wealth Quintile"))
```

```{r, include=F}
#import data
help_seeking_women <- fread('data/table_18/table_18.11_Help_seeking_behaviors_among_circumcised_women_longformart.csv')

help_seeking_women$Category <- fct_relevel(help_seeking_women$Category, 
                                    "Lowest", "Second", "Middle", "Fourth", "Highest")
```

```{r}

renderPlot({ggplot(help_seeking_women[help_seeking_women$`Background characteristic`%in%input$help_seeking_women,],aes(y=value, x=Category, fill=variable)) +
  geom_col(position="dodge") + geom_text(aes(label=paste0(value,"%")), position=position_dodge(0.7), vjust=-0.5)+
  theme_bw() +scale_fill_brewer(palette = "Set1")+
  labs( x = "", y="%", fill="")+theme(text=element_text(size=20, face="bold"))}, width=1500, height=700)



```

# Compare trends over time

Row {data-height=700}
-------------------------------------

### Percentage change of trends per county (comparing 2022 to 2014)

```{r}

selectInput("category1", "",
             c("Nutrition"="Nutrition",
               "Malaria"="Malaria",
               "Child vaccination"="Child vaccination"))

comparison_data <-fread("data/County Comparison Data/comparison_data_wide.csv")


# vacc_comparison <- read_csv("data/County Comparison Data/vaccination_22_14_combined_county.csv")%>%
#   pivot_longer(cols = c(BCG:FULL_VACCINATION), names_to = "Vaccination", values_to = "Proportion") %>%
#   rename(County=Name, Category=Vaccination)%>%
#   arrange(year) %>%
#   group_by(County, Category)%>%
#   mutate(Proportion1=round((Proportion-lag(Proportion))/Proportion*100,1))%>%
#   ungroup() %>%
#   mutate(type="Vaccination") %>%
#   pivot_longer(c(Proportion, Proportion1), names_to="P", values_to="Proportion") %>%
#   filter(!is.na(Proportion)) %>%
#   mutate(P=recode(P, "Proportion1"="Percentage change")) %>%
#    mutate(Prop=ifelse(P%in%"Proportion",paste0("Proportion", " (", year,")"), P)) %>%
#   select(-P)

comparison_data1 <- fread("data/County Comparison Data/comparison_data.csv")

comparison_data2 <- full_join(county, comparison_data1, by=c("Name"="County"))

# trends over time
trends_data <- fread("data/trends_per_county.csv")

comparison_data1a<- fread("data/County Comparison Data/comparison_data_wide1a.csv") %>%
  mutate(indicator=recode( Category, "Households with >=1 ITN"="Malaria", "Households with >=1 ITN\nper 2 people"="Malaria", "Stunting"="Nutrition", "Underweight"="Nutrition", "Wasting"="Nutrition", "BCG"="Child vaccination", "DPT1"="Child vaccination", "DPT2"="Child vaccination", "DPT3"="Child vaccination", "FULL_VACCINATION"="Child vaccination", "OPV"="Child vaccination", "OPV1"="Child vaccination", "OPV2"="Child vaccination", "OPV3"="Child vaccination"))

renderPlot({
  ggplot(comparison_data1a[comparison_data1a$indicator%in%input$category1,], aes(y=County, x=Category, fill=Proportion))+
  geom_tile()+theme_bw()+
  scale_fill_gradient2()+
    labs(x="Indicator", y="County", fill="% change")+
    theme(text=element_text(size=14, face="bold"))
}, width=900, height=600)



```


### Trends over time

```{r}

selectInput("trends", "",
             c("Fertility by residence"= "fertility",
             "Need for, and demand for family planning"="family_planning",
             "Delivery assistance"="delivery",
             "Childhood vaccinations"="vaccinations",
             "Children nutritional status"="nutrition",
             "Exclusive breastfeeding"="breastfeeding",
             "Incidence of Childhood mortality (per 1000)"="mortality",
             "Household possession of insecticide treated nets"="treated_nets"))

renderGirafe({
  trends_data1 <-trends_data %>%filter(indicator%in%input$trends) %>%
    mutate(Years=as.numeric(as.character(Years)))

  trends_map<- ggplot(trends_data1, aes(x=Years, y=Percent, color=grouping)) + 
  geom_line( size= 2.5 ) + geom_point(size = 5) +
  theme_bw() + 
  geom_point_interactive(size = 2.0, aes(tooltip=Percent)) +
    scale_x_continuous(breaks=unique(trends_data1$Years),label=unique(trends_data1$Years)) + 
  labs(x="Kenya DHS Years", y="",color="") +
  theme(text =element_text(size=18, face="bold"))
  trends_map2<-girafe(ggobj =  trends_map, width_svg=18, height_svg=9,
                   options = list(
                     opts_hover(css = "fill:#666666;cursor:pointer;"),
                     opts_selection(css = "fill:orange;", type = "multiple"),
                    # opts_sizing(rescale = TRUE),
                     opts_zoom(max = 9)),)
  print( trends_map2, justify="left")
  
})


```


Row {data-height=700}
-------------------------------------

### Please select an indicator

```{r}
selectInput("ind_comp", "",
             c("Stunting"= "Stunting",
             "Wasting"="Wasting",
             "Underweight"="Underweight",
             "Households with >=1 insecticide treated net"="Households with >=1 ITN",
             "Households with >=1 insecticide treated net \nper 2 people"="Households with >=1 ITN\nper 2 people"))
```

```{r}

renderGirafe({
  comp_data1 <-comparison_data2 %>%filter(Category%in%input$ind_comp) 

  comp_data_map<- ggplot(comp_data1, aes(fill=Proportion)) + 
    geom_sf_interactive(aes(tooltip=paste0(Name, " ",Proportion,"%")))+
    facet_grid(~Prop)+
  theme_void() +
  theme(text =element_text(size=18, face="bold"))+
    scale_fill_gradient2()
  comp_map2<-girafe(ggobj =  comp_data_map, width_svg=18, height_svg=9,
                   options = list(
                     opts_hover(css = "fill:#666666;cursor:pointer;"),
                     opts_selection(css = "fill:orange;", type = "multiple"),
                    # opts_sizing(rescale = TRUE),
                     opts_zoom(max = 9)),)
  print( comp_map2, justify="right")
  
})
```

### .

```{r}
renderPlot({
  comp_data1a <-comparison_data1 %>%filter(Category%in%input$ind_comp)%>%filter(Prop%in%c("Proportion (2022)", "Proportion (2014)")) 

  ggplot(comp_data1a, aes(x=reorder(County, Proportion), y=Proportion, fill=factor(year))) + 
  geom_col() +coord_flip()+ facet_grid(~year)+
  theme_bw() + 
    scale_fill_brewer(palette = "Set1")+
  geom_col_interactive(size = 2.0, aes(tooltip=Proportion)) +
    geom_text(aes(label=paste0(Prop, "%")), vjust=1)+ 
  labs(x="Counties", y="",fill="") +
  theme(text =element_text(size=18, face="bold"))
  # comp_data1a_map2<-girafe(ggobj =  comp_data1a_map, width_svg=18, height_svg=9,
  #                  options = list(
  #                    opts_hover(css = "fill:#666666;cursor:pointer;"),
  #                    opts_selection(css = "fill:orange;", type = "multiple"),
  #                   # opts_sizing(rescale = TRUE),
  #                    opts_zoom(max = 9)),)
  # print( comp_data1a_map2, justify="left")
  
}, width = 900, height=700)
```

# Compare indicators by county

```{r}

### datasets

combined_data <-fread("data/combined_data_county.csv")

```

## Row {data-width="500"}

#### Choose indicators to compare: Indicator 1

```{r}
selectInput("comp_indicator1", "",
              c("Child immunization: Fully Vaccinated (12-23 months)"="CountyFullyVaccinated12",
                "Child immunization: Fully Vaccinated (24-35 months)"="CountyFullyVaccinated24",
                "Current contraceptive use: Any method"="Contraceptive_use_any_method",
                "Current contraceptive use: Modern method"="Contraceptive_use_modern_method",
                "Family planning method: Emergency contraception"="Emergency_contraception",
                "Family planning method: Female condom"="Female_condom",
                "Family planning method: Standard Days Method"="SDM",
                "Family planning method: Female sterilization"  ="Female_sterilization",
                "Family planning method: Implants"="Implants", 
                "Family planning method: Injectables"="Injectables",
                "Family planning method: IUD"="IUD",
                "Family planning method: Pill"="Pill",
                "Family planning method: LAM"="LAM",
                "Family planning method: Other"="Other",
                "Family planning method: Male condom"="Male_condom",
                "Family planning method: Male sterilization"="Male_sterilization",
                "HIV prevention knowledge (men)"="men_hivprevention_knowledge",
                "HIV prevention (men): Limit sex to one partner"="men_limit_sex",
                "HIV prevention (men): Using condoms"="men_using_condoms",
                "HIV prevention knowledge (women)"="women_hivprevention_knowledge",
                "HIV prevention (women): Limit sex to one partner"="women_limit_sex",
                 "HIV prevention (women): Using condoms"="women_using_condoms",
                "HIV testing (Men): Has ever tested"="men_ever_tested",
                "HIV testing (Men): Has never tested"="men_never_tested",
                "HIV testing (Men): Tested but not received results"="men_not_recieve_results",
                "HIV testing (Men): Tested & received results"="men_recieved_results",
                "HIV testing (Men): Tested in last 12 months & received results"="men_received_results_last_test",
                "HIV testing (women): Has ever tested"="women_ever_tested",
                "HIV testing (Men): Has never tested"="women_never_tested",
                "HIV testing (Men): Tested but not received results"="women_not_recieve_results",
                "HIV testing (Men): Tested & received results"="women_recieved_results",
                "HIV testing (Men): Tested in last 12 months & received results"="women_received_results_last_test",
                "Insecticide treated nets: average no. in households"="avrg_itn_hh",
                "Insecticide treated nets: at least 1 in a household"="perc_atleast_1itn",
                "Maternal care: ANC from a skilled provider"="ANC from a skilled provider",
                "Maternal care: At least four ANC visits"="At least four ANC visits",
                "Maternal care: Skilled delivery"="Skilled delivery",
                "Maternal care: Health facility delivery"="Health facility delivery",
                "Maternal care: Protection against neonatal tetanus"="Neonatal tetanus",
                "Maternal care: Postnatal check during first 2 days after birth"="Postnatal check",
                "Maternal care: Took iron-containing supplements during pregnancy"="Took iron supplements",
                "Nutrition: Moderate stunting"="HFA_perc_below2sd",
                "Nutrition: Severe stunting"="HFA_perc_below3sd",
                "Nutrition: Moderate wasting"="WFA_perc_below2sd",
                "Nutrition: Severe wasting"="WFA_perc_below3sd",
                "Nutrition: Moderate underweight"="WFH_perc_below2sd",
                "Nutrition: Severe underweight"="WFH_perc_below3sd",
                "Physical violence (Women): Often"="Often",
                "Physical violence (Women): Sometimes"="Sometimes",
                "Physical violence (Women): Ever experienced violence (from age 15)"="Percentage who have experienced physical violence since age 15",
                "Teenager: currently pregnant"="Currently_pregnant",
                "Teenager: ever been pregnant"="Ever_pregnant",
                "Teenager: ever had pregnancy loss"="Pregnancy_loss",
                "Teenage pregnancy: Live births"="Live_birth"
                ), width = 300)
```

<br>

<br>

##### Choose indicator 2

```{r}

selectInput("comp_indicator2", "",
              c("Child immunization: Fully Vaccinated (12-23 months)"="CountyFullyVaccinated12",
                "Child immunization: Fully Vaccinated (24-35 months)"="CountyFullyVaccinated24",
                "Current contraceptive use: Any method"="Contraceptive_use_any_method",
                "Current contraceptive use: Modern method"="Contraceptive_use_modern_method",
                "Family planning method: Emergency contraception"="Emergency_contraception",
                "Family planning method: Female condom"="Female_condom",
                "Family planning method: Standard Days Method"="SDM",
                "Family planning method: Female sterilization"  ="Female_sterilization",
                "Family planning method: Implants"="Implants", 
                "Family planning method: Injectables"="Injectables",
                "Family planning method: IUD"="IUD",
                "Family planning method: Pill"="Pill",
                "Family planning method: LAM"="LAM",
                "Family planning method: Other"="Other",
                "Family planning method: Male condom"="Male_condom",
                "Family planning method: Male sterilization"="Male_sterilization",
                "HIV prevention knowledge (men)"="men_hivprevention_knowledge",
                "HIV prevention (men): Limit sex to one partner"="men_limit_sex",
                "HIV prevention (men): Using condoms"="men_using_condoms",
                "HIV prevention knowledge (women)"="women_hivprevention_knowledge",
                "HIV prevention (women): Limit sex to one partner"="women_limit_sex",
                 "HIV prevention (women): Using condoms"="women_using_condoms",
                "HIV testing (Men): Has ever tested"="men_ever_tested",
                "HIV testing (Men): Has never tested"="men_never_tested",
                "HIV testing (Men): Tested but not received results"="men_not_recieve_results",
                "HIV testing (Men): Tested & received results"="men_recieved_results",
                "HIV testing (Men): Tested in last 12 months & received results"="men_received_results_last_test",
                "HIV testing (women): Has ever tested"="women_ever_tested",
                "HIV testing (Men): Has never tested"="women_never_tested",
                "HIV testing (Men): Tested but not received results"="women_not_recieve_results",
                "HIV testing (Men): Tested & received results"="women_recieved_results",
                "HIV testing (Men): Tested in last 12 months & received results"="women_received_results_last_test",
                "Insecticide treated nets: average no. in households"="avrg_itn_hh",
                "Insecticide treated nets: at least 1 in a household"="perc_atleast_1itn",
                "Maternal care: ANC from a skilled provider"="ANC from a skilled provider",
                "Maternal care: At least four ANC visits"="At least four ANC visits",
                "Maternal care: Skilled delivery"="Skilled delivery",
                "Maternal care: Health facility delivery"="Health facility delivery",
                "Maternal care: Protection against neonatal tetanus"="Neonatal tetanus",
                "Maternal care: Postnatal check during first 2 days after birth"="Postnatal check",
                "Maternal care: Took iron-containing supplements during pregnancy"="Took iron supplements",
                "Nutrition: Moderate stunting"="HFA_perc_below2sd",
                "Nutrition: Severe stunting"="HFA_perc_below3sd",
                "Nutrition: Moderate wasting"="WFA_perc_below2sd",
                "Nutrition: Severe wasting"="WFA_perc_below3sd",
                "Nutrition: Moderate underweight"="WFH_perc_below2sd",
                "Nutrition: Severe underweight"="WFH_perc_below3sd",
                "Physical violence (Women): Often"="Often",
                "Physical violence (Women): Sometimes"="Sometimes",
                "Physical violence (Women): Ever experienced violence (from age 15)"="Percentage who have experienced physical violence since age 15",
                "Teenager: currently pregnant"="Currently_pregnant",
                "Teenager: ever been pregnant"="Ever_pregnant",
                "Teenager: ever had pregnancy loss"="Pregnancy_loss",
                "Teenage pregnancy: Live births"="Live_birth"
                ), width = 300)
```

<br>

<br>

### Comparison by indicators

\*\* Kindly hover on the graphic to see the name of the county\*\*

```{r, fig.width=12,fig.height=6}


renderGirafe({
  combined_data1<- left_join(combined_data[combined_data$indicator1%in%input$comp_indicator1,]%>%select(-indicator), combined_data[combined_data$indicator1%in%input$comp_indicator2, ]%>%rename(indicator2=indicator1, values2=values)%>%select(-indicator))
  combined_map<- ggplot(combined_data1, aes(x=values, y=values2))+
  geom_point_interactive(size=4, aes(tooltip=County), color="cyan4")+
  theme_bw()+
  labs(y="Indicator2",x="Indicator1", fill="")+
  #scale_fill_manual(values = c("#f46d43","#fee090","#4575b4"))+
  theme(text=element_text(size=18), legend.position = "none")
  
   combined_map2<-girafe(ggobj =  combined_map,
                   options = list(
                     opts_hover(css = "fill:#666666;cursor:pointer;"),
                     opts_selection(css = "fill:orange;", type = "multiple"),
                     opts_zoom(max = 4)), width=20, height=8)
  print( combined_map2)
})

#paste0(input$comp)
#paste0(input$comp1)
```

```{r, include=F}

county <- st_read("shapefiles/County.shp")

```

## Row {data.width="500"}

### Indicator 1

```{r,fig.width=6,fig.height=6}
#
renderGirafe({
combined_data1<- left_join(county, combined_data[combined_data$indicator1%in%input$comp_indicator1,]%>%select(-indicator), by=c("Name"="County"))
  indicator_map1<- ggplot(combined_data1, aes(fill=values))+
  geom_sf_interactive(aes(tooltip=paste0(Name,": ",round(values))))+
  theme_void()+scale_fill_gradient(low = "#fee6ce", high = "#7f2704")+
  labs(y="", x="", fill="")#+
  #scale_fill_manual(values = c("#f46d43","#fee090","#4575b4"))+
  #theme(text=element_text(size=18), legend.position = "none")
  
   indicator_map1x<-girafe(ggobj =  indicator_map1,
                   options = list(
                     opts_hover(css = "fill:#666666;cursor:pointer;"),
                     opts_selection(css = "fill:orange;", type = "multiple"),
                     opts_zoom(max = 4)))
  plot2<-ggplot(combined_data1, aes(y=values, x=reorder(Name, values)))+coord_flip()+
  geom_point_interactive(size=2, color="cyan4", aes(tooltip=round(values)))+
  theme_bw()+
  labs(y="", x="")+
  #scale_fill_manual(values = c("#f46d43","#fee090","#4575b4"))+
  theme(text=element_text(size=8), legend.position = "none")
  indicator_map1y<-girafe(ggobj =  plot2)
  

girafe(ggobj = cowplot::plot_grid(plotlist=list(indicator_map1, plot2),rel_widths=1.2, rel_heights=0.5,  nrow=1))
})

```

### Indicator 2

```{r,fig.width=6,fig.height=6}
#
renderGirafe({
combined_data1<- left_join(county, combined_data[combined_data$indicator1%in%input$comp_indicator2,]%>%select(-indicator), by=c("Name"="County"))
  indicator_map2<- ggplot(combined_data1, aes(fill=values))+
  geom_sf_interactive(aes(tooltip=paste0(Name,": ",round(values))))+
  theme_void()+scale_fill_gradient(low = "#fee6ce", high = "#7f2704")+
  labs(y="", x="", fill="")#+
  #scale_fill_manual(values = c("#f46d43","#fee090","#4575b4"))+
  #theme(text=element_text(size=18), legend.position = "none")
  
   indicator_map2x<-girafe(ggobj =  indicator_map2,
                   options = list(
                     opts_hover(css = "fill:#666666;cursor:pointer;"),
                     opts_selection(css = "fill:orange;", type = "multiple"),
                     opts_zoom(max = 4)))
  plot2a<-ggplot(combined_data1, aes(y=values, x=reorder(Name, values)))+coord_flip()+
  geom_point_interactive(size=2, color="cyan4", aes(tooltip=round(values)))+
  theme_bw()+
  labs(y="", x="")+
  #scale_fill_manual(values = c("#f46d43","#fee090","#4575b4"))+
  theme(text=element_text(size=8), legend.position = "none")
  indicator_map2y<-girafe(ggobj =  plot2a)
  

girafe(ggobj = plot_grid(plotlist=list(indicator_map2, plot2a),rel_widths=1.2, rel_heights=0.5, nrow=1))
})

```
